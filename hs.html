<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>M·∫≠t M√£ Th√°m T·ª≠ - H·ªçc Sinh</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
      background-color: #34495e;
      color: white;
      min-height: 100vh;
      text-align: center;
    }
    h1 { color: #f1c40f; margin-bottom: 10px; }
    #team-info {
      font-size: 2.2em;
      font-weight: bold;
      margin-bottom: 30px;
      background-color: #2c3e50;
      padding: 10px 25px;
      border-radius: 10px;
    }
    /* S·ª≠a ƒë·ªïi #answer-input ƒë·ªÉ d√πng cho c·∫£ game v√† r∆∞∆°ng b√°u */
    #answer-input, #chest-input { 
      padding: 15px;
      font-size: 1.8em;
      width: 80%;
      max-width: 300px;
      margin-bottom: 20px;
      text-align: center;
      border: 3px solid #f1c40f;
      border-radius: 8px;
      color: #333;
    }
    #chest-input { 
      border: 3px solid #e67e22;
    }
    button {
      font-size: 1.4em;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 15px 30px;
      margin: 8px;
      cursor: pointer;
      color: white;
      transition: background-color 0.2s;
    }
    #submit-button { background-color: #2ecc71; }
    #submit-button:hover:not(:disabled) { background-color: #27ae60; }
    #submit-button:disabled { background-color: #95a5a6; cursor: not-allowed; }
    #skip-button { background-color: #e67e22; }
    #skip-button:hover { background-color: #d35400; }
    #chest-submit-button { background-color: #e67e22; }
    #chest-submit-button:hover:not(:disabled) { background-color: #d35400; }
    #chest-submit-button:disabled { background-color: #95a5a6; cursor: not-allowed; }
    
    #status-message { margin-top: 20px; font-style: italic; font-size: 1.2em; }

    /* Th√™m style cho giao di·ªán r∆∞∆°ng b√°u */
    #game-area { display: flex; flex-direction: column; align-items: center; width: 100%; }
    #chest-area { display: none; flex-direction: column; align-items: center; width: 100%; }
    #chest-area h1 { color: #e67e22; }
    #chest-area p { font-size: 1.5em; margin-bottom: 20px; }
    #prize-result { font-size: 2em; font-weight: bold; margin-top: 30px; }

  </style>
</head>
<body>
  <div id="game-area">
    <h1>NH·∫¨P ƒê√ÅP √ÅN</h1>
    <div id="team-info">ƒêANG K·∫æT N·ªêI...</div>

    <input type="text" id="answer-input" placeholder="Nh·∫≠p ƒë√°p √°n..." maxlength="50">
    <button id="submit-button" disabled>G·ª¨I ƒê√ÅP √ÅN</button>
    <button id="skip-button" disabled>‚ùå B·ªé QUA (-10ƒë)</button>

    <div id="status-message">Vui l√≤ng qu√©t m√£ QR c·ªßa ƒë·ªôi.</div>
  </div>

  <div id="chest-area">
    <h1>üîë M·ªû R∆Ø∆†NG B√ÅU üîë</h1>
    <p>Nh·∫≠p m√£ s·ªë b√≠ ·∫©n (4 ch·ªØ s·ªë):</p>
    <input type="number" id="chest-input" placeholder="M√£ s·ªë (4 ch·ªØ s·ªë)" maxlength="4" disabled>
    <button id="chest-submit-button" disabled>M·ªû R∆Ø∆†NG!</button>
    <div id="chest-status-message" style="margin-top: 20px; font-style: italic; font-size: 1.2em;"></div>
    <div id="prize-result"></div>
  </div>

  <script type="module">
    // C·∫ßn th√™m where ƒë·ªÉ l·∫Øng nghe submissions ri√™ng c·ªßa ƒë·ªôi n√†y
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, doc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // === C·∫§U H√åNH FIREBASE (gi·ªØ nguy√™n nh∆∞ file GV) ===
    const firebaseConfig = {
      apiKey: "AIzaSyDfcMrblRonAS9Q7BSfD9ZZYeOmSy4UjfQ",
      authDomain: "nutnhap.firebaseapp.com",
      projectId: "nutnhap",
      storageBucket: "nutnhap.firebasestorage.app",
      messagingSenderId: "359344838873",
      appId: "1:359344838873:web:d1746d32920881091c86c8",
      measurementId: "G-0VTTNLWDD9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // C·∫§U H√åNH GAME
    const PRIZE_POOL = [
        "+2 ƒëi·ªÉm v√†o 1 b√†i 15 ph√∫t.",
        "+1 ƒëi·ªÉm v√†o 1 b√†i 15 ph√∫t.",
        "1 tr√†ng ph√°o tay l·ªõn t·ª´ c·∫£ l·ªõp!",
        "1 l·ªùi khen ng·ª£i ƒë·∫∑c bi·ªát t·ª´ gi√°o vi√™n.",
        "Mi·ªÖn 1 c√¢u h·ªèi b√†i t·∫≠p v·ªÅ nh√†.",
        "1 l·∫ßn ƒë·ªïi ƒë·ªôi trong ho·∫°t ƒë·ªông s·∫Øp t·ªõi (n·∫øu c√≥)."
    ];

    let teamId = null;
    let currentQuestionIndex = 0; // B·∫Øt ƒë·∫ßu t·ª´ 0
    let gameStatus = 'waiting'; // 'waiting', 'playing', 'won', 'finished'
    let secretCode = null;
    let isInputLocked = false; // Kh√≥a input khi c√≥ ƒë√°p √°n ƒëang ch·ªù duy·ªát

    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      teamId = params.get('teamId');
      if (teamId) {
        document.getElementById('team-info').textContent = `ƒê·ªòI: ${teamId.toUpperCase()}`;
        document.getElementById('submit-button').onclick = submitAnswer;
        document.getElementById('skip-button').onclick = skipQuestion;
        document.getElementById('chest-submit-button').onclick = submitChestCode;
        listenToTeamStatus(); // B·∫Øt ƒë·∫ßu l·∫Øng nghe tr·∫°ng th√°i c·ªßa ƒë·ªôi
        document.getElementById('status-message').textContent = 'ƒê√£ k·∫øt n·ªëi. Ch·ªù GV b·∫Øt ƒë·∫ßu tr√≤ ch∆°i.';
      } else {
        document.getElementById('status-message').textContent = 'Kh√¥ng t√¨m th·∫•y m√£ ƒë·ªôi. Vui l√≤ng qu√©t l·∫°i QR.';
      }
    });

    // === H√ÄM L·∫ÆNG NGHE TR·∫†NG TH√ÅI C·ª¶A ƒê·ªòI T·ª™ FIRESTORE ===
    function listenToTeamStatus() {
        if (!teamId) return;

        const teamDocRef = doc(db, "teams", teamId);
        const submissionsCollectionRef = collection(db, "submissions");

        // 1. L·∫Øng nghe tr·∫°ng th√°i ƒë·ªôi
        onSnapshot(teamDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const teamData = docSnap.data();
                gameStatus = teamData.gameStatus || 'waiting'; 
                currentQuestionIndex = teamData.currentQuestionIndex || 0;
                secretCode = teamData.secretCode || null;

                updateUIBasedOnStatus();
            } else {
                document.getElementById('status-message').textContent = 'ƒê·ªôi ch∆∞a ƒë∆∞·ª£c GV kh·ªüi t·∫°o.';
            }
        });

        // 2. L·∫Øng nghe submissions c·ªßa ƒë·ªôi n√†y ƒë·ªÉ kh√≥a input khi ƒëang ch·ªù duy·ªát
        const q = query(submissionsCollectionRef, where("teamId", "==", teamId));
        onSnapshot(q, (snapshot) => {
            // N·∫øu c√≥ b·∫•t k·ª≥ submission n√†o c·ªßa ƒë·ªôi n√†y, kh√≥a input
            isInputLocked = !snapshot.empty; 
            updateUIBasedOnStatus();
        });
    }

    // H√ÄM C·∫¨P NH·∫¨T GIAO DI·ªÜN D·ª∞A TR√äN TR·∫†NG TH√ÅI GAME V√Ä ƒê·ªòI
    function updateUIBasedOnStatus() {
        const input = document.getElementById('answer-input');
        const submitBtn = document.getElementById('submit-button');
        const skipBtn = document.getElementById('skip-button');
        const statusDiv = document.getElementById('status-message');
        const gameArea = document.getElementById('game-area');
        const chestArea = document.getElementById('chest-area');

        input.disabled = true;
        submitBtn.disabled = true;
        skipBtn.disabled = true;

        if (gameStatus === 'playing') {
            gameArea.style.display = 'flex';
            chestArea.style.display = 'none';

            if (currentQuestionIndex >= 7) {
                statusDiv.textContent = 'HO√ÄN TH√ÄNH! Ch·ªù GV trao m√£ r∆∞∆°ng b√°u.';
            } else if (isInputLocked) {
                statusDiv.textContent = `ƒê√£ g·ª≠i ƒë√°p √°n cho C√¢u ${currentQuestionIndex + 1}. Ch·ªù GV duy·ªát...`;
                statusDiv.style.color = '#f1c40f';
            } else {
                input.disabled = false;
                submitBtn.disabled = false;
                skipBtn.disabled = false;
                statusDiv.textContent = `S·∫µn s√†ng tr·∫£ l·ªùi C√¢u ${currentQuestionIndex + 1}.`;
                statusDiv.style.color = '#2ecc71';
            }
        } else if (gameStatus === 'won') {
            gameArea.style.display = 'none';
            chestArea.style.display = 'flex';
            
            document.getElementById('chest-input').disabled = false;
            document.getElementById('chest-submit-button').disabled = false;
            document.getElementById('chest-status-message').textContent = 'Ch√∫c m·ª´ng! Nh·∫≠p m√£ s·ªë b√≠ m·∫≠t ƒë·ªÉ m·ªü r∆∞∆°ng.';

        } else if (gameStatus === 'finished') {
            gameArea.style.display = 'flex';
            chestArea.style.display = 'none';
            statusDiv.textContent = 'TR√í CH∆†I ƒê√É K·∫æT TH√öC!';
            statusDiv.style.color = '#e74c3c';
        } else { // 'waiting'
            gameArea.style.display = 'flex';
            chestArea.style.display = 'none';
            statusDiv.textContent = 'ƒê√£ k·∫øt n·ªëi. Ch·ªù GV b·∫Øt ƒë·∫ßu tr√≤ ch∆°i.';
            statusDiv.style.color = 'white';
        }
    }


    // === H√ÄM X·ª¨ L√ù G·ª¨I ƒê√ÅP √ÅN (ƒê√É CH·ªàNH S·ª¨A) ===
    async function submitAnswer() {
        const input = document.getElementById('answer-input');
        const status = document.getElementById('status-message');
        const answer = input.value.trim();
        
        if (!answer) {
            status.textContent = "Vui l√≤ng nh·∫≠p ƒë√°p √°n!";
            status.style.color = "#e74c3c";
            return;
        }
        if (isInputLocked) {
            status.textContent = "ƒêang ch·ªù ƒë√°p √°n tr∆∞·ªõc ƒë∆∞·ª£c duy·ªát!";
            status.style.color = "#e67e22";
            return;
        }
        
        // T·∫°m kh√≥a input (listener s·∫Ω m·ªü l·∫°i)
        isInputLocked = true; 
        updateUIBasedOnStatus();

        try {
            await addDoc(collection(db, "submissions"), {
                teamId,
                answer,
                questionIndex: currentQuestionIndex,
                timestamp: serverTimestamp(),
                status: "pending"
            });
            
            status.textContent = `ƒê√£ g·ª≠i ƒë√°p √°n '${answer}'. Ch·ªù GV duy·ªát.`;
            status.style.color = "#f1c40f";
            input.value = "";
        } catch {
            status.textContent = "G·ª≠i th·∫•t b·∫°i. Ki·ªÉm tra m·∫°ng.";
            status.style.color = "#e74c3c";
            isInputLocked = false; 
            updateUIBasedOnStatus();
        }
    }

    // === H√ÄM X·ª¨ L√ù B·ªé QUA C√ÇU (ƒê√É CH·ªàNH S·ª¨A) ===
    async function skipQuestion() {
        const status = document.getElementById('status-message');
        
        if (isInputLocked) {
            status.textContent = "ƒêang ch·ªù ƒë√°p √°n tr∆∞·ªõc ƒë∆∞·ª£c duy·ªát!";
            status.style.color = "#e67e22";
            return;
        }
        
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën B·ªé QUA c√¢u n√†y? ƒê·ªôi s·∫Ω b·ªã tr·ª´ 10 ƒëi·ªÉm.")) {
            return;
        }

        // T·∫°m kh√≥a input
        isInputLocked = true; 
        updateUIBasedOnStatus();

        try {
            await addDoc(collection(db, "submissions"), {
                teamId,
                questionIndex: currentQuestionIndex,
                action: "skip",
                timestamp: serverTimestamp(),
                status: "pending"
            });

            status.textContent = "ƒê√£ g·ª≠i y√™u c·∫ßu B·ªé QUA. Ch·ªù GV duy·ªát...";
            status.style.color = "#e67e22";

        } catch {
            status.textContent = "Kh√¥ng g·ª≠i ƒë∆∞·ª£c y√™u c·∫ßu b·ªè qua.";
            status.style.color = "#e74c3c";
            isInputLocked = false; 
            updateUIBasedOnStatus();
        }
    }

    // === H√ÄM X·ª¨ L√ù M·ªû R∆Ø∆†NG B√ÅU (M·ªöI) ===
    function submitChestCode() {
        const inputCode = document.getElementById('chest-input').value.trim();
        const prizeResult = document.getElementById('prize-result');
        const statusMessage = document.getElementById('chest-status-message');
        
        if (inputCode === secretCode) {
            const prizeIndex = Math.floor(Math.random() * PRIZE_POOL.length);
            const prize = PRIZE_POOL[prizeIndex];
            
            prizeResult.innerHTML = `
                <div style="font-size: 0.8em; color: #f1c40f;">PH·∫¶N QU√Ä B√ç M·∫¨T L√Ä:</div>
                <div style="font-size: 1.5em; color: #2ecc71; margin-top: 10px;">"${prize}"</div>
            `;
            statusMessage.textContent = 'üéâ CH√öC M·ª™NG! M√É ƒê√öNG! üéâ';
            statusMessage.style.color = '#2ecc71';

        } else {
            prizeResult.textContent = 'M√É S·ªê KH√îNG CH√çNH X√ÅC. Vui l√≤ng h·ªèi l·∫°i GV.';
            prizeResult.style.color = '#e74c3c';
            statusMessage.textContent = 'M√£ b·ªã sai!';
            statusMessage.style.color = '#e74c3c';
        }
    }
  </script>
</body>
</html>
