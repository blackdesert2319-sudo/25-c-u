<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc Sinh - Tr·∫£ l·ªùi</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #2c3e50;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
            box-sizing: border-box;
        }
        #team-info {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            padding: 10px 20px;
            border-radius: 8px;
            color: #2c3e50;
        }
        #current-question-display {
            font-size: 1.2em;
            margin-bottom: 15px;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: #34495e;
            width: 100%;
            max-width: 400px;
        }
        #score-display {
            font-size: 2em;
            font-weight: bold;
            color: #f1c40f;
            margin-bottom: 20px;
        }
        #answer-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 350px;
        }
        #answerInput {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 3px solid #3498db;
            border-radius: 8px;
            font-size: 1.2em;
            text-align: center;
            background: #ecf0f1;
            color: #2c3e50;
        }
        .action-button {
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 10px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #submitBtn {
            background-color: #2ecc71;
            color: white;
        }
        #submitBtn:hover:not(:disabled) {
            background-color: #27ae60;
        }
        #skipBtn {
            background-color: #e67e22;
            color: white;
        }
        #skipBtn:hover:not(:disabled) {
            background-color: #d35400;
        }
        .action-button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
        }
        #submission-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            color: white;
            background-color: #2ecc71; /* M·∫∑c ƒë·ªãnh: S·∫µn s√†ng */
            width: 100%;
            max-width: 350px;
        }
        /* Color classes */
        .red { background-color: #e74c3c; }
        .blue { background-color: #3498db; }
        .green { background-color: #2ecc71; }
        .yellow { background-color: #f1c40f; color: #2c3e50; }
        .purple { background-color: #9b59b6; }
    </style>

    <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' }
    };
    </script>
    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body>

    <div id="team-info">ƒêang t·∫£i...</div>
    <div id="score-display">0 ƒëi·ªÉm</div>
    <div id="current-question-display">ƒêang ch·ªù tr√≤ ch∆°i b·∫Øt ƒë·∫ßu...</div>

    <div id="answer-area">
        <input type="text" id="answerInput" placeholder="Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n" disabled>
        <button id="submitBtn" class="action-button" onclick="submitAnswer('answer')" disabled>G·ª¨I ƒê√ÅP √ÅN</button>
        <button id="skipBtn" class="action-button" onclick="submitAnswer('skip')" disabled>B·ªé QUA (-10 ƒëi·ªÉm)</button>
        <div id="submission-status">ƒêang t·∫£i...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // === C·∫§U H√åNH FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyDfcMrblRonAS9Q7BSfD9ZZYeOmSy4UjfQ",
            authDomain: "nutnhap.firebaseapp.com",
            projectId: "nutnhap",
            storageBucket: "nutnhap.firebasestorage.app",
            messagingSenderId: "359344838873",
            appId: "1:359344838873:web:d1746d32920881091c86c8",
            measurementId: "G-0VTTNLWDD9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const TEAM_STATUS_COLLECTION = "team_status";

        let teamId;
        let currentQuestionOrder = [];
        let isGameStarted = false;
        // Bi·∫øn tr·∫°ng th√°i ƒë·ªÉ ki·ªÉm so√°t vi·ªác nh·∫≠p ƒë√°p √°n
        let isWaitingForReview = false; 

        // H√†m ti·ªán √≠ch: L·∫•y tham s·ªë t·ª´ URL
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // --- H√ÄM M·ªöI: C·∫¨P NH·∫¨T GIAO DI·ªÜN INPUT ---
        function updateInputUI(waiting) {
            const inputField = document.getElementById('answerInput');
            const submitBtn = document.getElementById('submitBtn');
            const skipBtn = document.getElementById('skipBtn');
            const statusDiv = document.getElementById('submission-status');

            if (!isGameStarted) {
                inputField.disabled = true;
                submitBtn.disabled = true;
                skipBtn.disabled = true;
                statusDiv.textContent = "ƒêANG CH·ªú GV B·∫§M START...";
                statusDiv.style.backgroundColor = '#7f8c8d'; // M√†u x√°m
                return;
            }

            if (waiting) {
                inputField.disabled = true;
                submitBtn.disabled = true;
                skipBtn.disabled = true;
                statusDiv.textContent = "ƒêANG CH·ªú GV DUY·ªÜT...";
                statusDiv.style.backgroundColor = '#e67e22'; // M√†u cam
            } else {
                inputField.disabled = false;
                submitBtn.disabled = false;
                skipBtn.disabled = false;
                statusDiv.textContent = "NH·∫¨P ƒê√ÅP √ÅN üëá";
                statusDiv.style.backgroundColor = '#2ecc71'; // M√†u xanh l√°
            }
        }
        // --------------------------------------------------

        // H√†m l·∫Øng nghe tr·∫°ng th√°i submissions c·ªßa ƒë·ªôi hi·ªán t·∫°i
        function listenForTeamSubmissions(teamId) {
            const submissionsRef = collection(db, "submissions");
            const q = query(submissionsRef, 
                where("teamId", "==", teamId),
                where("status", "==", "pending")
            );

            onSnapshot(q, (snapshot) => {
                if (snapshot.size > 0) {
                    // C√≥ √≠t nh·∫•t m·ªôt y√™u c·∫ßu ƒëang ch·ªù duy·ªát
                    isWaitingForReview = true;
                    console.log("Tr·∫°ng th√°i: ƒêang ch·ªù duy·ªát. Kh√¥ng th·ªÉ g·ª≠i th√™m.");
                    updateInputUI(true); // C·∫≠p nh·∫≠t giao di·ªán ƒë·ªÉ ch·∫∑n nh·∫≠p
                } else {
                    // Kh√¥ng c√≥ y√™u c·∫ßu n√†o ƒëang ch·ªù
                    isWaitingForReview = false;
                    console.log("Tr·∫°ng th√°i: S·∫µn s√†ng nh·∫≠p ƒë√°p √°n.");
                    updateInputUI(false); // C·∫≠p nh·∫≠t giao di·ªán ƒë·ªÉ cho ph√©p nh·∫≠p
                }
            });
        }


        // H√†m l·∫Øng nghe tr·∫°ng th√°i ƒë·ªôi
        function listenForTeamStatus(teamId) {
            const docRef = doc(db, TEAM_STATUS_COLLECTION, teamId);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentQuestionOrder = data.questionOrder || [];
                    
                    const teamInfoDiv = document.getElementById('team-info');
                    const scoreDisplay = document.getElementById('score-display');
                    const qDisplay = document.getElementById('current-question-display');
                    
                    // C·∫≠p nh·∫≠t th√¥ng tin ƒë·ªôi
                    teamInfoDiv.textContent = data.name || `ƒê·ªôi ${teamId.toUpperCase()}`;
                    teamInfoDiv.className = teamId; // Set m√†u n·ªÅn cho team-info
                    
                    // C·∫≠p nh·∫≠t ƒëi·ªÉm
                    scoreDisplay.textContent = `${data.score || 0} ƒëi·ªÉm`;

                    // C·∫≠p nh·∫≠t c√¢u h·ªèi
                    const currentQIndex = data.currentQ || 1;
                    if (currentQIndex > currentQuestionOrder.length) {
                        qDisplay.innerHTML = "HO√ÄN TH√ÄNH T·∫§T C·∫¢ C√ÇU H·ªéI! ƒêang ch·ªù k·∫øt th√∫c game...";
                        isGameStarted = false; 
                    } else if (currentQuestionOrder.length > 0) {
                        qDisplay.innerHTML = `C√¢u hi·ªán t·∫°i: **C${currentQIndex}**`;
                        isGameStarted = true; 
                    } else {
                        qDisplay.textContent = "ƒêang ch·ªù tr√≤ ch∆°i b·∫Øt ƒë·∫ßu...";
                        isGameStarted = false; 
                    }
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i input d·ª±a tr√™n game b·∫Øt ƒë·∫ßu v√† tr·∫°ng th√°i ch·ªù duy·ªát
                    if (isGameStarted) {
                        updateInputUI(isWaitingForReview); 
                    } else {
                        updateInputUI(false); // G·ªçi ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i "ƒêang ch·ªù GV b·∫•m START..."
                    }

                    MathJax.typeset(); 

                } else {
                    console.log("D·ªØ li·ªáu ƒë·ªôi kh√¥ng t·ªìn t·∫°i.");
                    isGameStarted = false;
                    updateInputUI(false); 
                }
            }, (error) => {
                console.error("L·ªói khi l·∫Øng nghe tr·∫°ng th√°i ƒë·ªôi: ", error);
            });
        }

        window.submitAnswer = async function(action) {
            
            // D√íNG QUAN TR·ªåNG: CH·∫∂N G·ª¨I N·∫æU ƒêANG CH·ªú DUY·ªÜT
            if (isWaitingForReview) {
                alert("ƒê·ªôi c·ªßa b·∫°n ƒëang c√≥ y√™u c·∫ßu ch·ªù gi√°o vi√™n duy·ªát. Vui l√≤ng ƒë·ª£i!");
                return;
            }

            const inputField = document.getElementById('answerInput');
            const answer = inputField.value.trim();
            const currentQElement = document.getElementById('current-question-display');
            const qIndexMatch = currentQElement.textContent.match(/C(\d+)/); 
            const questionIndex = qIndexMatch ? parseInt(qIndexMatch[1]) : null;

            if (!teamId || !questionIndex) {
                alert("Tr√≤ ch∆°i ch∆∞a b·∫Øt ƒë·∫ßu ho·∫∑c kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·ªôi/c√¢u h·ªèi.");
                return;
            }

            if (action === 'answer' && answer === "") {
                alert("Vui l√≤ng nh·∫≠p ƒë√°p √°n ho·∫∑c ch·ªçn B·ªè qua.");
                return;
            }

            if (questionIndex > currentQuestionOrder.length || currentQuestionOrder.length === 0) {
                alert("ƒê√£ ho√†n th√†nh t·∫•t c·∫£ c√°c c√¢u h·ªèi!");
                return;
            }

            // L·∫•y index th·ª±c t·∫ø c·ªßa c√¢u h·ªèi (0-based) t·ª´ m·∫£ng ƒë√£ x√°o tr·ªôn
            const actualQIndex = currentQuestionOrder[questionIndex - 1]; 
            // T·∫°o m√£ ƒë·ªãnh danh c√¢u h·ªèi th·ª±c t·∫ø (v√≠ d·ª•: Q1.2)
            const actualQuestionCode = `Q${teamId === 'red' ? 1 : teamId === 'blue' ? 2 : teamId === 'green' ? 3 : teamId === 'yellow' ? 4 : 5}.${actualQIndex + 1}`;
            
            try {
                // ƒê√°nh d·∫•u ƒë·ªôi ƒëang ch·ªù duy·ªát tr∆∞·ªõc khi g·ª≠i
                isWaitingForReview = true; 
                updateInputUI(true);

                const payload = {
                    teamId: teamId,
                    questionIndex: questionIndex, // Th·ª© t·ª± c√¢u h·ªèi trong game (1-7)
                    actualQuestionIndex: actualQuestionCode, // M√£ c√¢u h·ªèi th·ª±c t·∫ø (Qx.y)
                    answer: action === 'answer' ? answer : "B·ªé QUA",
                    action: action, // 'answer' ho·∫∑c 'skip'
                    status: 'pending', 
                    timestamp: new Date().toISOString()
                };

                await addDoc(collection(db, "submissions"), payload);
                
                if (action === 'answer') {
                    inputField.value = ""; // X√≥a ƒë√°p √°n sau khi g·ª≠i
                }
                
                console.log("ƒê√°p √°n ƒë√£ ƒë∆∞·ª£c g·ª≠i v√† ƒëang ch·ªù duy·ªát.");

            } catch (e) {
                console.error("L·ªói khi g·ª≠i ƒë√°p √°n/b·ªè qua: ", e);
                alert("L·ªói k·∫øt n·ªëi ho·∫∑c Firebase. Vui l√≤ng th·ª≠ l·∫°i.");
                // N·∫øu g·ª≠i l·ªói, kh√¥i ph·ª•c tr·∫°ng th√°i cho ph√©p g·ª≠i
                isWaitingForReview = false; 
                updateInputUI(false);
            }
        }

        window.onload = function() {
            teamId = getQueryParam('teamId');
            
            const infoDiv = document.getElementById('team-info');
            const inputField = document.getElementById('answerInput');
            const submitBtn = document.getElementById('submitBtn');
            const skipBtn = document.getElementById('skipBtn');

            if (teamId && ['red', 'blue', 'green', 'yellow', 'purple'].includes(teamId)) {
                infoDiv.textContent = `ƒê·ªôi c·ªßa b·∫°n: ƒê·ªôi ${teamId.charAt(0).toUpperCase() + teamId.slice(1)}`;
                infoDiv.className = teamId; 
                
                // B·∫Øt ƒë·∫ßu l·∫Øng nghe tr·∫°ng th√°i ƒë·ªôi
                listenForTeamStatus(teamId);
                
                // D√íNG QUAN TR·ªåNG: B·∫Øt ƒë·∫ßu l·∫Øng nghe submissions c·ªßa ƒë·ªôi
                listenForTeamSubmissions(teamId); 

            } else {
                infoDiv.textContent = "L·ªñI: Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·ªôi. Vui l√≤ng qu√©t m√£ QR l·∫°i.";
                infoDiv.style.backgroundColor = '#e74c3c';
                inputField.style.display = 'none';
                submitBtn.style.display = 'none';
                skipBtn.style.display = 'none';
                document.getElementById('submission-status').style.display = 'none';
            }
        };

    </script>
</body>
</html>
