<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mật Mã Thám Tử V5: Giao Diện Nén 5 Hàng</title>
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            /* Đảm bảo nội dung vừa vặn trên màn hình cao 100vh */
            min-height: 100vh; 
            background-color: #282c34; 
            padding: 10px 10px 20px 10px; /* Giảm padding trên dưới */
            color: #fff; 
            /* Thêm scroll cho body nếu 5 đội vẫn quá cao */
            overflow-y: auto;
        }

        h1 { color: #f1c40f; margin-bottom: 5px; font-size: 1.8em;}

        /* KHUNG CHUNG CỦA CÁC ĐỘI */
        #game-wrapper {
            width: 98%; 
            max-width: 1400px; /* Tăng chiều rộng tối đa */
            margin-top: 10px;
        }

        /* KHUNG CHUNG HIỂN THỊ MẬT MÃ KHO BÁU CUỐI CÙNG */
        #code-display {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 2.5em; /* Giảm kích thước chữ để tiết kiệm không gian */
            font-weight: bold;
            color: #f1c40f;
            border: 3px solid #f1c40f;
            padding: 5px 10px;
            border-radius: 8px;
            background-color: #34495e;
            width: 100%;
        }

        /* KHUNG HÀNG CỦA MỘT ĐỘI (Giảm độ cao) */
        .team-row {
            display: flex;
            align-items: stretch; /* Đảm bảo các cột có chiều cao bằng nhau */
            margin-bottom: 10px; /* Giảm khoảng cách giữa các hàng */
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            border: 2px solid transparent;
            min-height: 100px; /* Chiều cao tối thiểu của một hàng */
        }
        .team-row:hover {
            transform: none;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
        }

        /* CSS MÀU CHO 5 ĐỘI */
        .team-red { background-color: #e74c3c; border-color: #c0392b; }
        .team-blue { background-color: #3498db; border-color: #2980b9; }
        .team-green { background-color: #2ecc71; border-color: #27ae60; }
        .team-yellow { background-color: #f1c40f; color: #333; border-color: #f39c12; }
        .team-purple { background-color: #9b59b6; border-color: #8e44ad; }
        /* Điều chỉnh màu chữ và nút cho đội Vàng */
        .team-yellow .team-score-value, .team-yellow .q-text, .team-yellow .manh-moi-status { color: #333; }
        .team-yellow button { color: white; background-color: #e67e22; border: none; }
        .team-yellow button:hover { background-color: #d35400; }
        .team-yellow .input-group input { border: 2px solid #e67e22; }

        /* CỘT 1: ĐIỂM VÀ ĐIỀU KHIỂN */
        .team-score-control {
            width: 130px; 
            text-align: center;
            padding: 10px 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
        }
        .team-yellow .team-score-control { border-right: 1px solid rgba(0, 0, 0, 0.3); }

        .team-score-value { 
            font-size: 2.5em; /* Kích thước lớn */
            font-weight: 900; 
            margin-bottom: 5px;
        }
        .score-control button {
            background: rgba(0, 0, 0, 0.2); 
            border: none; 
            color: white; 
            padding: 3px 6px; /* Giảm padding nút */
            margin: 0 2px;
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.8em; 
            font-weight: 900; 
        }
        .team-yellow .score-control button { background: rgba(0, 0, 0, 0.1); color: #333;}
        .team-yellow .score-control button:hover { background: rgba(0, 0, 0, 0.2); }

        /* CỘT 2: TRẠNG THÁI VÀ INPUT */
        .team-input-status-area {
            width: 380px;
            padding: 10px 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
        }
        .team-yellow .team-input-status-area { border-right: 1px solid rgba(0, 0, 0, 0.3); }

        .team-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px; /* Giảm khoảng cách */
        }
        .manh-moi-status {
            width: 18px; /* Giảm kích thước */
            height: 18px;
            line-height: 18px;
            font-size: 0.7em;
        }
        .manh-moi-completed { background-color: #2ecc71; }
        .manh-moi-active { background-color: #f1c40f; color: #333; }
        .team-yellow .manh-moi-completed { background-color: #27ae60; }
        .team-yellow .manh-moi-active { background-color: #e67e22; }

        .input-group {
            display: flex;
            align-items: center;
            flex-wrap: wrap; /* Cho phép xuống dòng nếu cần */
        }
        .input-group input {
            padding: 8px;
            width: 120px; /* Giảm chiều rộng input */
            font-size: 1em;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .input-group button {
            padding: 8px 10px;
            font-size: 1em;
            font-weight: bold;
            flex-grow: 1;
            min-width: 100px;
        }
        .result-message { 
            margin-top: 5px; /* Giảm khoảng cách */
            font-size: 0.9em; 
        }
        .correct-answer { color: #2ecc71; }
        .incorrect-answer { color: #e74c3c; }
        .team-yellow .correct-answer { color: #27ae60; }
        .team-yellow .incorrect-answer { color: #c0392b; }

        /* CỘT 3: CÂU HỎI (Phần còn lại) */
        .team-question-area {
            flex-grow: 1;
            padding: 10px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .q-number {
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .q-text {
            font-size: 1.4em; /* TĂNG KÍCH CỠ CHỮ CÂU HỎI */
            font-weight: 700;
            line-height: 1.3;
        }

        /* Trạng thái đã hoàn thành */
        .team-row.finished .team-question-area {
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 0 8px 8px 0;
        }
        .team-row.finished .q-text {
             font-size: 1.2em;
             font-weight: 600;
             color: #2ecc71;
        }


        /* KHUNG KẾT THÚC */
        #final-message {
            /* Giữ nguyên */
        }
        #final-code {
            /* Giữ nguyên */
        }
    </style>
</head>
<body>

    <div id="start-area">
        <h1>MẬT MÃ THÁM TỬ: 5 ĐỘI TRANH TÀI</h1>
        <button id="startButton">BẮT ĐẦU PHI VỤ!</button>
    </div>

    <div id="game-wrapper" style="display: none;">
        <h2 style="color: #3498db; text-align: center; margin-bottom: 5px; font-size: 1.2em;">MẬT MÃ KHO BÁU CHUNG</h2>
        <div id="code-display">
            ??? - ??? - ??? - ??? - ??? - ??? - ???
        </div>
        
        <div id="team-rows-container">
            </div>
    </div>

    <div id="final-message">
        <div id="final-message-content">
            <p style="font-size: 1.5em; font-weight: bold;">CHÚC MỪNG ĐỘI CHIẾN THẮNG!</p>
            <p id="winning-team-name" style="font-size: 3em; color: #fff176;"></p>
            <p style="font-size: 1.5em; margin-top: 20px;">MẬT MÃ KHO BÁU LÀ:</p>
            <div id="final-code" style="font-size: 1.5em; color: #fff176; margin-top: 15px; border: 2px solid #fff176; padding: 10px 20px; border-radius: 8px;"></div>
        </div>
    </div>
    
    <script>
        // CẤU HÌNH ĐIỂM VÀ MẬT MÃ
        const SECRET_CODE = ['7', '0', '3', '6', '9', '2', '5'];
        const POINTS_PER_MANH_MOI = 10;
        const BONUS_POINTS = 30;

        // CÂU HỎI (7 câu - Cấp số cộng/nhân)
        const QUESTIONS = [
            // Manh Mối 1: Cấp số cộng (Đáp án 7)
            { q: 'Cho CSC có $u_1=1$ và công sai $d=2$. Tìm $u_4$.', correct: '7', manhMoiIndex: 0 }, 
            // Manh Mối 2: Cấp số cộng (Đáp án 0)
            { q: 'Cho CSC có $u_1=10$ và $d=-5$. Hỏi $u_3$ có giá trị bằng?', correct: '0', manhMoiIndex: 1 }, 
            // Manh Mối 3: Cấp số nhân (Đáp án 3)
            { q: 'Cho CSN có $u_1=1$ và công bội $q=3$. Tìm $u_2$.', correct: '3', manhMoiIndex: 2 }, 
            // Manh Mối 4: Cấp số nhân (Đáp án 6)
            { q: 'Tìm $x$ để 3 số $1, x, 36$ lập thành CSN dương. $x=$?', correct: '6', manhMoiIndex: 3 }, 
            // Manh Mối 5: Cấp số cộng (Đáp án 9)
            { q: 'Tìm tổng $S_3$ của CSC có $u_1=2$ và $u_3=4$.', correct: '9', manhMoiIndex: 4 }, // u2=3 => S3 = 2+3+4=9
            // Manh Mối 6: Cấp số nhân (Đáp án 2)
            { q: 'Cho CSN có $u_2=10$ và $u_3=20$. Tìm công bội $q$.', correct: '2', manhMoiIndex: 5 }, 
            // Manh Mối 7: Cấp số cộng (Đáp án 5)
            { q: 'Cho CSC có $u_5=10$ và $d=1$. Tìm $u_1$.', correct: '6', manhMoiIndex: 6 } // u1 = 10 - 4*1 = 6. (Lưu ý: Đáp án trước là 5, em sửa lại thành 6 theo tính toán $u_1 = 10 - 4 \cdot 1 = 6$) -> **Thầy cần kiểm tra đáp án này!**
        ];
        
        // **QUAN TRỌNG:** Sửa đáp án câu 7 trong code trên là **'5'** thành **'6'** cho đúng với $u_1 = u_5 - 4d = 10 - 4(1) = 6$.
        QUESTIONS[6].correct = '6';

        // Dữ liệu 5 ĐỘI CHƠI
        const teams = [
            { id: 'red', name: 'Đội Đỏ', colorClass: 'team-red', score: 0, currentManhMoiIndex: 0, manhMoiCompletedState: new Array(QUESTIONS.length).fill(false) },
            { id: 'blue', name: 'Đội Xanh', colorClass: 'team-blue', score: 0, currentManhMoiIndex: 0, manhMoiCompletedState: new Array(QUESTIONS.length).fill(false) },
            { id: 'green', name: 'Đội Lá', colorClass: 'team-green', score: 0, currentManhMoiIndex: 0, manhMoiCompletedState: new Array(QUESTIONS.length).fill(false) },
            { id: 'yellow', name: 'Đội Vàng', colorClass: 'team-yellow', score: 0, currentManhMoiIndex: 0, manhMoiCompletedState: new Array(QUESTIONS.length).fill(false) },
            { id: 'purple', name: 'Đội Tím', colorClass: 'team-purple', score: 0, currentManhMoiIndex: 0, manhMoiCompletedState: new Array(QUESTIONS.length).fill(false) }, 
        ];
        
        // DOM Elements
        const startButton = document.getElementById('startButton');
        const gameWrapper = document.getElementById('game-wrapper');
        const startArea = document.getElementById('start-area');
        const codeDisplay = document.getElementById('code-display');
        const teamRowsContainer = document.getElementById('team-rows-container');
        const finalMessage = document.getElementById('final-message');
        const finalCodeDisplay = document.getElementById('final-code');
        const winningTeamName = document.getElementById('winning-team-name');
        
        // ---------------------------------------------------
        // CHỨC NĂNG BẢNG ĐIỂM
        // ---------------------------------------------------
        
        function updateTeamScore(teamId, delta) {
            const team = teams.find(t => t.id === teamId);
            if (team) {
                team.score += delta;
                const scoreElement = document.getElementById(`score-${teamId}`);
                if (scoreElement) {
                    scoreElement.textContent = team.score;
                    // Hiệu ứng nhấp nháy
                    scoreElement.style.transition = 'none';
                    scoreElement.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        scoreElement.style.transition = 'transform 0.2s';
                        scoreElement.style.transform = 'scale(1.0)';
                    }, 50);
                }
            }
        }
        window.updateTeamScore = updateTeamScore; 

        // ---------------------------------------------------
        // CHỨC NĂNG TRÒ CHƠI
        // ---------------------------------------------------
        
        function renderTeamRows() {
            teamRowsContainer.innerHTML = ''; 
            
            teams.forEach(team => {
                const qIndex = team.currentManhMoiIndex;
                const questionData = QUESTIONS[qIndex];
                const isGameFinished = qIndex === QUESTIONS.length;
                
                const row = document.createElement('div');
                row.className = `team-row ${team.colorClass}`;
                row.id = `team-row-${team.id}`;
                
                let questionHTML = '';
                let inputHTML = '';
                
                if (isGameFinished) {
                    row.classList.add('finished');
                    questionHTML = `<div class="q-text">🎉 **HOÀN THÀNH 7/7 MANH MỐI!** Đội ${team.name} đang chờ kết quả chung cuộc.</div>`;
                    inputHTML = `<div class="result-message correct-answer">Tổng điểm: ${team.score}</div>`;
                } else {
                    row.classList.remove('finished');
                    questionHTML = `
                        <div class="q-number">Manh Mối ${qIndex + 1}</div>
                        <div class="q-text" id="q-text-${team.id}">${questionData.q}</div>
                    `;
                    inputHTML = `
                        <div class="input-group">
                            <input type="number" id="answer-input-${team.id}" placeholder="Đáp án (1 chữ số)" min="0" max="9" step="1" maxlength="1" oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);">
                            <button onclick="checkTeamAnswer('${team.id}')">KIỂM TRA</button>
                        </div>
                        <div class="result-message" id="result-message-${team.id}"></div>
                    `;
                }

                // Cấu trúc HTML cho một hàng đội (3 cột)
                row.innerHTML = `
                    <div class="team-score-control">
                        <div class="team-score-value" id="score-${team.id}">${team.score}</div>
                        <div class="score-control">
                            <button onclick="updateTeamScore('${team.id}', 10)">+10</button>
                            <button onclick="updateTeamScore('${team.id}', -5)">-5</button>
                        </div>
                    </div>
                    <div class="team-input-status-area">
                        <div class="team-status-bar" id="status-bar-${team.id}">
                            </div>
                        ${!isGameFinished ? inputHTML : `<div style="padding-top: 10px;">${inputHTML}</div>`}
                    </div>
                    <div class="team-question-area">
                        ${questionHTML}
                    </div>
                `;
                
                teamRowsContainer.appendChild(row);
                renderStatusBar(team);
                
                // Xử lý MathJax cho câu hỏi (nếu có)
                if (!isGameFinished && window.MathJax) {
                    MathJax.typesetPromise([document.getElementById(`q-text-${team.id}`)]);
                }
            });
        }
        
        function renderStatusBar(team) {
            const statusBar = document.getElementById(`status-bar-${team.id}`);
            if (!statusBar) return;
            statusBar.innerHTML = '';
            
            team.manhMoiCompletedState.forEach((isCompleted, index) => {
                const status = document.createElement('div');
                status.className = 'manh-moi-status';
                status.textContent = index + 1;
                
                if (isCompleted) {
                    status.classList.add('manh-moi-completed');
                } else if (index === team.currentManhMoiIndex) {
                    status.classList.add('manh-moi-active');
                }
                
                statusBar.appendChild(status);
            });
        }
        
        // HÀM KIỂM TRA ĐÁP ÁN CHO TỪNG ĐỘI
        window.checkTeamAnswer = function(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (!team || team.currentManhMoiIndex >= QUESTIONS.length) return;
            
            const qIndex = team.currentManhMoiIndex;
            const questionData = QUESTIONS[qIndex];
            const resultMessage = document.getElementById(`result-message-${teamId}`);
            const answerInput = document.getElementById(`answer-input-${teamId}`);
            
            const userAnswer = answerInput.value.trim();
            const correctAnswer = questionData.correct.trim(); 
            
            if (userAnswer.length !== 1 || isNaN(parseInt(userAnswer))) {
                resultMessage.innerHTML = 'Đáp án phải là **một chữ số** (0-9).';
                resultMessage.className = 'result-message incorrect-answer';
                answerInput.value = ''; 
                return;
            }

            if (userAnswer === correctAnswer) {
                // TRẢ LỜI ĐÚNG
                team.manhMoiCompletedState[qIndex] = true;
                team.currentManhMoiIndex++; 
                
                // Cập nhật điểm
                team.score += POINTS_PER_MANH_MOI;
                
                let msg = `<span class="correct-answer">CHÍNH XÁC!</span> Manh Mối ${qIndex + 1} đã được mở khóa.`;

                if (team.currentManhMoiIndex === QUESTIONS.length) {
                     // HOÀN THÀNH 7/7
                     team.score += BONUS_POINTS;
                     msg += `<br>🎉 **THƯỞNG LỚN!** Hoàn thành 7/7 Manh Mối.`;
                     endGame(team);
                }
                
                resultMessage.innerHTML = msg;
                resultMessage.className = 'result-message correct-answer';
                answerInput.value = ''; // Xóa đáp án sau khi đúng
                
                // Cập nhật giao diện toàn bộ game
                updateTeamScore(teamId, 0); // Chỉ để trigger cập nhật score trên giao diện
                renderTeamRows(); 

            } else {
                // TRẢ LỜI SAI: Cho phép nhập lại (Không giới hạn lượt)
                answerInput.value = ''; 
                resultMessage.innerHTML = `<span class="incorrect-answer">CHƯA CHÍNH XÁC!</span> Thử lại.`;
                resultMessage.className = 'result-message incorrect-answer';
            }
        }
        
        // HÀM KẾT THÚC TRÒ CHƠI
        function endGame(winningTeam) {
            const finalCodeString = SECRET_CODE.join('-');
            finalCodeDisplay.textContent = finalCodeString;
            winningTeamName.textContent = winningTeam.name;
            winningTeamName.style.color = window.getComputedStyle(document.getElementById(`team-row-${winningTeam.id}`)).borderColor || '#fff176'; // Lấy màu từ border của team row

            // Hiện thông báo kết thúc
            finalMessage.style.display = 'flex';
        }

        // HÀM BẮT ĐẦU GAME
        startButton.addEventListener('click', () => {
            startArea.style.display = 'none';
            gameWrapper.style.display = 'block';
            
            // Reset trạng thái
            teams.forEach(team => {
                team.score = 0;
                team.currentManhMoiIndex = 0;
                team.manhMoiCompletedState.fill(false);
            });
            
            renderTeamRows();
        });
    </script>

</body>
</html>
