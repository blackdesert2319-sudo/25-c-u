<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M·∫≠t M√£ Th√°m T·ª≠ V22: D·ªØ li·ªáu ƒë·ªìng nh·∫•t</title>
    
    <script>
        window.MathJax = {
            tex: { 
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$']]
            },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            min-height: 100vh; 
            background-color: #282c34; 
            padding: 10px 10px 20px 10px;
            color: #fff; 
            overflow-y: auto;
        }

        h1 { color: #f1c40f; margin-bottom: 5px; font-size: 1.8em;}

        /* ƒê·ªíNG H·ªí ƒê·∫æM NG∆Ø·ª¢C */
        #timer {
            position: fixed;
            top: 10px;
            right: 10px;
            font-size: 2.5em;
            font-weight: bold;
            color: #e74c3c; 
            background-color: #f1c40f;
            padding: 5px 15px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            z-index: 1000;
            display: none; 
        }
        
        /* KHU V·ª∞C START BAN ƒê·∫¶U */
        #start-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 80vh; 
        }
        #transitionButton { /* Start button 1: Chuy·ªÉn m√†n h√¨nh */
            padding: 15px 40px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            background-color: #2ecc71; 
            color: white;
            border: none;
            border-radius: 10px;
            transition: background-color 0.2s;
            margin-top: 20px;
        }
        #transitionButton:hover {
            background-color: #27ae60;
        }


        /* KHUNG CHUNG C·ª¶A C√ÅC ƒê·ªòI */
        #game-wrapper {
            width: 98%; 
            max-width: 1400px; 
            margin-top: 10px;
            /* ·∫®n ban ƒë·∫ßu, ch·ªâ hi·ªán khi Start 1 */
            display: none; 
        }
        
        /* KHU V·ª∞C ƒêI·ªÄU KHI·ªÇN CHUNG */
        #control-area {
            text-align: center;
            margin-bottom: 15px;
        }

        /* Start Button 2: B·∫Øt ƒë·∫ßu ƒë·∫øm gi·ªù */
        #startGameButton { 
            padding: 15px 40px; 
            font-size: 1.5em; 
            background-color: #3498db; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer;
            margin-bottom: 20px;
        }

        #conclusionButton {
            padding: 10px 20px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            background-color: #e67e22; 
            color: white;
            border: none;
            border-radius: 8px;
            transition: background-color 0.2s;
            display: block; 
            margin: 0 auto 15px auto;
        }
        #conclusionButton:hover {
            background-color: #d35400;
        }

        /* KHUNG H√ÄNG C·ª¶A M·ªòT ƒê·ªòI */
        .team-row {
            display: flex;
            align-items: stretch;
            margin-bottom: 10px;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            border: 2px solid transparent;
            min-height: 100px; 
        }

        /* CSS M√ÄU CHO 5 ƒê·ªòI (Gi·ªØ nguy√™n) */
        .team-red { background-color: #e74c3c; border-color: #c0392b; }
        .team-blue { background-color: #3498db; border-color: #2980b9; }
        .team-green { background-color: #2ecc71; border-color: #27ae60; }
        .team-yellow { background-color: #f1c40f; color: #333; border-color: #f39c12; }
        .team-purple { background-color: #9b59b6; border-color: #8e44ad; }
        .team-yellow .team-score-value, .team-yellow .q-text, .team-yellow .manh-moi-status { color: #333; }
        .team-yellow button { color: white; background-color: #e67e22; border: none; }
        .team-yellow button:hover { background-color: #d35400; }
        .team-yellow .input-group input { border: 2px solid #e67e22; }

        /* C·ªòT 1: ƒêI·ªÇM V√Ä ƒêI·ªÄU KHI·ªÇN */
        .team-score-control {
            width: 130px; 
            text-align: center;
            padding: 10px 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
        }

        .team-score-value { 
            font-size: 2.5em;
            font-weight: 900; 
            margin-bottom: 5px;
        }
        .control-button {
            background: #f39c12; 
            border: none; 
            color: white; 
            padding: 5px 10px;
            margin-top: 5px;
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.9em; 
            font-weight: bold; 
            transition: background-color 0.2s;
        }
        .control-button:hover {
            background-color: #e67e22;
        }
        .team-row.finished .control-button {
            display: none;
        }


        /* C·ªòT 2: TR·∫†NG TH√ÅI V√Ä INPUT */
        .team-input-status-area {
            width: 380px;
            padding: 10px 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
        }

        .team-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .manh-moi-status { 
            width: 30px; 
            height: 20px;
            line-height: 20px;
            font-size: 0.8em;
            text-align: center;
            border-radius: 10px; 
            background-color: rgba(0, 0, 0, 0.2);
            font-weight: bold;
            color: white;
            transition: background-color 0.3s, transform 0.3s;
        }
        .manh-moi-completed { background-color: #2ecc71; }
        .man-moi-active { background-color: #f1c40f; color: #333; }

        .input-group input {
            padding: 8px;
            width: 120px;
            font-size: 1em;
            text-align: center;
            margin-right: 8px;
            color: #333;
            flex-shrink: 0;
        }

        .result-message { 
            margin-top: 5px;
            font-size: 0.9em; 
            font-weight: bold;
        }
        .correct-answer { color: #2ecc71; }
        .incorrect-answer { color: #e74c3c; }
        .skip-penalty { color: #f39c12; }

        /* C·ªòT 3: C√ÇU H·ªéI */
        .team-question-area {
            flex-grow: 1;
            padding: 10px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .q-number {
            font-size: 1.2em; 
            font-weight: bold;
            margin-bottom: 5px;
        }
        .q-text {
            font-size: 1.4em;
            font-weight: 700;
            line-height: 1.3;
        }
        .initial-message { /* Th√¥ng b√°o tr∆∞·ªõc khi game ch·∫°y */
            font-size: 1.2em;
            font-weight: 500;
            color: #ccc;
            text-align: center;
        }

        /* KHUNG K·∫æT TH√öC (FINAL MESSAGE) - Chung cho H·∫æT GI·ªú v√† CHI·∫æN TH·∫ÆNG */
        #final-message-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95); 
            color: white;
            display: none; 
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            font-size: 2em;
            z-index: 2000;
        }
        #final-message-content {
            padding: 50px 70px;
            background-color: #34495e; 
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.9);
            transform: scale(1.1); 
        }
        #final-title {
            font-size: 3em; 
            font-weight: 900;
            color: #e74c3c; 
            margin-bottom: 20px;
            animation: pulse 1s infinite alternate;
        }
        #winning-team-display {
            font-size: 1.5em; 
            font-weight: bold;
            margin-bottom: 30px;
        }
        #score-summary {
            font-size: 1em;
            text-align: left;
            margin-top: 20px;
            border-top: 2px solid #fff;
            padding-top: 15px;
        }
        .summary-score-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .summary-score-item .score {
            color: #f1c40f;
            margin-left: 20px;
        }
        @keyframes pulse {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.05); opacity: 0.9; }
        }

        /* KHUNG R∆Ø∆†NG KHO B√ÅU */
        #chest-screen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.98); 
            color: white;
            display: none; 
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            z-index: 3000;
        }
        #chest-icon {
            font-size: 10em;
            transition: transform 0.3s;
        }
        .chest-closed {
            content: 'üîí';
            color: #f1c40f;
        }
        .chest-opened {
            content: 'üéÅ'; 
            color: #2ecc71;
        }
        #prize-display {
            font-size: 3em;
            margin-top: 30px;
            color: #2ecc71;
            font-weight: bold;
            min-height: 1.5em;
        }
        #open-chest-group {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #chest-code-input {
            padding: 10px;
            font-size: 1.2em;
            text-align: center;
            width: 250px;
            margin-bottom: 15px;
            border: 2px solid #f39c12;
            border-radius: 5px;
            color: #333;
        }
        #open-chest-button {
            padding: 15px 30px; 
            font-size: 1.2em; 
            cursor: pointer; 
            background-color: #f39c12; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            transition: background-color 0.2s; 
        }
        #open-chest-button:hover { background-color: #e67e22; }
        #chest-message {
            color: #e74c3c;
            font-weight: bold;
            min-height: 20px;
            margin-top: 10px;
        }
        #reset-button {
             padding: 10px 20px; 
            font-size: 1.2em; 
            cursor: pointer; 
            background-color: #3498db; 
            color: white; 
            border: none; 
            border-radius: 5px; 
        }
    </style>
</head>
<body>

    <div id="timer">10:00</div>

    <div id="start-area">
        <h1>M·∫¨T M√É TH√ÅM T·ª¨: 5 ƒê·ªòI TRANH T√ÄI</h1>
        <p style="font-size: 1.2em; margin-bottom: 20px; color: #ccc;">Gi·∫£i m√£ 7 c√¢u h·ªèi trong 10 ph√∫t ƒë·ªÉ tr·ªü th√†nh th√°m t·ª≠ xu·∫•t s·∫Øc nh·∫•t!</p>
        <p style="font-size: 1em; color: #ccc;">(·∫§n n√∫t **B·∫ÆT ƒê·∫¶U PHI V·ª§!** ƒë·ªÉ chuy·ªÉn sang m√†n h√¨nh ch∆°i v√† gi·∫£i th√≠ch lu·∫≠t)</p>
        <button id="transitionButton">B·∫ÆT ƒê·∫¶U PHI V·ª§!</button>
    </div>

    <div id="game-wrapper">
        <div id="control-area">
            <button id="startGameButton" onclick="startGame()">B·∫ÆT ƒê·∫¶U ƒê·∫æM GI·ªú V√Ä HI·ªÜN C√ÇU H·ªéI</button>
            <button id="conclusionButton" onclick="showFinalMessage(false)">T·ªîNG K·∫æT B·∫§T K·ªÇ H·∫æT GI·ªú</button>
        </div>
        
        <div id="team-rows-container">
            </div>
    </div>

    <div id="final-message-overlay">
        <div id="final-message-content">
            <div id="final-title"></div>
            <div id="winning-team-display"></div>
            <div id="score-summary">
                <p style="text-align: center; margin-bottom: 15px; font-size: 1.2em; color: #f1c40f;">ƒêI·ªÇM S·ªê CHUNG CU·ªòC:</p>
                </div>
             <button id="open-chest-button-trigger" onclick="showChestScreen()">CHUY·ªÇN SANG GIAO DI·ªÜN R∆Ø∆†NG KHO B√ÅU</button>
        </div>
    </div>
    
    <div id="chest-screen-overlay">
        <h2 style="font-size: 2.5em; margin-bottom: 40px; color: #f1c40f;">R∆Ø∆†NG KHO B√ÅU V√î GI√Å</h2>
        <div id="chest-icon" class="chest-closed">üîí</div>
        
        <div id="open-chest-group">
            <input type="text" id="chest-code-input" placeholder="Nh·∫≠p M·∫¨T M√É (ƒê√ÅP √ÅN CU·ªêI C√ôNG)" maxlength="4">
            <button id="open-chest-button" onclick="openChest()">M·ªû KH√ìA R∆Ø∆†NG</button>
            <div id="chest-message"></div>
        </div>
        
        <div id="prize-display"></div>
        
        <button id="reset-button" onclick="window.location.reload()" style="display: none; margin-top: 50px;">CH∆†I L·∫†I</button>
    </div>

    
    <script>
        // C·∫§U H√åNH ƒêI·ªÇM, M·∫¨T M√É V√Ä TH·ªúI GIAN
        const POINTS_PER_CORRECT = 10;
        const PENALTY_PER_SKIP = 20;
        const BONUS_POINTS = 30;
        const GAME_DURATION_SECONDS = 10 * 60; // 10 ph√∫t

        // C·∫§U H√åNH PH·∫¶N TH∆Ø·ªûNG NG·∫™U NHI√äN
        const PRIZE_POOL = [
            "+2 ƒëi·ªÉm v√†o 1 b√†i 15 ph√∫t.",
            "+1 ƒëi·ªÉm v√†o 1 b√†i 15 ph√∫t.",
            "1 tr√†ng ph√°o tay l·ªõn t·ª´ c·∫£ l·ªõp!",
            "1 l·ªùi khen ng·ª£i ƒë·∫∑c bi·ªát t·ª´ gi√°o vi√™n.",
            "Mi·ªÖn 1 c√¢u h·ªèi b√†i t·∫≠p v·ªÅ nh√†.",
            "1 l·∫ßn ƒë·ªïi ƒë·ªôi trong ho·∫°t ƒë·ªông s·∫Øp t·ªõi (n·∫øu c√≥)."
        ];
        
        // M·∫¨T M√É CU·ªêI C√ôNG CHO R∆Ø∆†NG KHO B√ÅU (GV c√≥ th·ªÉ thay ƒë·ªïi s·ªë n√†y)
        const FINAL_SECRET_CODE = '1432'; 


        // D·ªÆ LI·ªÜU C√ÇU H·ªéI M·ªöI (V22 - D·ªØ li·ªáu ƒë·ªìng nh·∫•t)
        const ALL_TEAM_QUESTIONS = {
            red: [{ q: 'Cho CSC c√≥ $u_1=3$ v√† c√¥ng sai $d=2$. T√¨m $u_{10}$.', correct: '21' }, { q: 'Cho CSN c√≥ $u_1=2$ v√† c√¥ng b·ªôi $q=2$. T√¨m $u_5$.', correct: '32' }, { q: 'Cho CSC c√≥ $u_1=2, u_5=18$. T√¨m c√¥ng sai $d$.', correct: '4' }, { q: 'Cho CSN c√≥ $u_1=2, u_3=18$. T√¨m c√¥ng b·ªôi $q$ d∆∞∆°ng.', correct: '3' }, { q: 'Cho CSC c√≥ $u_1=2, u_4=14$. T√¨m t·ªïng $S_4$.', correct: '32' }, { q: 'Cho CSN c√≥ $u_1=2, q=3$. T√¨m t·ªïng $S_3$.', correct: '26' }, { q: 'Cho CSC c√≥ $u_1=5, d=3$. Bi·∫øt $u_n=32$. T√¨m $n$.', correct: '10' } ],
            blue: [{ q: 'Cho CSC c√≥ $u_1=10, d=3$. T√¨m $u_8$.', correct: '31' }, { q: 'Cho CSN c√≥ $u_1=3, q=2$. T√¨m $u_4$.', correct: '24' }, { q: 'Cho CSC c√≥ $u_1=3, u_5=15$. T√¨m c√¥ng sai $d$.', correct: '3' }, { q: 'Cho CSN c√≥ $u_1=3, u_3=12$. T√¨m c√¥ng b·ªôi $q$ d∆∞∆°ng.', correct: '2' }, { q: 'Cho CSC c√≥ $u_1=5, d=2$. T√¨m t·ªïng $S_5$.', correct: '45' }, { q: 'Cho CSN c√≥ $u_1=3, q=2$. T√¨m t·ªïng $S_4$.', correct: '45' }, { q: 'Cho CSN c√≥ $u_1=2, q=2$. Bi·∫øt $u_n=64$. T√¨m $n$.', correct: '6' } ],
            green: [{ q: 'Cho CSC c√≥ $u_1=5, d=4$. T√¨m $u_6$.', correct: '25' }, { q: 'Cho CSN c√≥ $u_1=4, q=3$. T√¨m $u_3$.', correct: '36' }, { q: 'Cho CSC c√≥ $u_1=10, u_5=30$. T√¨m c√¥ng sai $d$.', correct: '5' }, { q: 'Cho CSN c√≥ $u_1=5, u_3=45$. T√¨m c√¥ng b·ªôi $q$ d∆∞∆°ng.', correct: '3' }, { q: 'Cho CSC c√≥ $u_1=2, u_6=12$. T√¨m t·ªïng $S_6$.', correct: '42' }, { q: 'Cho CSN c√≥ $u_1=4, q=2$. T√¨m t·ªïng $S_3$.', correct: '28' }, { q: 'Cho CSC c√≥ $u_1=2, d=4$. Bi·∫øt $u_n=26$. T√¨m $n$.', correct: '7' } ],
            yellow: [{ q: 'Cho CSC c√≥ $u_1=2, d=5$. T√¨m $u_7$.', correct: '32' }, { q: 'Cho CSN c√≥ $u_1=2, q=3$. T√¨m $u_4$.', correct: '54' }, { q: 'Cho CSC c√≥ $u_1=4, u_5=28$. T√¨m c√¥ng sai $d$.', correct: '6' }, { q: 'Cho CSN c√≥ $u_1=2, u_3=50$. T√¨m c√¥ng b·ªôi $q$ d∆∞∆°ng.', correct: '5' }, { q: 'Cho CSC c√≥ $u_1=1, d=3$. T√¨m t·ªïng $S_4$.', correct: '22' }, { q: 'Cho CSN c√≥ $u_1=5, q=-2$. T√¨m t·ªïng $S_3$.', correct: '15' }, { q: 'Cho CSN c√≥ $u_1=3, q=2$. Bi·∫øt $u_n=48$. T√¨m $n$.', correct: '5' } ],
            purple: [{ q: 'Cho CSC c√≥ $u_1=3, d=4$. T√¨m $u_5$.', correct: '19' }, { q: 'Cho CSN c√≥ $u_1=5, q=2$. T√¨m $u_4$.', correct: '40' }, { q: 'Cho CSC c√≥ $u_1=5, u_5=29$. T√¨m c√¥ng sai $d$.', correct: '6' }, { q: 'Cho CSN c√≥ $u_1=4, u_3=100$. T√¨m c√¥ng b·ªôi $q$ d∆∞∆°ng.', correct: '5' }, { q: 'Cho CSC c√≥ $u_1=10, d=-1$. T√¨m t·ªïng $S_5$.', correct: '40' }, { q: 'Cho CSN c√≥ $u_1=4, q=3$. T√¨m t·ªïng $S_3$.', correct: '52' }, { q: 'Cho CSC c√≥ $u_1=10, d=-2$. Bi·∫øt $u_n=0$. T√¨m $n$.', correct: '6' } ]
        };
        
        // D·ªØ li·ªáu 5 ƒê·ªòI CH∆†I
        const teams = [
            { id: 'red', name: 'ƒê·ªôi ƒê·ªè', colorClass: 'team-red', score: 0, currentManhMoiIndex: 0, manhMoiCompletedState: new Array(7).fill(false) },
            { id: 'blue', name: 'ƒê·ªôi Xanh', colorClass: 'team-blue', score: 0, currentManhMoiIndex: 0, manhMoiCompletedState: new Array(7).fill(false) },
            { id: 'green', name: 'ƒê·ªôi L√°', colorClass: 'team-green', score: 0, currentManhMoiIndex: 0, manhMoiCompletedState: new Array(7).fill(false) },
            { id: 'yellow', name: 'ƒê·ªôi V√†ng', colorClass: 'team-yellow', score: 0, currentManhMoiIndex: 0, manhMoiCompletedState: new Array(7).fill(false) },
            { id: 'purple', name: 'ƒê·ªôi T√≠m', colorClass: 'team-purple', score: 0, currentManhMoiIndex: 0, manhMoiCompletedState: new Array(7).fill(false) }, 
        ];
        
        // BI·∫æN TO√ÄN C·ª§C M·ªöI CHO TR·∫†NG TH√ÅI GAME
        let firstWinningTeam = null; 
        let timerInterval = null;
        let timeRemaining = GAME_DURATION_SECONDS;
        let gameActive = false; 
        
        // DOM Elements
        const transitionButton = document.getElementById('transitionButton');
        const startGameButton = document.getElementById('startGameButton');
        const gameWrapper = document.getElementById('game-wrapper');
        const startArea = document.getElementById('start-area');
        const teamRowsContainer = document.getElementById('team-rows-container');
        const finalMessageOverlay = document.getElementById('final-message-overlay');
        const finalTitleElement = document.getElementById('final-title');
        const winningTeamDisplayElement = document.getElementById('winning-team-display');
        const scoreSummaryElement = document.getElementById('score-summary');
        const timerElement = document.getElementById('timer');
        const chestScreenOverlay = document.getElementById('chest-screen-overlay');
        const chestIcon = document.getElementById('chest-icon');
        const prizeDisplay = document.getElementById('prize-display');
        const openChestButtonTrigger = document.getElementById('open-chest-button-trigger');
        const resetButton = document.getElementById('reset-button');
        const chestCodeInput = document.getElementById('chest-code-input');
        const openChestButton = document.getElementById('open-chest-button');
        const chestMessage = document.getElementById('chest-message');


        // ---------------------------------------------------
        // CH·ª®C NƒÇNG ƒê·ªíNG H·ªí
        // ---------------------------------------------------
        
        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerElement.style.display = 'block';
            gameActive = true;
            startGameButton.style.display = 'none'; 

            timerInterval = setInterval(() => {
                if (!gameActive) {
                    clearInterval(timerInterval);
                    return;
                }
                
                timeRemaining--;
                timerElement.textContent = formatTime(timeRemaining);

                if (timeRemaining <= 60) {
                    timerElement.style.color = '#e74c3c'; 
                } else {
                    timerElement.style.color = '#2ecc71'; 
                }

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    timerElement.textContent = "H·∫æT GI·ªú!";
                    showFinalMessage(true); 
                }
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
            gameActive = false;
        }


        // ---------------------------------------------------
        // CH·ª®C NƒÇNG B·∫¢NG ƒêI·ªÇM & ƒêI·ªÄU KHI·ªÇN
        // ---------------------------------------------------
        
        function updateTeamScore(teamId, delta) {
            const team = teams.find(t => t.id === teamId);
            if (team) {
                team.score += delta;
                const scoreElement = document.getElementById(`score-${teamId}`);
                if (scoreElement) {
                    scoreElement.textContent = team.score;
                    scoreElement.style.transition = 'none';
                    scoreElement.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        scoreElement.style.transition = 'transform 0.2s';
                        scoreElement.style.transform = 'scale(1.0)';
                    }, 50);
                }
            }
        }
        window.updateTeamScore = updateTeamScore; 
        
        window.skipQuestion = function(teamId) {
            if (!gameActive) return;
            
            const team = teams.find(t => t.id === teamId);
            if (!team || team.currentManhMoiIndex >= ALL_TEAM_QUESTIONS.red.length) return;
            
            const qIndex = team.currentManhMoiIndex;
            const resultMessage = document.getElementById(`result-message-${teamId}`);
            
            updateTeamScore(teamId, -PENALTY_PER_SKIP);
            
            team.currentManhMoiIndex++; 
            
            let msg = `<span class="skip-penalty">B·ªé QUA!</span> -${PENALTY_PER_SKIP} ƒëi·ªÉm. Chuy·ªÉn sang C√¢u ${team.currentManhMoiIndex + 1 || 'K·∫øt th√∫c'}.`;
            resultMessage.innerHTML = msg;
            resultMessage.className = 'result-message skip-penalty';
            
            renderTeamRows();
        }

        // ---------------------------------------------------
        // CH·ª®C NƒÇNG TR√í CH∆†I
        // ---------------------------------------------------
        
        function getTeamQuestion(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (!team || team.currentManhMoiIndex >= ALL_TEAM_QUESTIONS.red.length) return null; 
            
            const teamQuestions = ALL_TEAM_QUESTIONS[teamId];
            return teamQuestions ? teamQuestions[team.currentManhMoiIndex] : null;
        }
        
        function typesetMath() {
            // ƒê·∫£m b·∫£o MathJax ƒë∆∞·ª£c g·ªçi l·∫°i sau khi n·ªôi dung ƒë√£ ƒë∆∞·ª£c render
            if (window.MathJax) {
                // S·ª≠ d·ª•ng MathJax.typesetPromise() ƒë·ªÉ ch·ªâ x·ª≠ l√Ω c√°c ph·∫ßn t·ª≠ c·∫ßn thi·∫øt
                const questionAreas = document.querySelectorAll('.team-question-area');
                MathJax.typesetPromise(questionAreas).catch((err) => console.error("MathJax typeset failed: " + err.message));
            }
        }


        function renderTeamRows() {
            teamRowsContainer.innerHTML = ''; 
            const totalQuestions = ALL_TEAM_QUESTIONS.red.length;
            
            teams.forEach(team => {
                const qIndex = team.currentManhMoiIndex;
                const questionData = getTeamQuestion(team.id); 
                const isGameFinished = qIndex === totalQuestions;
                
                const row = document.createElement('div');
                row.className = `team-row ${team.colorClass}`;
                row.id = `team-row-${team.id}`;
                
                let questionHTML = '';
                let inputHTML = '';
                
                if (isGameFinished) {
                    row.classList.add('finished');
                    questionHTML = `<div class="q-text">üéâ **HO√ÄN TH√ÄNH ${totalQuestions}/${totalQuestions} C√ÇU H·ªéI!** ƒê·ªôi ${team.name} ƒë√£ gi·∫£i m√£ xong.</div>`;
                    inputHTML = `<div class="result-message correct-answer">ƒêi·ªÉm chung cu·ªôc: ${team.score}</div>`;
                } else if (gameActive && questionData) {
                    row.classList.remove('finished');
                    questionHTML = `
                        <div class="q-number">C√¢u ${qIndex + 1}</div>
                        <div class="q-text" id="q-text-${team.id}">${questionData.q}</div>
                    `;
                    inputHTML = `
                        <div class="input-group">
                            <input type="text" id="answer-input-${team.id}" placeholder="Nh·∫≠p ƒë√°p √°n..." maxlength="4">
                            <button onclick="checkTeamAnswer('${team.id}')">KI·ªÇM TRA</button>
                        </div>
                        <div class="result-message" id="result-message-${team.id}"></div>
                    `;
                } else {
                     // Tr∆∞·ªùng h·ª£p gameActive = false (ch∆∞a b·∫•m Start 2)
                     row.classList.remove('finished');
                     questionHTML = `<div class="initial-message">Ch·ªù Gi√°o vi√™n b·∫•m n√∫t Start ƒë·ªÉ hi·ªán c√¢u h·ªèi.</div>`;
                     inputHTML = `<div class="result-message" style="color: #f1c40f;">S·∫µn s√†ng...</div>`;
                }

                row.innerHTML = `
                    <div class="team-score-control">
                        <div class="team-score-value" id="score-${team.id}">${team.score}</div>
                        ${!isGameFinished && gameActive ? `<button class="control-button" onclick="skipQuestion('${team.id}')">B·ªé QUA (-${PENALTY_PER_SKIP})</button>` : ''}
                    </div>
                    <div class="team-input-status-area">
                        <div class="team-status-bar" id="status-bar-${team.id}">
                            </div>
                        ${!isGameFinished && questionData || !gameActive ? inputHTML : `<div style="padding-top: 10px;">${inputHTML}</div>`}
                    </div>
                    <div class="team-question-area">
                        ${questionHTML}
                    </div>
                `;
                
                teamRowsContainer.appendChild(row);
                renderStatusBar(team, totalQuestions);
            });
            
            // G·ªçi MathJax sau khi t·∫•t c·∫£ c√°c h√†ng ƒë√£ ƒë∆∞·ª£c render
            typesetMath(); 
        }
        
        function renderStatusBar(team, totalQuestions) {
            const statusBar = document.getElementById(`status-bar-${team.id}`);
            if (!statusBar) return;
            statusBar.innerHTML = '';
            
            for (let index = 0; index < totalQuestions; index++) {
                const status = document.createElement('div');
                status.className = 'manh-moi-status';
                status.textContent = 'C' + (index + 1); 
                
                if (team.manhMoiCompletedState[index]) {
                    status.classList.add('manh-moi-completed');
                } else if (index === team.currentManhMoiIndex && gameActive) { 
                    status.classList.add('manh-moi-active');
                }
                
                statusBar.appendChild(status);
            }
        }
        
        window.checkTeamAnswer = function(teamId) {
            if (!gameActive) return;
            
            const team = teams.find(t => t.id === teamId);
            const totalQuestions = ALL_TEAM_QUESTIONS.red.length;
            if (!team || team.currentManhMoiIndex >= totalQuestions) return;
            
            const qIndex = team.currentManhMoiIndex;
            const questionData = getTeamQuestion(teamId); 
            
            const resultMessage = document.getElementById(`result-message-${teamId}`);
            const answerInput = document.getElementById(`answer-input-${teamId}`);
            
            const userAnswer = answerInput.value.trim();
            const correctAnswer = questionData.correct.trim(); 
            
            if (userAnswer === "") {
                resultMessage.innerHTML = 'Vui l√≤ng nh·∫≠p ƒë√°p √°n.';
                resultMessage.className = 'result-message incorrect-answer';
                return;
            }

            // Ch·∫•p nh·∫≠n s·ªë nguy√™n l·ªõn h∆°n 9
            if (userAnswer === correctAnswer) {
                team.manhMoiCompletedState[qIndex] = true;
                team.currentManhMoiIndex++; 
                team.score += POINTS_PER_CORRECT;
                
                let msg = `<span class="correct-answer">CH√çNH X√ÅC!</span> +${POINTS_PER_CORRECT} ƒëi·ªÉm. C√¢u ${qIndex + 1} ƒë√£ ƒë∆∞·ª£c m·ªü kh√≥a.`;

                if (team.currentManhMoiIndex === totalQuestions) {
                     team.score += BONUS_POINTS;
                     msg += `<br>üéâ **TH∆Ø·ªûNG L·ªöN!** Ho√†n th√†nh ${totalQuestions}/${totalQuestions} C√¢u H·ªèi. (+${BONUS_POINTS} ƒëi·ªÉm)`;
                     
                     if (!firstWinningTeam) {
                        firstWinningTeam = team;
                        stopTimer(); 
                        showFinalMessage(false); 
                     }
                }
                
                resultMessage.innerHTML = msg;
                resultMessage.className = 'result-message correct-answer';
                answerInput.value = ''; 
                
                updateTeamScore(teamId, 0);
                renderTeamRows(); 

            } else {
                answerInput.value = ''; 
                resultMessage.innerHTML = `<span class="incorrect-answer">CH∆ØA CH√çNH X√ÅC!</span> Th·ª≠ l·∫°i.`;
                resultMessage.className = 'result-message incorrect-answer';
            }
        }
        
        // ---------------------------------------------------
        // CH·ª®C NƒÇNG K·∫æT TH√öC V√Ä T·ªîNG K·∫æT
        // ---------------------------------------------------
        
        window.showFinalMessage = function(isTimeout) {
            stopTimer();
            gameWrapper.style.display = 'none';
            timerElement.style.display = 'none';
            
            let messageTitle, winningTeam;
            
            // S·∫Øp x·∫øp l·∫°i danh s√°ch c√°c ƒë·ªôi theo ƒëi·ªÉm ƒë·ªÉ t√¨m ng∆∞·ªùi chi·∫øn th·∫Øng chung cu·ªôc
            const sortedTeams = [...teams].sort((a, b) => b.score - a.score);
            winningTeam = sortedTeams[0]; // ƒê·ªôi c√≥ ƒëi·ªÉm cao nh·∫•t

            if (firstWinningTeam) {
                messageTitle = `${firstWinningTeam.name.toUpperCase()} CHI·∫æN TH·∫ÆNG TR∆Ø·ªöC!`;
                
                winningTeamDisplayElement.innerHTML = `
                    ƒê·ªôi ƒë·∫ßu ti√™n ho√†n th√†nh 7 c√¢u h·ªèi: **${firstWinningTeam.name}**
                    <div style="font-size: 1.5em; color: #fff176; margin-top: 10px;">
                        (T·ªîNG K·∫æT D·ª∞A TR√äN TH·ªúI GIAN HO√ÄN TH√ÄNH)
                    </div>
                `;
            } else if (isTimeout) {
                messageTitle = "H·∫æT GI·ªú!";
                winningTeamDisplayElement.textContent = `T·ªîNG K·∫æT THEO ƒêI·ªÇM S·ªê: ƒê·ªôi ${winningTeam.name} d·∫´n ƒë·∫ßu.`;
                winningTeamDisplayElement.style.color = '#f1c40f'; 

            } else { 
                 messageTitle = "T·ªîNG K·∫æT TR∆Ø·ªöC H·∫†N!";
                 winningTeamDisplayElement.textContent = `ƒê·ªôi c√≥ ƒëi·ªÉm cao nh·∫•t: ƒê·ªôi ${winningTeam.name}.`;
                 winningTeamDisplayElement.style.color = '#f1c40f'; 
            }
            
            // Render ƒëi·ªÉm c·ªßa t·∫•t c·∫£ c√°c ƒë·ªôi
            let scoreHTML = `<div style="max-width: 300px; margin: 0 auto;">`;
            sortedTeams.forEach(team => {
                const teamRow = document.getElementById(`team-row-${team.id}`);
                const teamColor = teamRow ? window.getComputedStyle(teamRow).borderColor : '#fff'; 
                scoreHTML += `
                    <div class="summary-score-item" style="color: ${teamColor};">
                        <span>${team.name}</span>
                        <span class="score">${team.score}</span>
                    </div>
                `;
            });
            scoreHTML += `</div>`;
            scoreSummaryElement.innerHTML = `<p style="text-align: center; margin-bottom: 15px; font-size: 1.2em; color: #f1c40f;">ƒêI·ªÇM S·ªê CHUNG CU·ªòC:</p>` + scoreHTML;

            finalTitleElement.textContent = messageTitle;
            finalMessageOverlay.style.display = 'flex';
        }

        // ---------------------------------------------------
        // CH·ª®C NƒÇNG R∆Ø∆†NG KHO B√ÅU (M·ªû B·∫∞NG M·∫¨T M√É)
        // ---------------------------------------------------

        window.showChestScreen = function() {
            finalMessageOverlay.style.display = 'none';
            chestScreenOverlay.style.display = 'flex';
            // Reset input v√† th√¥ng b√°o
            chestCodeInput.value = '';
            chestMessage.textContent = '';
            prizeDisplay.textContent = 'Nh·∫≠p M·∫≠t m√£ ƒë√£ chu·∫©n b·ªã s·∫µn ƒë·ªÉ m·ªü R∆∞∆°ng.';
            chestIcon.textContent = 'üîí';
            chestIcon.classList.remove('chest-opened');
            chestIcon.classList.add('chest-closed');
            openChestButton.style.display = 'block';
            chestCodeInput.style.display = 'block';
            resetButton.style.display = 'none';
        }

        let chestOpened = false;

        window.openChest = function() {
            if (chestOpened) return;

            const inputCode = chestCodeInput.value.trim();

            if (inputCode === FINAL_SECRET_CODE) {
                chestOpened = true;
                chestMessage.textContent = 'M·∫¨T M√É CH√çNH X√ÅC! ƒêang m·ªü R∆∞∆°ng...';
                chestMessage.style.color = '#2ecc71';
                openChestButton.style.display = 'none';
                chestCodeInput.style.display = 'none';

                chestIcon.textContent = 'üîë';
                
                // Hi·ªáu ·ª©ng m·ªü
                setTimeout(() => {
                    chestIcon.textContent = 'üéÅ';
                    chestIcon.classList.remove('chest-closed');
                    chestIcon.classList.add('chest-opened');
                    
                    const randomIndex = Math.floor(Math.random() * PRIZE_POOL.length);
                    const prize = PRIZE_POOL[randomIndex];

                    prizeDisplay.textContent = prize;
                    resetButton.style.display = 'block';
                }, 1500);

            } else {
                chestMessage.textContent = `M·∫¨T M√É CH∆ØA CH√çNH X√ÅC. M√£ ch·ªâ c√≥ ${FINAL_SECRET_CODE.length} ch·ªØ s·ªë.`;
                chestMessage.style.color = '#e74c3c';
            }
        }

        // ---------------------------------------------------
        // KH·ªûI T·∫†O GAME (START Button 2)
        // ---------------------------------------------------
        window.startGame = function() {
            // 1. K√≠ch ho·∫°t ƒë·ªìng h·ªì
            startTimer(); 
            // 2. Hi·ªÉn th·ªã c√¢u h·ªèi v√† c√°c n√∫t ƒëi·ªÅu khi·ªÉn
            renderTeamRows(); 
        };

        // ---------------------------------------------------
        // CHUY·ªÇN M√ÄN H√åNH (START Button 1)
        // ---------------------------------------------------
        transitionButton.addEventListener('click', () => {
            // ·∫®n m√†n h√¨nh Start 1
            startArea.style.display = 'none';
            // Hi·ªán m√†n h√¨nh Game
            gameWrapper.style.display = 'block';
            
            // Thi·∫øt l·∫≠p tr·∫°ng th√°i ban ƒë·∫ßu (ch∆∞a ch·∫°y gi·ªù)
            teams.forEach(team => {
                team.score = 0;
                team.currentManhMoiIndex = 0;
                team.manhMoiCompletedState.fill(false);
            });
            firstWinningTeam = null;
            timeRemaining = GAME_DURATION_SECONDS; 
            chestOpened = false; 
            gameActive = false; 

            // Hi·ªán ƒë·ªìng h·ªì nh∆∞ng ch∆∞a ch·∫°y
            timerElement.textContent = formatTime(GAME_DURATION_SECONDS);
            timerElement.style.display = 'block';
            timerElement.style.color = '#e74c3c'; 

            // Hi·ªán l·∫°i n√∫t Start 2
            startGameButton.style.display = 'block'; 

            // Render giao di·ªán Game (Ch·ªâ hi·ªán b·∫£ng ƒëi·ªÉm v√† th√¥ng b√°o ch·ªù)
            renderTeamRows(); 
        });
        
    </script>

</body>
</html>
