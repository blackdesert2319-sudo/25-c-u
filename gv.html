<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
 apiKey:"AIzaSyDfcMrblRonAS9Q7BSfD9ZZYeOmSy4UjfQ",
 authDomain:"nutnhap.firebaseapp.com",
 projectId:"nutnhap",
 storageBucket:"nutnhap.firebasestorage.app",
 messagingSenderId:"359344838873",
 appId:"1:359344838873:web:d1746d32920881091c86c8",
 measurementId:"G-0VTTNLWDD9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const teams = [
{id:'red',name:'ƒê·ªôi ƒê·ªè',colorClass:'team-red',score:0,currentManhMoiIndex:0,manhMoiCompletedState:new Array(7).fill(false)},
{id:'blue',name:'ƒê·ªôi Xanh',colorClass:'team-blue',score:0,currentManhMoiIndex:0,manhMoiCompletedState:new Array(7).fill(false)},
{id:'green',name:'ƒê·ªôi L√°',colorClass:'team-green',score:0,currentManhMoiIndex:0,manhMoiCompletedState:new Array(7).fill(false)},
{id:'yellow',name:'ƒê·ªôi V√†ng',colorClass:'team-yellow',score:0,currentManhMoiIndex:0,manhMoiCompletedState:new Array(7).fill(false)},
{id:'purple',name:'ƒê·ªôi T√≠m',colorClass:'team-purple',score:0,currentManhMoiIndex:0,manhMoiCompletedState:new Array(7).fill(false)}
];

window.generateQRCodes = function() {
  const BASE_CLIENT_URL = "https://blackdesert2319-sudo.github.io/25-c-u/hs.html?v=2";
  const qrList = document.getElementById('qr-list');
  if (!qrList) return;
  qrList.innerHTML = '';
  teams.forEach(team => {
    const link = `${BASE_CLIENT_URL}?teamId=${team.id}`;
    const div = document.createElement('div');
    div.className = 'qr-item';
    div.innerHTML = `<p>${team.name}</p><div id="qr-${team.id}"></div><small>${link}</small>`;
    qrList.appendChild(div);
    new QRCode(document.getElementById(`qr-${team.id}`), {
      text: link,
      width: 150,
      height: 150,
      colorDark: "#000",
      colorLight: "#fff",
      correctLevel: QRCode.CorrectLevel.H
    });
  });
};

// ‚úÖ Ch·ªù DOM t·∫£i xong m·ªõi k√≠ch ho·∫°t QR v√† n√∫t
document.addEventListener('DOMContentLoaded', () => {
  generateQRCodes();
  const btn = document.getElementById('transitionButton');
  if (btn) btn.addEventListener('click', transitionToGame);
});

// üëâ H√†m chuy·ªÉn sang giao di·ªán thi ƒë·∫•u
window.transitionToGame = function() {
  document.getElementById('intro-wrapper').style.display = 'none';
  document.getElementById('game-wrapper').style.display = 'block';
  renderTeamRows();
};

window.startGame = function() {
  document.getElementById('timer').style.display = 'block';
  startTimer();
  listenForSubmissions();
};

function listenForSubmissions() {
  const q = query(collection(db, "submissions"), orderBy("timestamp", "asc"));
  onSnapshot(q, snapshot => {
    const area = document.getElementById('submission-queue-area');
    let html = `<h2>H√ÄNG ƒê·ª¢I DUY·ªÜT ƒê√ÅP √ÅN (${snapshot.size})</h2>`;
    if (snapshot.empty) html += '<p>Ch∆∞a c√≥ ƒë·ªôi n√†o g·ª≠i.</p>';
    else snapshot.forEach(docSnap => {
      const sub = docSnap.data();
      html += `<div class="submission-item"><b>${sub.teamId.toUpperCase()}</b>: ${sub.answer}
      <button onclick="handleReviewSubmission('${docSnap.id}','${sub.teamId}','${sub.answer}')">DUY·ªÜT</button></div>`;
    });
    area.innerHTML = html;
  });
}

window.handleReviewSubmission = async function(id, teamId, answer) {
  const team = teams.find(t => t.id === teamId);
  if (!team) return;
  const qIndex = team.currentManhMoiIndex;
  const correct = ALL_TEAM_QUESTIONS[teamId][qIndex].correct;
  const isCorrect = answer.trim().toLowerCase() === correct.toLowerCase();
  if (isCorrect) {
    team.score += 10;
    team.currentManhMoiIndex++;
    team.manhMoiCompletedState[qIndex] = true;
    alert(`${team.name}: Ch√≠nh x√°c! +10 ƒëi·ªÉm`);
  } else alert(`${team.name}: Sai! ƒê√°p √°n ƒë√∫ng l√† ${correct}`);
  await deleteDoc(doc(db, "submissions", id));
  renderTeamRows();
};

const ALL_TEAM_QUESTIONS = {
  red:[{q:'Cho CSC c√≥ $u_1=3$, $d=2$. T√¨m $u_{10}$.',correct:'21'}],
  blue:[{q:'Cho CSN c√≥ $u_1=3$, $q=2$. T√¨m $u_4$.',correct:'24'}],
  green:[{q:'Cho CSC c√≥ $u_1=5$, $d=4$. T√¨m $u_6$.',correct:'25'}],
  yellow:[{q:'Cho CSC c√≥ $u_1=2$, $d=5$. T√¨m $u_7$.',correct:'32'}],
  purple:[{q:'Cho CSC c√≥ $u_1=3$, $d=4$. T√¨m $u_5$.',correct:'19'}]
};

function renderTeamRows() {
  const c = document.getElementById('team-rows-container');
  let html = '';
  teams.forEach(team => {
    const i = team.currentManhMoiIndex;
    const qText = i < ALL_TEAM_QUESTIONS[team.id].length
      ? ALL_TEAM_QUESTIONS[team.id][i].q
      : "ƒê√É HO√ÄN TH√ÄNH";
    html += `<div class="team-row ${team.colorClass}">
      <div class="team-score-control"><div class="team-score-value">${team.score}</div>${team.name}</div>
      <div class="team-status-area">
        ${team.manhMoiCompletedState.map((done,idx)=>`<div class="q-status-item ${done?'status-correct':idx===i?'status-ready':''}">${idx+1}</div>`).join('')}
      </div>
      <div class="team-question-area"><div class="q-number">C√¢u ${i+1}</div><div class="q-text">${qText}</div></div>
    </div>`;
  });
  c.innerHTML = html;
  if (window.MathJax) window.MathJax.typesetPromise([c]);
}

let timer = 600;
function startTimer() {
  const el = document.getElementById('timer');
  setInterval(() => {
    timer--;
    const m = Math.floor(timer / 60), s = timer % 60;
    el.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  }, 1000);
}
</script>
