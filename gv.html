<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M·∫≠t M√£ R∆∞∆°ng B√°u - GV (Final)</title>

<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
<script>
window.MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
  svg: { fontCache: 'global' }
};
</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>
body {
  font-family:'Arial',sans-serif;
  background:#1e1e1e;
  color:#fff;
  margin:0;
  padding:0;
  overflow-x:hidden;
}
h1 { color:#f1c40f; margin:12px 0; text-align:center; }
#timer {
  position:fixed;
  top:8px; left:12px;
  font-size:2.2em; font-weight:bold;
  color:#e74c3c; background:#f1c40f;
  padding:4px 12px; border-radius:8px;
  display:none;
  z-index:10;
}
#endEarlyBtn {
  position:fixed;
  top:15px; left:130px;
  font-size:1.1em;
  background:#e67e22;
  color:white;
  border:none;
  border-radius:8px;
  padding:6px 14px;
  font-weight:bold;
  cursor:pointer;
  display:none;
  z-index:10;
}

/* === QR ·ªü giao di·ªán ƒë·∫ßu === */
#qr-list {
  /* Gi·ªØ display:flex ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng khi ·ªü giao di·ªán 1 */
  display:flex !important; 
  flex-wrap:wrap;
  justify-content:center;
  align-items:center;
  gap:12px;
  margin-top:20px;
}
.qr-item {
  width:180px;
  margin:10px;
  padding:10px;
  border-radius:8px;
  background:white;
  color:#333;
  text-align:center;
  font-weight:bold;
  border: 2px solid transparent;
}
.qr-item img {
  width:150px; height:150px;
  border:2px solid transparent;
  margin-bottom:5px;
}
.qr-item.team-red { border-color: #e74c3c; }
.qr-item.team-blue { border-color: #3498db; }
.qr-item.team-green { border-color: #2ecc71; }
.qr-item.team-yellow { border-color: #f1c40f; }
.qr-item.team-purple { border-color: #9b59b6; }

/* === GIAO DI·ªÜN 2 === */
#game-wrapper { display:none; position:relative; }
.game-layout {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: flex-start;
  width: 100%;
  margin: 0;
  padding: 0 10px;
  box-sizing: border-box;
}

/* C·ªôt tr√°i: c√°c ƒë·ªôi */
#team-rows-container {
  flex: 1;
  margin-right: 15px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
}

/* C·ªôt ph·∫£i: h√†ng ƒë·ª£i */
#submission-queue-area {
  width: 140px; 
  background: #34495e;
  border-radius: 10px;
  padding: 8px;
  height: calc(100vh - 40px);
  overflow-y: auto;
  position: fixed;
  right: 0;
  top: 0;
}
#submission-queue-area h2 {
  font-size: 1em;
  text-align: center;
  color: #f1c40f;
  margin-bottom: 10px;
}
/* CSS cho B·ªô ƒë·∫øm */
#queue-count {
  background: #e74c3c; 
  padding: 2px 8px;
  border-radius: 5px;
  font-size: 1em;
  font-weight: bold;
}

/* === KHUNG M·ªñI ƒê·ªòI === */
.team-row {
  display:flex;
  align-items:center;
  justify-content:flex-start;
  width:100%;
  padding:8px 18px;
  border-radius:10px;
  box-shadow:0 2px 5px rgba(0,0,0,0.4);
  min-height:95px;
}
.team-red{background:#e74c3c;}
.team-blue{background:#3498db;}
.team-green{background:#2ecc71;}
.team-yellow{background:#f1c40f;color:#333;}
.team-purple{background:#9b59b6;}

.team-score-control {
  width:160px;
  display:flex;
  flex-direction:row;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.team-score-value {
  font-size:2.5em;
  font-weight:900;
  background:rgba(255,255,255,0.25);
  padding:2px 12px;
  border-radius:8px;
}
.q-status-item {
  width:36px;
  height:36px;
  border-radius:50%;
  font-size:1.1em;
  font-weight:bold;
  color:white;
  background:#2980b9;
  display:flex;
  justify-content:center;
  align-items:center;
}

/* KHU V·ª∞C HI·ªÇN TH·ªä C√ÇU H·ªéI HI·ªÜN T·∫†I */
.team-question-area {
  flex:1;
  padding-left:20px;
  display:none; 
}
.question-title {
  font-size: 1.8em; 
  font-weight: 700;
  line-height: 1.3;
  color: #ffffff; 
}

/* H√†ng ƒë·ª£i duy·ªát ƒë√°p √°n (CSS cho m·ª•c r√∫t g·ªçn) */
.submission-item {
  padding:8px;
  margin-bottom:8px;
  background:#2c3e50;
  border-radius:6px;
  border-left:4px solid #f1c40f;
  text-align:center;
}
.submission-item button {
  padding:5px 10px;
  color:white;
  border:none;
  border-radius:5px;
  font-weight:bold;
  font-size:0.9em;
  cursor:pointer;
  width: 90%;
  margin-top: 5px;
}

/* START BUTTON */
#startGameBtn {
  position:absolute;
  top:0px; 
  left:100px;
  transform:translate(-50%, -50%);
  font-size:2em;
  padding:14px 30px;
  border:none;
  border-radius:10px;
  background:#2ecc71;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
  display:none;
  z-index:10;
}

/* OVERLAY K·∫æT TH√öC V√Ä R∆Ø∆†NG B√ÅU */
#endOverlay {
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(241,196,15,0.9);
  color:#000;
  z-index:20;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  text-align:center;
  /* Ch·∫∑n click ra ngo√†i */
  pointer-events: auto; 
}
/* === CSS CHO GIAO DI·ªÜN R∆Ø∆†NG B√ÅU === */
#treasure-box-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    width: 90%;
    max-width: 600px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
}
.treasure-image {
    width: 250px; 
    height: 250px;
    /* C·∫¨P NH·∫¨T ƒê∆Ø·ªúNG D·∫™N T·ª™ GITHUB C·ª¶A B·∫†N */
    background-image: url('https://raw.githubusercontent.com/blackdesert2319-sudo/25-c-u/main/treasure-closed.png'); 
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    transition: transform 1s ease-in-out;
}
.opened .treasure-image {
    /* C·∫¨P NH·∫¨T ƒê∆Ø·ªúNG D·∫™N T·ª™ GITHUB C·ª¶A B·∫†N */
    background-image: url('https://raw.githubusercontent.com/blackdesert2319-sudo/25-c-u/main/treasure-opened.png'); 
    animation: shake 0.5s;
}
#code-input {
    padding: 15px;
    font-size: 1.5em;
    margin: 20px 0 10px;
    border: 3px solid #f1c40f;
    border-radius: 8px;
    text-align: center;
    width: 200px;
    background: #333;
    color: #fff;
    font-weight: bold;
}
#submitCodeBtn, #closeTreasureBtn {
    padding: 12px 25px;
    font-size: 1.2em;
    background: #2ecc71;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
}
@keyframes shake {
    0% { transform: translate(1px, 1px) rotate(0deg); }
    10% { transform: translate(-1px, -2px) rotate(-1deg); }
    20% { transform: translate(-3px, 0px) rotate(1deg); }
    30% { transform: translate(3px, 2px) rotate(0deg); }
    40% { transform: translate(1px, -1px) rotate(1deg); }
    50% { transform: translate(-1px, 2px) rotate(-1deg); }
    60% { transform: translate(-3px, 1px) rotate(0deg); }
    70% { transform: translate(3px, 1px) rotate(-1deg); }
    80% { transform: translate(-1px, -1px) rotate(1deg); }
    90% { transform: translate(1px, 2px) rotate(0deg); }
    100% { transform: translate(1px, -2px) rotate(-1deg); }
}
</style>
</head>

<body>
  <h1>CHI·∫æN TH·∫ÆNG KHI HO√ÄN TH√ÄNH 7 C√ÇU H·ªéI NHANH NH·∫§T</h1>
  <div id="qr-list"></div>

  <div id="main-controls" style="text-align:center;">
    <button id="startBtn" style="padding:12px 22px;font-size:1.2em;background:#f1c40f;color:#222;border:none;border-radius:8px;margin:20px 5px;font-weight:bold;cursor:pointer;">
      B·∫ÆT ƒê·∫¶U V√íNG 3!
    </button>
    <button id="resetBtn" style="font-size: 1.2em;padding: 12px 22px;background: #e74c3c;color: #fff;border: none;border-radius: 8px;margin: 20px 5px;font-weight: bold;cursor: pointer;">
      üí£ RESET D·ªÆ LI·ªÜU
    </button>
    <button id="showTreasureBtn" style="padding:12px 22px;font-size:1.2em;background:#9b59b6;color:#fff;border:none;border-radius:8px;margin:20px 5px;font-weight:bold;cursor:pointer;">
      M·ªû GIAO DI·ªÜN R∆Ø∆†NG B√ÅU
    </button>
  </div>
  <div id="game-wrapper">
    <div id="timer">10:00</div>
    <button id="endEarlyBtn">K·∫æT TH√öC S·ªöM</button>
    <button id="startGameBtn">START</button>
    <div class="game-layout">
      <div id="team-rows-container"></div>
      <div id="submission-queue-area">
        <h2>H√ÄNG ƒê·ª¢I DUY·ªÜT ƒê√ÅP √ÅN (<span id="queue-count">0</span>)</h2>
      </div>
    </div>
  </div>

  <div id="endOverlay">
    </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getFirestore, collection, query, where, onSnapshot, doc, deleteDoc, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // === C·∫§U H√åNH FIREBASE ===
  const firebaseConfig = {
    apiKey: "AIzaSyDfcMrblRonAS9Q7BSfD9ZZYeOmSy4UjfQ",
    authDomain: "nutnhap.firebaseapp.com",
    projectId: "nutnhap",
    storageBucket: "nutnhap.firebasestorage.app",
    messagingSenderId: "359344838873",
    appId: "1:359344838873:web:d1746d32920881091c86c8",
    measurementId: "G-0VTTNLWDD9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  
  // COLLECTION M·ªöI ƒê·ªÇ ƒê·ªíNG B·ªò H√ìA TR·∫†NG TH√ÅI (HS s·∫Ω l·∫Øng nghe)
  const TEAM_STATUS_COLLECTION = "team_status";

  // D1. M·∫£ng ƒë·ªôi
  const teams = [
    { name: "ƒê·ªôi ƒê·ªè", color: "team-red", id: "red", score: 0, currentQ: 1, questionOrder: [] },
    { name: "ƒê·ªôi Xanh", color: "team-blue", id: "blue", score: 0, currentQ: 1, questionOrder: [] },
    { name: "ƒê·ªôi L·ª•c", color: "team-green", id: "green", score: 0, currentQ: 1, questionOrder: [] },
    { name: "ƒê·ªôi V√†ng", color: "team-yellow", id: "yellow", score: 0, currentQ: 1, questionOrder: [] },
    { name: "ƒê·ªôi T√≠m", color: "team-purple", id: "purple", score: 0, currentQ: 1, questionOrder: [] }
  ];

  // ==========================================================
  // M·∫¢NG 35 C√ÇU H·ªéI V√Ä ƒê√ÅP √ÅN ƒê√öNG M·∫™U (Nh√≥m theo ƒë·ªôi)
  // M·ªói ƒë·ªôi c√≥ 7 c√¢u h·ªèi ri√™ng bi·ªát.
  const QUESTIONS = {
    // ƒê·ªòI ƒê·ªé (Q1.1 -> Q1.7)
    'red': [
        { qIndex: 'Q1.1', text: "Cho CSC c√≥ $u_1=3$, $d=2$. T√¨m $u_{10}$", answer: "21" }, 
        { qIndex: 'Q1.2', text: "T√≠nh t·ªïng 1 + 2 + ... + 10", answer: "55" }, 
        { qIndex: 'Q1.3', text: "K·∫øt qu·∫£ ph√©p t√≠nh 15 x 3", answer: "45" }, 
        { qIndex: 'Q1.4', text: "NƒÉm sinh c·ªßa H·ªì Ch√≠ Minh", answer: "1890" }, 
        { qIndex: 'Q1.5', text: "S·ªë ng√†y trong 3 th√°ng li√™n ti·∫øp kh√¥ng c√≥ th√°ng 2", answer: "92" }, 
        { qIndex: 'Q1.6', text: "S·ªë nguy√™n t·ªë nh·ªè nh·∫•t", answer: "2" }, 
        { qIndex: 'Q1.7', text: "K·∫øt qu·∫£ c·ªßa 5! (5 giai th·ª´a)", answer: "120" }
    ],
    // ƒê·ªòI XANH (Q2.1 -> Q2.7)
    'blue': [
        { qIndex: 'Q2.1', text: "T√≠nh $\\log_2 8$", answer: "3" }, 
        { qIndex: 'Q2.2', text: "Di·ªán t√≠ch h√¨nh tr√≤n c√≥ b√°n k√≠nh r=1", answer: "pi" }, 
        { qIndex: 'Q2.3', text: "S·ªë ch·∫µn l·ªõn nh·∫•t c√≥ 2 ch·ªØ s·ªë", answer: "98" }, 
        { qIndex: 'Q2.4', text: "T·ªïng c√°c g√≥c trong m·ªôt tam gi√°c", answer: "180" }, 
        { qIndex: 'Q2.5', text: "$3^3 + 1$", answer: "28" }, 
        { qIndex: 'Q2.6', text: "S·ªë l∆∞·ª£ng h√†nh tinh trong H·ªá M·∫∑t Tr·ªùi", answer: "8" }, 
        { qIndex: 'Q2.7', text: "$\\int_{0}^{1} x dx$", answer: "0.5" }
    ],
    // ƒê·ªòI L·ª§C (Q3.1 -> Q3.7)
    'green': [
        { qIndex: 'Q3.1', text: "$2 \\times 2 \\times 2 + 10$", answer: "18" }, 
        { qIndex: 'Q3.2', text: "S·ªë ·∫¢ R·∫≠p (Arabic) t∆∞∆°ng ƒë∆∞∆°ng v·ªõi s·ªë La M√£ 'IX'", answer: "9" }, 
        { qIndex: 'Q3.3', text: "Th·ªß ƒë√¥ c·ªßa Vi·ªát Nam", answer: "Hanoi" }, 
        { qIndex: 'Q3.4', text: "$12 \\times 12$", answer: "144" }, 
        { qIndex: 'Q3.5', text: "Giai th·ª´a c·ªßa 4 (4!)", answer: "24" }, 
        { qIndex: 'Q3.6', text: "$1 + 1/2 + 1/4 + 1/8 + ...$ (t·ªïng v√¥ h·∫°n)", answer: "2" }, 
        { qIndex: 'Q3.7', text: "$e^0$", answer: "1" }
    ],
    // ƒê·ªòI V√ÄNG (Q4.1 -> Q4.7)
    'yellow': [
        { qIndex: 'Q4.1', text: "T√¨m nghi·ªám c·ªßa $x+5=12$", answer: "7" }, 
        { qIndex: 'Q4.2', text: "T√™n ƒë·∫°i d∆∞∆°ng l·ªõn nh·∫•t th·∫ø gi·ªõi", answer: "Th√°i B√¨nh D∆∞∆°ng" }, 
        { qIndex: 'Q4.3', text: "$100 \\div 4$", answer: "25" }, 
        { qIndex: 'Q4.4', text: "S·ªë th·∫≠p ph√¢n c·ªßa $1/4$", answer: "0.25" }, 
        { qIndex: 'Q4.5', text: "$9^2 - 1$", answer: "80" }, 
        { qIndex: 'Q4.6', text: "S·ªë l∆∞·ª£ng m√∫i gi·ªù ti√™u chu·∫©n tr√™n th·∫ø gi·ªõi", answer: "24" }, 
        { qIndex: 'Q4.7', text: "$\\cos(90^\\circ)$", answer: "0" }
    ],
    // ƒê·ªòI T√çM (Q5.1 -> Q5.7)
    'purple': [
        { qIndex: 'Q5.1', text: "S·ªë l·ªõn nh·∫•t c√≥ 3 ch·ªØ s·ªë", answer: "999" }, 
        { qIndex: 'Q5.2', text: "Kh·ªëi l∆∞·ª£ng ri√™ng c·ªßa n∆∞·ªõc tinh khi·∫øt ($kg/m^3$)", answer: "1000" }, 
        { qIndex: 'Q5.3', text: "Chu vi h√¨nh vu√¥ng c√≥ c·∫°nh l√† 5", answer: "20" }, 
        { qIndex: 'Q5.4', text: "N∆∞·ªõc c√≥ bao nhi√™u m√†u?", answer: "0" }, 
        { qIndex: 'Q5.5', text: "T√≠nh $\\sqrt{49}$", answer: "7" }, 
        { qIndex: 'Q5.6', text: "$\\lim_{n \\to \\infty} \\frac{1}{n}$", answer: "0" }, 
        { qIndex: 'Q5.7', text: "NƒÉm ƒë∆∞·ª£c xem l√† k·∫øt th√∫c Chi·∫øn tranh th·∫ø gi·ªõi th·ª© hai", answer: "1945" }
    ]
  };
  // ==========================================================

  // √Ånh x·∫° c√°c class m√†u CSS sang m√£ m√†u Hex cho n·ªÅn QR v√† c·ªôt duy·ªát
  const teamColorMap = {
      'team-red': '#f8d7da',        
      'team-blue': '#d0e0f0',       
      'team-yellow': '#fff3cd',      
      'team-green': '#d4edda',       
      'team-purple': '#e8d9ef',
      'red': '#e74c3c', // M√†u vi·ªÅn c·ªôt duy·ªát
      'blue': '#3498db',
      'green': '#2ecc71',
      'yellow': '#f1c40f',
      'purple': '#9b59b6'
  };

  // H·∫∞NG S·ªê GAME
  const TREASURE_BONUS = 30; 
  const WINNING_QUESTION = 7; // S·ªë c√¢u h·ªèi m·ªói ƒë·ªôi
  let timerInterval;
  let totalSeconds = 600; // 10 ph√∫t
  let isTreasureOverlayOpen = false; // Tr·∫°ng th√°i c·ªßa Overlay R∆∞∆°ng B√°u/K·∫øt th√∫c
  const TREASURE_CODE = "2025"; // M√£ b√≠ m·∫≠t m·∫∑c ƒë·ªãnh

  // H√†m ti·ªán √≠ch: X√°o tr·ªôn m·∫£ng (Fisher-Yates)
  function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
      }
  }

  // H√†m m·ªõi: Thi·∫øt l·∫≠p th·ª© t·ª± c√¢u h·ªèi ng·∫´u nhi√™n cho m·ªói ƒë·ªôi
  function setupQuestionOrder() {
      // M·∫£ng ch·ªâ s·ªë c√¢u h·ªèi thu·ªôc nh√≥m c·ªßa ƒë·ªôi ƒë√≥ (t·ª´ 0 ƒë·∫øn 6)
      const questionIndices = Array.from({length: WINNING_QUESTION}, (_, i) => i); 
      teams.forEach(team => {
          const shuffledOrder = [...questionIndices]; // Copy m·∫£ng
          shuffleArray(shuffledOrder);
          team.questionOrder = shuffledOrder; // L∆∞u m·∫£ng th·ª© t·ª± ng·∫´u nhi√™n (ch·ªâ s·ªë 0-6)
      });
      console.log("Question orders randomized:", teams.map(t => ({ id: t.id, order: t.questionOrder })));
  }

  window.onload = function() {
    const qrList = document.getElementById("qr-list");
    qrList.innerHTML = "";
    const baseURL = location.href.replace(/[^/]*$/, "") + "hs.html";
    teams.forEach(team => {
      const div = document.createElement("div");
      div.className = "qr-item " + team.color; 
      div.innerHTML = `<div>${team.name}</div><div id="qr-${team.id}"></div>`;
      qrList.appendChild(div);
      new QRCode(document.getElementById("qr-" + team.id), {
        text: `${baseURL}?teamId=${team.id}`,
        width: 150,
        height: 150
      });
    });
    checkIfGameStarted();
  };
  
  // H√ÄM: Ki·ªÉm tra tr·∫°ng th√°i game v√† hi·ªÉn th·ªã l·∫°i giao di·ªán
  async function checkIfGameStarted() {
      try {
          // L·∫•y tr·∫°ng th√°i c·ªßa ƒë·ªôi b·∫•t k·ª≥ (v√≠ d·ª• ƒë·ªôi ƒë·ªè) ƒë·ªÉ ki·ªÉm tra xem game ƒë√£ setup ch∆∞a
          const docRef = doc(db, TEAM_STATUS_COLLECTION, 'red');
          const docSnap = await getDocs(docRef);

          if (docSnap.exists() && docSnap.data().questionOrder && docSnap.data().questionOrder.length > 0) {
              const snapshot = await getDocs(collection(db, TEAM_STATUS_COLLECTION));
              snapshot.docs.forEach(doc => {
                  const data = doc.data();
                  const team = teams.find(t => t.id === doc.id);
                  if (team) {
                      team.score = data.score || 0;
                      team.currentQ = data.currentQ || 1;
                      team.questionOrder = data.questionOrder || [];
                  }
              });
              
              showGameLayout();
          }
      } catch (e) {
          console.error("L·ªói khi ki·ªÉm tra tr·∫°ng th√°i game:", e);
      }
  }

  // H√†m m·ªõi: Kh·ªüi t·∫°o tr·∫°ng th√°i ƒë·ªôi tr√™n Firebase
  async function initializeTeamStatusOnFirebase() {
      setupQuestionOrder();
      
      const promises = teams.map(team => {
          return setDoc(doc(db, TEAM_STATUS_COLLECTION, team.id), {
              score: team.score,
              currentQ: team.currentQ,
              name: team.name,
              questionOrder: team.questionOrder
          });
      });
      await Promise.all(promises);
      console.log("Team statuses initialized on Firebase.");
  }

  // H√†m m·ªõi: C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë·ªôi tr√™n Firebase (ƒë·ªÉ HS c·∫≠p nh·∫≠t theo)
  async function updateTeamStatusOnFirebase(teamId, newScore, newQ, newOrder) {
      try {
          await setDoc(doc(db, TEAM_STATUS_COLLECTION, teamId), {
              score: newScore,
              currentQ: newQ,
              questionOrder: newOrder
          }, { merge: true });
      } catch (e) {
          console.error("Error updating team status on Firebase:", e);
      }
  }

  // H√ÄM S·ª¨A: B·∫ÆT ƒê·∫¶U V√íNG 3 (Chu·∫©n b·ªã data v√† chuy·ªÉn giao di·ªán)
  async function showGame(){
    await initializeTeamStatusOnFirebase();
    showGameLayout();
  }

  // H√ÄM S·ª¨A: Ch·ªâ hi·ªÉn th·ªã giao di·ªán ch∆°i v√† ·∫©n main-controls
  function showGameLayout(){
    // D√íNG N√ÄY ƒê·ªÇ ·∫®N QR
    document.getElementById("qr-list").style.display="none"; 
    document.getElementById("main-controls").style.display="none"; 

    document.getElementById("game-wrapper").style.display="block";
    renderTeams(); // V·∫º L·∫†I GIAO DI·ªÜN C√ÅC ƒê·ªòI
    listenForSubmissions();
    document.getElementById("startGameBtn").style.display="block"; 
    // C√ÇU H·ªéI V·∫™N ƒêANG ·∫®N, CH·ªà HI·ªÇN TH·ªä KHI B·∫§M START
  }
  
  // H√†m ti·ªán √≠ch: L·∫•y d·ªØ li·ªáu c√¢u h·ªèi th·ª±c t·∫ø d·ª±a tr√™n teamId v√† index trong m·∫£ng x√°o tr·ªôn
  function getQuestionData(teamId, qIndexInOrder) {
      const team = teams.find(t => t.id === teamId);
      if (!team || !QUESTIONS[teamId]) return null;
      
      // L·∫•y index TH·ª∞C T·∫æ (0-6) t·ª´ m·∫£ng x√°o tr·ªôn
      const actualQIndex = team.questionOrder[qIndexInOrder - 1]; 
      
      // Tr·∫£ v·ªÅ d·ªØ li·ªáu c√¢u h·ªèi t·ª´ m·∫£ng QUESTIONS c·ªßa ƒë·ªôi ƒë√≥
      return QUESTIONS[teamId][actualQIndex];
  }


  // H√ÄM S·ª¨A: ƒê·∫£m b·∫£o c√¢u h·ªèi m·∫∑c ƒë·ªãnh l√† S·∫¥N S√ÄNG
  function renderTeams(){
    const container = document.getElementById("team-rows-container");
    container.innerHTML = "";
    teams.forEach(team=>{
      // Text m·∫∑c ƒë·ªãnh tr∆∞·ªõc khi START
      const questionText = "S·∫¥N S√ÄNG..."; 
      
      const row=document.createElement("div");
      row.className=`team-row ${team.color}`;

      row.innerHTML=`
        <div class="team-score-control">
          <div class="team-score-value" id="score-${team.id}">${team.score}</div>
          <div class="q-status-item" id="status-${team.id}">${team.currentQ}</div>
        </div>
        <div class="team-question-area" id="qarea-${team.id}" style="display:none;">
            <div class="question-title" id="q-title-${team.id}">
                ${questionText}
            </div>
        </div>
      `;
      container.appendChild(row);
    });
  }

  // H√ÄM: C·∫≠p nh·∫≠t ch·ªâ hi·ªÉn th·ªã c√¢u h·ªèi (ƒê√£ b·ªè m√£ Qx.y)
  function updateQuestionDisplay(team) {
      const qTitleElement = document.getElementById(`q-title-${team.id}`);
      
      if (qTitleElement) {
          const questionData = getQuestionData(team.id, team.currentQ);
          const questionText = questionData ? questionData.text : "HO√ÄN TH√ÄNH!";
          qTitleElement.innerHTML = `${questionText}`; 
      }
      MathJax.typeset();
  }

  // H√ÄM S·ª¨A: C·∫≠p nh·∫≠t c√¢u h·ªèi khi START
  function startCountdown(){
    document.getElementById("startGameBtn").style.display="none";
    document.getElementById("timer").style.display="block";
    document.getElementById("endEarlyBtn").style.display="block";
    document.querySelectorAll('.team-question-area').forEach(el=>el.style.display='block'); 
    
    // C·∫¨P NH·∫¨T C√ÇU H·ªéI TH·ª∞C T·∫æ L·∫¶N ƒê·∫¶U TI√äN KHI B·∫§M START
    teams.forEach(team => {
        updateQuestionDisplay(team); 
    });

    MathJax.typeset();
    timerInterval = setInterval(updateTimer,1000);
  }

  function updateTimer(){
    const min = Math.floor(totalSeconds/60);
    const sec = totalSeconds%60;
    document.getElementById("timer").textContent = `${min}:${sec.toString().padStart(2,'0')}`;
    if(totalSeconds <= 0){
      clearInterval(timerInterval);
      endGame();
    }
    if(totalSeconds <= 10){
      document.getElementById("timer").style.background="#e74c3c";
    }
    totalSeconds--;
  }
  
  // H√ÄM: X·ª≠ l√Ω nh·∫≠p m√£ v√† hi·ªáu ·ª©ng m·ªü r∆∞∆°ng
  function handleOpenTreasure() {
      const inputCode = document.getElementById("code-input").value.trim();
      const treasureImage = document.getElementById("treasure-image");
      const container = document.getElementById("treasure-box-container");

      if (inputCode === TREASURE_CODE) {
          // M√É ƒê√öNG: HI·ªÜU ·ª®NG M·ªû
          container.classList.add('opened');
          // ƒê∆∞·ªùng d·∫´n ·∫£nh ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t trong CSS, ch·ªâ c·∫ßn k√≠ch ho·∫°t class
          document.getElementById("submitCodeBtn").textContent = "üîì M√É CH√çNH X√ÅC! üéâ";
          document.getElementById("submitCodeBtn").disabled = true;

          // Hi·ªÉn th·ªã th√¥ng b√°o v√† hi·ªáu ·ª©ng
          setTimeout(() => {
               alert("Th√†nh c√¥ng! R∆∞∆°ng B√°u ƒë√£ m·ªü, c√°c h·ªôp qu√† ƒëang bay ra!");
          }, 1200);

      } else {
          // M√É SAI
          alert("M√£ R∆∞∆°ng B√°u kh√¥ng ch√≠nh x√°c! Vui l√≤ng th·ª≠ l·∫°i.");
          document.getElementById("code-input").value = "";
      }
  }

  // H√ÄM M·ªöI: Hi·ªÉn th·ªã giao di·ªán nh·∫≠p m√£ R∆∞∆°ng B√°u
  function renderTreasureOverlay(winningTeam = null, isFinal = false) {
      const overlay = document.getElementById("endOverlay");
      overlay.style.backgroundColor = 'rgba(155, 89, 182, 0.95)'; 
      overlay.style.color = '#fff';
      overlay.style.display = "flex";
      isTreasureOverlayOpen = true;
      
      // TH√äM: ƒê·∫£m b·∫£o ·∫©n kh·ªëi QR khi Overlay m·ªü (ph√≤ng tr∆∞·ªùng h·ª£p g·ªçi t·ª´ n√∫t)
      document.getElementById("qr-list").style.display="none"; 

      // X√≥a class 'opened' c≈© n·∫øu c√≥
      overlay.querySelector('#treasure-box-container')?.classList.remove('opened');

      // T√≠nh to√°n ƒëi·ªÉm s·ªë hi·ªán t·∫°i
      let scoreHTML = "K·∫æT QU·∫¢ HI·ªÜN T·∫†I (Tr∆∞·ªõc khi k·∫øt th√∫c):<br>";
      teams.forEach(t => {
          // L·∫•y ƒëi·ªÉm t·ª´ giao di·ªán n·∫øu ƒëang ch∆°i, n·∫øu kh√¥ng th√¨ l·∫•y t·ª´ bi·∫øn team
          const score = document.getElementById(`score-${t.id}`) ? document.getElementById(`score-${t.id}`).textContent : t.score; 
          const status = document.getElementById(`status-${t.id}`) ? document.getElementById(`status-${t.id}`).textContent : t.currentQ;
          scoreHTML += `<div style="margin: 5px 0;">${t.name}: ${score} ƒëi·ªÉm (C${status})</div>`;
      });

      // N·ªôi dung Overlay R∆∞∆°ng B√°u
      overlay.innerHTML = `
          <div id="treasure-box-container">
              ${isFinal ? 
                  `<h1 style="color: #f1c40f;">üèÜ ${winningTeam.name} GI√ÄNH CHI·∫æN TH·∫ÆNG! üèÜ</h1>
                   <h2>Nh·∫≠p M√É R∆Ø∆†NG B√ÅU ƒë·ªÉ m·ªü kh√≥a ph·∫ßn th∆∞·ªüng!</h2>` : 
                  `<h1>üíé TR·∫†NG TH√ÅI R∆Ø∆†NG B√ÅU üíé</h1>
                   <h2 style="color: #f1c40f;">${scoreHTML}</h2>
                   <h2>(Ti·∫øp t·ª•c gi·∫£i m·∫≠t m√£ ƒë·ªÉ gi√†nh ph·∫ßn th∆∞·ªüng!)</h2>`
              }
              <div class="treasure-image" id="treasure-image"></div>
              
              ${isFinal ? 
                  `<input type="text" id="code-input" placeholder="Nh·∫≠p M√£ R∆∞∆°ng" maxlength="4">
                   <button id="submitCodeBtn">X√ÅC NH·∫¨N M·ªû</button>` : 
                   `<button id="closeTreasureBtn" style="padding:12px 25px; font-size:1.2em; background:#f1c40f; color:#222; border:none; border-radius:8px; cursor:pointer; font-weight:bold; margin-top:15px;">ƒê√ìNG</button>`
              }
          </div>
      `;

      // G·∫Øn s·ª± ki·ªán M·ªû R∆Ø∆†NG (Ch·ªâ khi l√† giao di·ªán K·∫øt th√∫c)
      if (isFinal) {
          document.getElementById("submitCodeBtn").addEventListener('click', handleOpenTreasure);
      } else {
          // G·∫Øn s·ª± ki·ªán ƒê√ìNG (Khi m·ªü t·ª´ n√∫t M·ªû GIAO DI·ªÜN R∆Ø∆†NG B√ÅU)
          document.getElementById("closeTreasureBtn").addEventListener('click', showTreasureOverlay);
      }
  }


  // H√ÄM S·ª¨A: X·ª≠ l√Ω giao di·ªán th·∫Øng R∆∞∆°ng B√°u
  function winGame(winningTeam) {
      clearInterval(timerInterval); 
      document.getElementById("timer").style.display = "none";
      document.getElementById("endEarlyBtn").style.display = "none";
      
      // ·∫®n t·∫•t c·∫£ c√°c ƒë·ªôi c√≤n l·∫°i (d·ªçn giao di·ªán game)
      document.getElementById("game-wrapper").style.display="none";
      
      // Hi·ªÉn th·ªã giao di·ªán M·ªü R∆∞∆°ng (isFinal = true)
      renderTreasureOverlay(winningTeam, true); 
  }
  
  // H√ÄM S·ª¨A: K·∫øt th√∫c s·ªõm/H·∫øt gi·ªù (Chuy·ªÉn sang giao di·ªán R∆∞∆°ng B√°u nh∆∞ng kh√¥ng cho m·ªü)
  function endGame(){
      clearInterval(timerInterval);
      document.getElementById("timer").style.display="none";
      document.getElementById("endEarlyBtn").style.display="none";
      document.getElementById("game-wrapper").style.display="none"; // ·∫®n giao di·ªán game
      
      // TH√äM: ƒê·∫£m b·∫£o ·∫©n QR khi game k·∫øt th√∫c
      document.getElementById("qr-list").style.display="none"; 

      // Hi·ªÉn th·ªã giao di·ªán R∆∞∆°ng B√°u (kh√¥ng ph·∫£i k·∫øt th√∫c, isFinal = false)
      renderTreasureOverlay(null, false); 
      
      // ƒê·ªïi l·∫°i ti√™u ƒë·ªÅ cho ƒë√∫ng tr∆∞·ªùng h·ª£p h·∫øt gi·ªù
      document.getElementById("endOverlay").querySelector('h1').textContent = "üèÜ TR√í CH∆†I K·∫æT TH√öC üèÜ";
      document.getElementById("endOverlay").querySelector('h2').textContent = "H·∫øt gi·ªù! Xem ƒëi·ªÉm hi·ªán t·∫°i (C·∫ßn m√£ ƒë·ªÉ m·ªü r∆∞∆°ng).";
  }

  // H√ÄM S·ª¨A: Ch·ªâ hi·ªÉn th·ªã/·∫©n overlay R∆∞∆°ng B√°u ƒë·ªôc l·∫≠p
  function showTreasureOverlay() {
      const overlay = document.getElementById("endOverlay");
      const button = document.getElementById("showTreasureBtn");

      // Ki·ªÉm tra xem ch√∫ng ta ƒëang ·ªü Giao di·ªán 2 (game-wrapper ƒëang hi·ªÉn th·ªã) hay Giao di·ªán 1 (QR ƒëang hi·ªÉn th·ªã)
      const isGameActive = document.getElementById("game-wrapper").style.display === "block";

      if (isTreasureOverlayOpen) {
          // ƒê√≥ng Overlay
          overlay.style.display = "none";
          button.textContent = "M·ªû GIAO DI·ªÜN R∆Ø∆†NG B√ÅU";
          
          if (isGameActive) {
              // Kh√¥i ph·ª•c Giao di·ªán 2 (Game)
              if (timerInterval) { 
                document.getElementById("timer").style.display="block"; 
                document.getElementById("endEarlyBtn").style.display="block";
              }
              document.getElementById("submission-queue-area").style.display="block";
              document.getElementById("game-wrapper").style.display="block"; // ƒê·∫£m b·∫£o wrapper hi·ªÉn th·ªã
              
              // TH√äM: ƒê·∫£m b·∫£o ·∫©n QR khi quay l·∫°i giao di·ªán Game
              document.getElementById("qr-list").style.display="none"; 
          } else {
             // Kh√¥i ph·ª•c Giao di·ªán 1 (QR v√† N√∫t ch√≠nh)
             document.getElementById("main-controls").style.display="block";
             document.getElementById("qr-list").style.display="flex"; 
          }
          isTreasureOverlayOpen = false;
      } else {
          // M·ªü Overlay (T·∫°m ·∫©n t·∫•t c·∫£ c√°c giao di·ªán kh√°c)
          document.getElementById("game-wrapper").style.display="none";
          document.getElementById("main-controls").style.display="none"; 
          document.getElementById("qr-list").style.display="none"; // D√íNG N√ÄY ƒê·ªÇ ·∫®N KHI M·ªû OVERLAY

          // Hi·ªÉn th·ªã giao di·ªán R∆∞∆°ng B√°u
          renderTreasureOverlay(null, false); 
          
          button.textContent = "ƒê√ìNG GIAO DI·ªÜN R∆Ø∆†NG B√ÅU";
      }
  }

  // Logic c·∫≠p nh·∫≠t ƒë·ªôi
  function updateTeam(teamId, points, advanceQ = false) {
    const team = teams.find(t => t.id === teamId);
    if (team) {
      // 1. T√≠nh to√°n tr·∫°ng th√°i m·ªõi
      team.score += points;
      let newQ = team.currentQ;

      if (advanceQ) {
        newQ++;
        team.currentQ = newQ; // C·∫≠p nh·∫≠t tr·∫°ng th√°i c·ª•c b·ªô c·ªßa GV
        updateQuestionDisplay(team); 
      }
      
      // 2. C·∫≠p nh·∫≠t giao di·ªán GV
      document.getElementById(`score-${teamId}`).textContent = team.score;
      document.getElementById(`status-${teamId}`).textContent = team.currentQ;
      
      // 3. ƒê·ªíNG B·ªò L√äN FIREBASE (HS s·∫Ω ƒë·ªçc)
      updateTeamStatusOnFirebase(teamId, team.score, team.currentQ, team.questionOrder);

      // 4. Ki·ªÉm tra th·∫Øng cu·ªôc
      if (team.currentQ > WINNING_QUESTION) {
        team.score += TREASURE_BONUS; 
        document.getElementById(`score-${teamId}`).textContent = team.score; 
        updateTeamStatusOnFirebase(teamId, team.score, team.currentQ, team.questionOrder); 
        winGame(team); 
      }
    }
  }

  // ===================================================
  // H√ÄM: DUY·ªÜT T·ª∞ ƒê·ªòNG V√Ä ƒê·ªêI CHI·∫æU ƒê√ÅP √ÅN 
  // ===================================================
  window.autoApproveSubmission = async (docId, teamId, qIndexInOrder, actualQIndex, studentAnswer) => {
      try {
          const docRef = doc(db, "submissions", docId);
          
          // D√πng teamId v√† actualQIndex ƒë·ªÉ l·∫•y ƒë√°p √°n ch√≠nh x√°c
          const questionData = QUESTIONS[teamId].find(q => q.qIndex === actualQIndex);
          
          if (!questionData) {
              await deleteDoc(docRef);
              return;
          }
          const correctText = questionData.answer;
          
          const normalizedStudentAnswer = studentAnswer.trim().replace(/\s/g, '').toLowerCase(); 
          const normalizedCorrectAnswer = correctText.trim().replace(/\s/g, '').toLowerCase(); 
          
          let points = 0; 
          let advanceQ = false;
          let resultMessage = "SAI (0 ƒëi·ªÉm)";

          if (normalizedStudentAnswer === normalizedCorrectAnswer) {
              points = 10;
              advanceQ = true; 
              resultMessage = "ƒê√öNG (+10)";
          } 

          updateTeam(teamId, points, advanceQ);

          await deleteDoc(docRef);
          
          console.log(`Duy·ªát t·ª± ƒë·ªông: ƒê·ªôi ${teamId}, C√¢u th·ª±c t·∫ø ${actualQIndex}. K·∫øt qu·∫£: ${resultMessage}.`);

      } catch(e) {
          console.error("L·ªói khi duy·ªát y√™u c·∫ßu t·ª± ƒë·ªông:", e);
          alert("L·ªói khi x·ª≠ l√Ω y√™u c·∫ßu duy·ªát t·ª± ƒë·ªông. Xem console.");
      }
  };
  
  // ===================================================
  // H√ÄM: DUY·ªÜT B·ªé QUA 
  // ===================================================
  window.approveSkip = async (docId, teamId, actualQIndex) => {
      try {
          const docRef = doc(db, "submissions", docId);
          
          updateTeam(teamId, -10, true); 

          await deleteDoc(docRef);
          
          console.log(`Duy·ªát b·ªè qua: ƒê·ªôi ${teamId}. C√¢u th·ª±c t·∫ø ${actualQIndex}. K·∫øt qu·∫£: B·ªè qua (-10) v√† chuy·ªÉn c√¢u.`);

      } catch(e) {
          console.error("L·ªói khi duy·ªát y√™u c·∫ßu b·ªè qua:", e);
          alert("L·ªói khi x·ª≠ l√Ω y√™u c·∫ßu duy·ªát b·ªè qua. Xem console.");
      }
  };


  // H√†m t·∫°o HTML cho y√™u c·∫ßu duy·ªát r√∫t g·ªçn
  function renderSubmissionItem(doc) {
    const data = doc.data();
    const docId = doc.id;
    const team = teams.find(t => t.id === data.teamId);
    const teamName = team ? team.name.split(' ')[1] : '???'; 
    
    let label = '';
    let buttonsHTML = ''; 

    const actualQIndex = data.actualQuestionIndex;

    if (data.action === 'skip') {
      label = `${teamName}: B·ªé QUA`;
      buttonsHTML = `<button style="background:#e67e22;" onclick="approveSkip('${docId}', '${data.teamId}', '${actualQIndex}')">DUY·ªÜT B·ªé QUA (-10)</button>`;
    } else {
      label = `${teamName}: ${data.answer}`;
      buttonsHTML = `
          <button style="background:#3498db;" onclick="autoApproveSubmission('${docId}', '${data.teamId}', '${data.questionIndex}', '${actualQIndex}', '${data.answer}')">DUY·ªÜT T·ª∞ ƒê·ªòNG</button>
      `;
    }

    const div = document.createElement('div');
    div.className = 'submission-item';
    div.id = `sub-${docId}`;
    div.style.borderLeftColor = team ? teamColorMap[team.id] : '#f1c40f'; 
    div.style.alignItems = 'center';
    div.style.padding = '10px 8px';
    div.style.color = '#fff';
    div.style.textAlign = 'center';

    div.innerHTML = `
      <div style="font-size:1.2em; font-weight:bold; margin-bottom: 5px;">${label}</div>
      ${buttonsHTML}
    `;
    
    return div;
  }


  // H√†m l·∫Øng nghe submissions t·ª´ Firestore
  function listenForSubmissions() {
    const queueContainer = document.getElementById('submission-queue-area');
    const queueCountElement = document.getElementById('queue-count');
    
    const submissionQuery = query(
      collection(db, "submissions"),
      where("status", "==", "pending")
    );

    onSnapshot(submissionQuery, (snapshot) => {
      queueCountElement.textContent = snapshot.size; 

      snapshot.docChanges().forEach((change) => {
        const doc = change.doc;
        const docId = change.doc.id;
        const existingItem = document.getElementById(`sub-${docId}`);

        if (change.type === "added" && !existingItem) {
          const itemElement = renderSubmissionItem(doc);
          queueContainer.insertBefore(itemElement, queueContainer.children[1]); 
        } 
        else if (change.type === "removed" && existingItem) {
          existingItem.remove();
        }
      });
    });
  }

  // ============== LOGIC RESET D·ªÆ LI·ªÜU ==============
  async function resetGameData() {
      if (!confirm("‚ö†Ô∏è C·∫¢NH B√ÅO: Thao t√°c n√†y s·∫Ω X√ìA T·∫§T C·∫¢ y√™u c·∫ßu duy·ªát ƒë√°p √°n v√† tr·∫°ng th√°i ƒë·ªôi tr√™n Firebase. B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën RESET?")) {
          return;
      }
      
      const resetBtn = document.getElementById('resetBtn');
      resetBtn.disabled = true;
      resetBtn.textContent = "ƒêANG X√ìA...";

      try {
          // X√≥a submissions
          const subQuerySnapshot = await getDocs(collection(db, "submissions"));
          const deleteSubPromises = subQuerySnapshot.docs.map(doc => deleteDoc(doc.ref));
          
          // X√≥a team status
          const statusQuerySnapshot = await getDocs(collection(db, TEAM_STATUS_COLLECTION));
          const deleteStatusPromises = statusQuerySnapshot.docs.map(doc => deleteDoc(doc.ref));
          
          await Promise.all([...deleteSubPromises, ...deleteStatusPromises]);
          
          alert("‚úÖ ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu. T·∫£i l·∫°i trang ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i.");
          window.location.reload(); 
          
      } catch (e) {
          console.error("L·ªói khi reset d·ªØ li·ªáu:", e);
          alert("‚ùå L·ªñI: Kh√¥ng th·ªÉ reset d·ªØ li·ªáu. Xem console ƒë·ªÉ bi·∫øt chi ti·∫øt.");
      } finally {
          resetBtn.disabled = false;
          resetBtn.textContent = "üí£ RESET D·ªÆ LI·ªÜU";
      }
  }


  // === G·∫ÆN S·ª∞ KI·ªÜN CHO T·∫§T C·∫¢ C√ÅC N√öT ===
  document.addEventListener('DOMContentLoaded', () => {
    // 1. N√∫t B·∫ÆT ƒê·∫¶U V√íNG 3!
    const startBtn = document.getElementById("startBtn");
    if (startBtn) {
      startBtn.addEventListener('click', showGame);
    }
    
    // 2. N√∫t START (·ªü giao di·ªán 2)
    const startGameBtn = document.getElementById("startGameBtn");
    if (startGameBtn) {
        startGameBtn.addEventListener('click', startCountdown);
    }

    // 3. N√∫t RESET D·ªÆ LI·ªÜU
    const resetBtn = document.getElementById("resetBtn");
    if (resetBtn) {
        resetBtn.addEventListener('click', resetGameData);
    }

    // 4. N√∫t K·∫æT TH√öC S·ªöM
    const endEarlyBtn = document.getElementById("endEarlyBtn");
    if (endEarlyBtn) {
        endEarlyBtn.addEventListener('click', endGame);
    }

    // 5. N√∫t M·ªû GIAO DI·ªÜN R∆Ø∆†NG B√ÅU
    const showTreasureBtn = document.getElementById("showTreasureBtn");
    if (showTreasureBtn) {
        showTreasureBtn.addEventListener('click', showTreasureOverlay);
    }
  });

</script>
</body>
</html>
