<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GV - M·∫≠t M√£ R∆∞∆°ng B√°u</title>
  <style>
    :root{
      --bg:#0d1b2a;
      --card:#0f2740;
      --accent:#ffd166;
      --muted:#a0b0c0;
      --panel:#122436;
      --team-gap:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:#fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:18px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:14px;
    }
    h1{
      margin:0;
      font-size:1.6rem;
      color:var(--accent);
      letter-spacing:0.4px;
    }

    /* Setup screen (giao di·ªán 1) */
    #setupScreen{ text-align:center; padding:20px 10px; }
    #startMissionBtn{
      background:var(--accent);
      color:#000;
      border:0;
      padding:12px 20px;
      border-radius:10px;
      font-weight:700;
      font-size:1.05rem;
      cursor:pointer;
      margin-top:12px;
    }
    .qr-container{
      margin-top:18px;
      display:flex;
      justify-content:center;
      flex-wrap:wrap;
      gap:18px;
    }
    .qr-item{
      background:var(--card);
      padding:12px;
      border-radius:12px;
      width:160px;
      text-align:center;
      box-shadow:0 6px 18px rgba(0,0,0,0.5);
    }
    .qr-item canvas, .qr-item img{ display:block; margin:0 auto 8px auto; }

    /* Game interface (giao di·ªán 2) */
    #gameInterface{ display:none; margin-top:6px; }

    .top-controls{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }
    .left-controls{ display:flex; gap:10px; align-items:center; }
    .btn{
      background:var(--accent);
      color:#000;
      border:0;
      padding:8px 14px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
    }
    .countdown{
      font-size:1.35rem;
      background:#071427;
      padding:8px 12px;
      border-radius:10px;
      color:var(--accent);
      font-weight:800;
      min-width:110px;
      text-align:center;
    }

    .layout{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:16px;
      align-items:start;
    }

    /* teams area */
    .teams-area{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:var(--team-gap);
    }

    .team-card{
      background:var(--panel);
      border-radius:12px;
      padding:14px;
      min-height:180px;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      box-shadow:0 6px 18px rgba(0,0,0,0.45);
    }

    .team-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
    }
    .team-title{
      font-weight:800;
      font-size:1.05rem;
      text-transform:uppercase;
    }
    .team-score{
      font-weight:900;
      font-size:1.1rem;
      background:rgba(255,255,255,0.06);
      padding:6px 10px;
      border-radius:8px;
    }

    .question{
      font-size:2rem; /* Y√™u c·∫ßu: Hi·ªÉn th·ªã to r√µ */
      line-height:1.2;
      margin-bottom:10px;
      min-height:90px;
    }

    .q-buttons{
      display:flex;
      justify-content:center;
      gap:8px;
      margin-top:auto;
    }
    .q-buttons button{
      width:44px;
      height:44px;
      border-radius:50%;
      border:0;
      background:#274b67;
      color:#fff;
      font-weight:800;
      cursor:pointer;
    }
    .q-buttons button.active{
      background:var(--accent);
      color:#000;
    }

    /* pending column */
    .pending-column{
      background:var(--panel);
      padding:12px;
      border-radius:10px;
      max-height:76vh;
      overflow:auto;
      box-shadow:0 6px 18px rgba(0,0,0,0.35);
    }
    .pending-column h3{ margin:0 0 8px 0; color:var(--accent) }
    .pending-item{
      background:#14324a;
      padding:8px;
      border-radius:8px;
      margin-bottom:8px;
      font-size:0.95rem;
    }
    .controls-small{ display:flex; gap:8px; align-items:center; }

    /* responsive */
    @media (max-width:900px){
      .layout{ grid-template-columns: 1fr; }
      .teams-area{ grid-template-columns: 1fr; }
      .pending-column{ max-height:40vh; }
    }
  </style>
</head>
<body>
  <header>
    <h1>M·∫¨T M√É R∆Ø∆†NG B√ÅU: 05 ƒê·ªòI TRANH T√ÄI</h1>
    <div style="font-size:0.95rem;color:var(--muted)">GV Control Panel</div>
  </header>

  <section id="setupScreen">
    <div style="max-width:960px;margin:0 auto">
      <div style="display:flex;justify-content:center;gap:14px;align-items:center;flex-direction:column">
        <button id="startMissionBtn" aria-label="B·∫Øt ƒë·∫ßu Phi V·ª•">B·∫ÆT ƒê·∫¶U PHI V·ª§</button>
        <div style="color:var(--muted);margin-top:6px">H·ªçc sinh qu√©t m√£ QR ƒë·ªÉ v√†o giao di·ªán ƒë·ªôi</div>
      </div>

      <div class="qr-container" id="qrContainer" aria-live="polite"></div>
    </div>
  </section>

  <section id="gameInterface" class="hidden" aria-hidden="true">
    <div class="top-controls">
      <div class="left-controls">
        <button id="backToQR" class="btn">üîô Quay l·∫°i</button>
        <button id="startCountdownBtn" class="btn">‚ñ∂ B·∫ÆT ƒê·∫¶U ƒê·∫æM NG∆Ø·ª¢C</button>
        <button id="endEarlyBtn" class="btn">‚èπ T·ªîNG K·∫æT S·ªöM</button>
      </div>
      <div class="controls-small">
        <div class="countdown" id="countdown">10:00</div>
      </div>
    </div>

    <div class="layout">
      <div>
        <div class="teams-area" id="teamsGrid">
          </div>
      </div>

      <aside class="pending-column" id="pendingColumn" aria-live="polite">
        <h3>H√ÄNG CH·ªú DUY·ªÜT</h3>
        <div id="pendingList"></div>
      </aside>
    </div>
  </section>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script>
    // ===== Firebase config (gi·ªØ nguy√™n project c·ªßa b·∫°n) =====
    const firebaseConfig = {
      apiKey: "AIzaSyC9SRP8hEhtJ8bY2n1mTuPhtvpgMyZbktY",
      authDomain: "blackdesert2319-sudo.firebaseapp.com",
      projectId: "blackdesert2319-sudo",
      storageBucket: "blackdesert2319-sudo.appspot.com",
      messagingSenderId: "628771580196",
      appId: "1:628771580196:web:1e95f7f3c9de7e3e6cb36d"
    };

    // init
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== Teams config =====
    const teams = [
      { id: "red", name: "ƒê·ªôi ƒê·ªè", color: "#e63946" },
      { id: "blue", name: "ƒê·ªôi Xanh", color: "#1d3557" },
      { id: "green", name: "ƒê·ªôi L√°", color: "#2a9d8f" },
      { id: "yellow", name: "ƒê·ªôi V√†ng", color: "#f4a261" },
      { id: "purple", name: "ƒê·ªôi T√≠m", color: "#9d4edd" }
    ];

    // ===== Base questions (ƒë·ªÅ g·ªëc, 7 c√¢u) =====
    const questions = [
      "Cho c·∫•p s·ªë c·ªông c√≥ u‚ÇÅ = 2, c√¥ng sai d = 3. T√¨m u‚ÇÖ.",
      "Cho c·∫•p s·ªë c·ªông 5, 8, 11, ... T√≠nh s·ªë h·∫°ng th·ª© 10.",
      "Cho c·∫•p s·ªë nh√¢n c√≥ u‚ÇÅ = 3, q = 2. T√¨m u‚ÇÖ.",
      "Cho c·∫•p s·ªë nh√¢n 2, 6, 18, ... T√¨m c√¥ng b·ªôi q.",
      "Cho c·∫•p s·ªë c·ªông c√≥ 7 s·ªë h·∫°ng, t·ªïng l√† 35, u‚ÇÅ = 2. T√¨m c√¥ng sai d.",
      "Cho c·∫•p s·ªë nh√¢n c√≥ 5 s·ªë h·∫°ng, u‚ÇÅ = 2, u‚ÇÖ = 32. T√¨m q.",
      "Cho c·∫•p s·ªë c·ªông 4, 7, 10, ... T√¨m s·ªë h·∫°ng th·ª© 12."
    ];

    // ===== Correct answers t∆∞∆°ng ·ª©ng (chu·∫©n ƒë·ªÉ so s√°nh, string d·∫°ng kh√¥ng d·∫•u) =====
    const correctAnswers = ["14","32","48","3","5","2","37"];

    // ===== Question order: m·ªói ƒë·ªôi c√≥ 1 ho√°n v·ªã ri√™ng (0-based indices c·ªßa questions[]) =====
    const questionOrder = {
      red:    [0,1,2,3,4,5,6],
      blue:   [2,5,0,3,1,6,4],
      green:  [4,2,6,0,1,5,3],
      yellow: [1,3,5,2,0,4,6],
      purple: [6,0,4,1,3,2,5]
    };

    // State: ƒëi·ªÉm & currentQuestion per team (index into their own order)
    const teamScores = { red:0, blue:0, green:0, yellow:0, purple:0 };
    // Kh·ªüi t·∫°o ban ƒë·∫ßu t·ª´ Firebase (s·∫Ω ƒë∆∞·ª£c l·∫Øng nghe)
    const currentQuestion = { red:0, blue:0, green:0, yellow:0, purple:0 };

    // DOM refs
    const qrContainer = document.getElementById("qrContainer");
    const startMissionBtn = document.getElementById("startMissionBtn");
    const setupScreen = document.getElementById("setupScreen");
    const gameInterface = document.getElementById("gameInterface");
    const teamsGrid = document.getElementById("teamsGrid");
    const startCountdownBtn = document.getElementById("startCountdownBtn");
    const endEarlyBtn = document.getElementById("endEarlyBtn");
    const countdownEl = document.getElementById("countdown");
    const pendingList = document.getElementById("pendingList");
    const backToQR = document.getElementById("backToQR");

    // ensure DOM loaded
    window.addEventListener('load', () => {
      generateQRCodes();
      renderTeams();
      attachEvents();
      listenControlState(); 
      listenSubmissionsRealtime();
      listenTeamStateRealtime(); // Nghe tr·∫°ng th√°i ƒë·ªôi (ƒëi·ªÉm v√† Q index)
      updateAllDisplays();
    });

    // ========== Generate QR codes ==========
    function generateQRCodes(){
      qrContainer.innerHTML = '';
      teams.forEach(team=>{
        const box = document.createElement('div');
        box.className = 'qr-item';
        const canvas = document.createElement('canvas');
        const url = `${window.location.origin}/25-c-u/hs.html?teamId=${team.id}`;
        // generate canvas QR (QRCode lib)
        QRCode.toCanvas(canvas, url, { width: 140 }).then(()=>{}).catch(()=>{});
        const label = document.createElement('div');
        label.textContent = team.name;
        label.style.marginTop='6px';
        label.style.fontWeight='700';
        label.style.color = team.color;
        box.appendChild(canvas);
        box.appendChild(label);
        qrContainer.appendChild(box);
      });
    }

    // ========== Render teams on GV ==========
    function renderTeams(){
      teamsGrid.innerHTML = '';
      teams.forEach(team=>{
        const card = document.createElement('div');
        card.className = 'team-card';
        card.id = `card-${team.id}`;
        card.innerHTML = `
          <div class="team-top">
            <div class="team-title" style="color:${team.color}">${team.name}</div>
            <div class="team-score" id="score-${team.id}">0</div>
          </div>
          <div class="question" id="question-${team.id}">C√¢u h·ªèi s·∫Ω hi·ªán khi b·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c...</div>
          <div class="q-buttons" id="btns-${team.id}">
            ${[1,2,3,4,5,6,7].map(n=>`<button data-num="${n}">${n}</button>`).join('')}
          </div>
        `;
        teamsGrid.appendChild(card);
      });
      // set button active for each team's current index
      updateAllDisplays();
    }

    // ========== Attach UI events ==========
    function attachEvents(){
      startMissionBtn.addEventListener('click', () => {
        // chuy·ªÉn sang giao di·ªán ch∆°i
        setupScreen.style.display = 'none';
        gameInterface.style.display = 'block';
        gameInterface.removeAttribute('aria-hidden');
        // ensure teams render
        renderTeams();
      });

      backToQR.addEventListener('click', () => {
        gameInterface.style.display = 'none';
        setupScreen.style.display = 'block';
      });

      startCountdownBtn.addEventListener('click', async () => {
        // set startGame flag in Firestore
        try{
          await db.collection('control').doc('state').set({ startGame: true, startedAt: new Date() });
          // Kh·ªüi t·∫°o tr·∫°ng th√°i c√¢u h·ªèi ban ƒë·∫ßu cho c√°c ƒë·ªôi
          teams.forEach(t => {
            db.collection('teamState').doc(t.id).set({ currentQIndex: 0, score: 0 }, { merge: true }).catch(console.error);
          });
        }catch(e){ console.error(e) }
        startCountdown(); // local UI countdown
        updateAllDisplays();
      });

      endEarlyBtn.addEventListener('click', async () => {
        // stop the game
        clearInterval(countdownTimer);
        try{ await db.collection('control').doc('state').set({ startGame: false }); }catch(e){console.error(e)}
        alert('ƒê√£ k·∫øt th√∫c v√≤ng ch∆°i.');
        updateAllDisplays();
      });
    }

    // ========== Countdown logic ==========
    let countdownTimer = null;
    let timeLeft = 10*60; // seconds

    function startCountdown(){
      clearInterval(countdownTimer);
      timeLeft = 10*60;
      updateCountdownUI();
      countdownTimer = setInterval(()=>{
        timeLeft--;
        updateCountdownUI();
        if(timeLeft<=0){
          clearInterval(countdownTimer);
          alert('‚è∞ H·∫øt gi·ªù!');
          // set startGame false
          db.collection('control').doc('state').set({ startGame: false }).catch(()=>{});
        }
      },1000);
    }
    function updateCountdownUI(){
      const m = Math.floor(timeLeft/60);
      const s = timeLeft%60;
      countdownEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    // ========== Listen to control state changes (so GV view reflects external updates) ==========
    function listenControlState(){
      db.collection('control').doc('state').onSnapshot(doc=>{
        const data = doc.data();
        if(!data) return;
        
        if(data.startGame){
          // C·∫≠p nh·∫≠t text c√¢u h·ªèi d·ª±a tr√™n currentQuestion[] (ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª´ listenTeamStateRealtime)
          teams.forEach(t=>{
            const idx = currentQuestion[t.id];
            const globalIdx = questionOrder[t.id][idx];
            const qText = questions[globalIdx] || "ƒê√£ ho√†n th√†nh to√†n b·ªô c√¢u h·ªèi!";
            const qEl = document.getElementById(`question-${t.id}`);
            if(qEl) qEl.textContent = qText;
          });
          updateAllDisplays();
        } else {
          // game stopped
          teams.forEach(t=>{
            const qEl = document.getElementById(`question-${t.id}`);
            if(qEl) qEl.textContent = 'C√¢u h·ªèi s·∫Ω hi·ªán khi b·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c...';
          });
        }
      });
    }
    
    // ========== Listen to Team State changes (ƒëi·ªÉm s·ªë, v·ªã tr√≠ c√¢u h·ªèi) ==========
    function listenTeamStateRealtime() {
        teams.forEach(team => {
            db.collection('teamState').doc(team.id).onSnapshot(doc => {
                const data = doc.data();
                if (data) {
                    // C·∫≠p nh·∫≠t ƒëi·ªÉm v√† ch·ªâ s·ªë c√¢u h·ªèi v√†o state c·ª•c b·ªô c·ªßa GV
                    teamScores[team.id] = data.score !== undefined ? data.score : (teamScores[team.id] || 0);
                    currentQuestion[team.id] = data.currentQIndex !== undefined ? data.currentQIndex : (currentQuestion[team.id] || 0);
                    
                    // C·∫≠p nh·∫≠t giao di·ªán GV
                    updateTeamDisplay(team.id);
                }
            });
        });
    }

    // ========== Submissions listener (real-time) ==========
    function listenSubmissionsRealtime(){
      db.collection('submissions').orderBy('timestamp','asc')
        .onSnapshot(snapshot=>{
          snapshot.docChanges().forEach(change=>{
            if(change.type === 'added'){
              const docData = change.doc.data();
              const docId = change.doc.id;
              displayPending(docData, docId);
              // Ph·∫£i d√πng setTimeout ƒë·ªÉ ch·ªù logic hi·ªÉn th·ªã pending (n·∫øu c·∫ßn) v√† tr√°nh race condition
              // T√πy theo t·ªëc ƒë·ªô m·∫°ng, c√≥ th·ªÉ x·ª≠ l√Ω submission ngay, nh∆∞ng c·∫ßn ƒë·∫£m b·∫£o logic FireStore
              processSubmission(docData, docId); 
            }
          });
        });
    }

    function displayPending(data, docId){
      const div = document.createElement('div');
      div.className = 'pending-item';
      const team = teams.find(t=>t.id===data.teamId);
      const tm = team?team.name:data.teamId;
      // L·∫•y ch·ªâ s·ªë c√¢u h·ªèi t·ª´ Submission, n·∫øu kh√¥ng c√≥ th√¨ d√πng currentQuestion c·ª•c b·ªô
      const qPos = (typeof data.questionIndex === 'number') ? data.questionIndex : (currentQuestion[data.teamId] || 0);
      const qi = qPos + 1;
      const ts = data.timestamp && data.timestamp.toDate ? data.timestamp.toDate().toLocaleTimeString('vi-VN') : '';
      div.innerHTML = `<strong>${tm}</strong><div>C√¢u ${qi}: ${escapeHtml(String(data.answer||''))}</div><div style="font-size:0.85rem;color:var(--muted)">${ts}</div>`;
      // prepend
      pendingList.prepend(div);
      // keep limited items
      while(pendingList.children.length > 80) pendingList.removeChild(pendingList.lastChild);
    }

    // ========== Process submission ==========
    async function processSubmission(data, docId){
      try{
        const teamId = data.teamId;
        const answerRaw = (data.answer||'').toString().trim().toLowerCase();
        
        // Lu√¥n s·ª≠ d·ª•ng index c·ªßa submission ƒë·ªÉ so s√°nh ch√≠nh x√°c c√¢u h·ªèi HS v·ª´a tr·∫£ l·ªùi
        const qPos = (typeof data.questionIndex === 'number') ? data.questionIndex : (currentQuestion[teamId] || 0);

        // Map qPos (v·ªã tr√≠ trong d√£y) ƒë·∫øn global index (v·ªã tr√≠ trong questions[])
        const globalIdx = (questionOrder[teamId] && questionOrder[teamId][qPos] !== undefined) ? questionOrder[teamId][qPos] : questionOrder['red'][qPos];
        const correct = (correctAnswers[globalIdx]||'').toLowerCase();
        
        // Logic t√≠nh ƒëi·ªÉm v√† chuy·ªÉn c√¢u
        let newScore = teamScores[teamId];
        let newQIndex = currentQuestion[teamId];

        if(qPos === currentQuestion[teamId]){ // Ch·ªâ x·ª≠ l√Ω submission n·∫øu n√≥ l√† cho c√¢u hi·ªán t·∫°i c·ªßa ƒë·ªôi
             if(answerRaw === 'skip'){
                newScore = (newScore || 0) - 10;
                newQIndex = Math.min(questions.length, (newQIndex || 0) + 1); // Max index l√† 7 (sau 7 c√¢u)
                notify(`${getTeamName(teamId)} ƒë√£ b·ªè qua c√¢u ${qPos+1} (-10ƒë)`);
            } else if(answerRaw === correct){
                newScore = (newScore || 0) + 10;
                newQIndex = Math.min(questions.length, (newQIndex || 0) + 1);
                notify(`${getTeamName(teamId)} tr·∫£ l·ªùi ƒë√∫ng (+10ƒë)`);
            } else {
                notify(`${getTeamName(teamId)} tr·∫£ l·ªùi sai.`);
                // do not advance
            }
            
            // C·∫≠p nh·∫≠t v√†o state c·ª•c b·ªô
            teamScores[teamId] = newScore;
            currentQuestion[teamId] = newQIndex;

            // *** QUAN TR·ªåNG: C·∫≠p nh·∫≠t state l√™n Firestore ƒë·ªÉ HS ƒë·ªìng b·ªô ***
            await db.collection('teamState').doc(teamId).set({ 
                score: newScore,
                currentQIndex: newQIndex,
                timestamp: new Date()
            }, { merge: true });

        } else {
            notify(`${getTeamName(teamId)} g·ª≠i ƒë√°p √°n c≈©/tr·ªÖ cho c√¢u ${qPos+1}. B·ªè qua x·ª≠ l√Ω.`);
        }
        
        // update UI (s·∫Ω ƒë∆∞·ª£c k√≠ch ho·∫°t b·ªüi listenTeamStateRealtime)
        // updateTeamDisplay(teamId); 

      }catch(e){
        console.error('processSubmission error',e);
      }finally{
        // remove submission doc to avoid reprocessing
        try{ await db.collection('submissions').doc(docId).delete(); }catch(e){console.error(e)}
      }
    }

    // helpers
    function getTeamName(id){ const t=teams.find(x=>x.id===id); return t? t.name : id; }
    function notify(msg){ console.log(msg); /* optionally show UI toast */ }

    function updateTeamDisplay(teamId){
      // update score
      const scoreEl = document.getElementById(`score-${teamId}`);
      if(scoreEl) scoreEl.textContent = (teamScores[teamId]||0);
      
      // update question text according to currentQuestion and questionOrder
      const qEl = document.getElementById(`question-${teamId}`);
      const qIdx = currentQuestion[teamId] || 0;
      
      let qText;
      let globalIdx;
      
      if (qIdx >= questions.length) {
          qText = "ƒê√£ ho√†n th√†nh to√†n b·ªô c√¢u h·ªèi!";
          globalIdx = -1; // ƒê√°nh d·∫•u ƒë√£ ho√†n th√†nh
      } else {
          // L·∫•y global index t·ª´ ho√°n v·ªã c·ªßa ƒë·ªôi
          globalIdx = (questionOrder[teamId] && questionOrder[teamId][qIdx] !== undefined) ? questionOrder[teamId][qIdx] : questionOrder['red'][qIdx];
          qText = questions[globalIdx];
      }
      
      if(qEl){
        qEl.textContent = qText;
      }
      
      // update active button
      const btns = document.querySelectorAll(`#btns-${teamId} button`);
      btns.forEach((b,i)=>{
        if(i === qIdx) b.classList.add('active'); else b.classList.remove('active');
      });
    }

    function updateAllDisplays(){
      teams.forEach(t=>updateTeamDisplay(t.id));
    }

    // Escape HTML for safety in pending display
    function escapeHtml(str){
      return str.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
    }
  </script>
</body>
</html>

