<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M·∫≠t M√£ R∆∞∆°ng B√°u - GV (S·ª≠a Logic ƒêi·ªÉm)</title>

<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
<script>
window.MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
  svg: { fontCache: 'global' }
};
</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>
body {
  font-family:'Arial',sans-serif;
  background:#1e1e1e;
  color:#fff;
  margin:0;
  padding:0;
  overflow-x:hidden;
}
h1 { color:#f1c40f; margin:12px 0; text-align:center; }
#timer {
  position:fixed;
  top:8px; left:12px;
  font-size:2.2em; font-weight:bold;
  color:#e74c3c; background:#f1c40f;
  padding:4px 12px; border-radius:8px;
  display:none;
  z-index:10;
}
#endEarlyBtn {
  position:fixed;
  top:15px; left:130px;
  font-size:1.1em;
  background:#e67e22;
  color:white;
  border:none;
  border-radius:8px;
  padding:6px 14px;
  font-weight:bold;
  cursor:pointer;
  display:none;
  z-index:10;
}

/* === QR ·ªü giao di·ªán ƒë·∫ßu === */
#qr-list {
  display:flex !important;
  flex-wrap:wrap;
  justify-content:center;
  align-items:center;
  gap:12px;
  margin-top:20px;
}
.qr-item {
  width:180px;
  margin:10px;
  padding:10px;
  border-radius:8px;
  background:white;
  color:#333;
  text-align:center;
  font-weight:bold;
  border: 2px solid transparent;
}
.qr-item img {
  width:150px; height:150px;
  border:2px solid transparent;
  margin-bottom:5px;
}
.qr-item.team-red {
    border-color: #e74c3c; /* ƒê·ªè */
}
.qr-item.team-blue {
    border-color: #3498db; /* Xanh Lam */
}
.qr-item.team-green {
    border-color: #2ecc71; /* Xanh L·ª•c */
}
.qr-item.team-yellow {
    border-color: #f1c40f; /* V√†ng */
}
.qr-item.team-purple {
    border-color: #9b59b6; /* T√≠m */
}

/* === GIAO DI·ªÜN 2 === */
#game-wrapper { display:none; position:relative; }
.game-layout {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: flex-start;
  width: 100%;
  margin: 0;
  padding: 0 10px;
  box-sizing: border-box;
}

/* C·ªôt tr√°i: c√°c ƒë·ªôi */
#team-rows-container {
  flex: 1;
  margin-right: 15px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
}

/* C·ªôt ph·∫£i: h√†ng ƒë·ª£i */
#submission-queue-area {
  width: 140px; 
  background: #34495e;
  border-radius: 10px;
  padding: 8px;
  height: calc(100vh - 40px);
  overflow-y: auto;
  position: fixed;
  right: 0;
  top: 0;
}
#submission-queue-area h2 {
  font-size: 1em;
  text-align: center;
  color: #fff;
  margin-bottom: 10px;
}
/* CSS cho B·ªô ƒë·∫øm */
#queue-count {
  background: #e74c3c; /* ƒê·ªè */
  padding: 2px 8px;
  border-radius: 5px;
  font-size: 1em;
  font-weight: bold;
}

/* === KHUNG M·ªñI ƒê·ªòI === */
.team-row {
  display:flex;
  align-items:center;
  justify-content:flex-start;
  width:100%;
  padding:8px 18px;
  border-radius:10px;
  box-shadow:0 2px 5px rgba(0,0,0,0.4);
  min-height:95px;
}
.team-red{background:#e74c3c;}
.team-blue{background:#3498db;}
.team-green{background:#2ecc71;}
.team-yellow{background:#f1c40f;color:#333;}
.team-purple{background:#9b59b6;}

.team-score-control {
  width:160px;
  display:flex;
  flex-direction:row;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.team-score-value {
  font-size:2.5em;
  font-weight:900;
  background:rgba(255,255,255,0.25);
  padding:2px 12px;
  border-radius:8px;
}
.q-status-item {
  width:36px;
  height:36px;
  border-radius:50%;
  font-size:1.1em;
  font-weight:bold;
  color:white;
  background:#2980b9;
  display:flex;
  justify-content:center;
  align-items:center;
}

/* KHU V·ª∞C HI·ªÇN TH·ªä C√ÇU H·ªéI HI·ªÜN T·∫†I */
.team-question-area {
  flex:1;
  padding-left:20px;
  display:none; /* ·∫©n tr∆∞·ªõc khi start */
}
.question-title {
  font-size: 1.8em; /* TƒÉng c·ª° ch·ªØ ƒë·ªÉ hi·ªÉn th·ªã n·ªôi dung c√¢u h·ªèi */
  font-weight: 700;
  line-height: 1.3;
  color: #ffffff; 
}
.answer-text {
  display:none; /* ·∫®n ƒë√°p √°n m·∫´u */
}

/* H√†ng ƒë·ª£i duy·ªát ƒë√°p √°n (CSS cho m·ª•c r√∫t g·ªçn) */
.submission-item {
  padding:8px;
  margin-bottom:8px;
  background:#2c3e50;
  border-radius:6px;
  display:flex;
  flex-direction:column;
  align-items:center;
  border-left:4px solid #f1c40f;
  text-align:center;
}
.submission-item button {
  padding:5px 10px;
  color:white;
  border:none;
  border-radius:5px;
  font-weight:bold;
  font-size:0.9em;
  cursor:pointer;
  width: 90%;
  margin-top: 5px;
}

/* START BUTTON */
#startGameBtn {
  position:absolute;
  top:0px; 
  left:100px;
  transform:translate(-50%, -50%);
  font-size:2em;
  padding:14px 30px;
  border:none;
  border-radius:10px;
  background:#2ecc71;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
  display:none;
  z-index:10;
}

/* OVERLAY K·∫æT TH√öC */
#endOverlay {
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(241,196,15,0.9);
  color:#000;
  z-index:20;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  text-align:center;
}
#endOverlay h1 {
  font-size:3em;
  margin-bottom:20px;
}
#endOverlay .scoreboard {
  font-size:2em;
  line-height:1.5;
  font-weight:bold;
}

/* CSS cho N√∫t Reset */
#resetBtn {
    font-size: 1.2em;
    padding: 12px 22px;
    background: #e74c3c; 
    color: #fff;
    border: none;
    border-radius: 8px;
    margin: 20px 5px; 
    font-weight: bold;
    cursor: pointer;
}
</style>
</head>

<body>
  <h1>CHI·∫æN TH·∫ÆNG KHI HO√ÄN TH√ÄNH 7 C√ÇU H·ªéI NHANH NH·∫§T</h1>
  <div id="qr-list"></div>

  <div style="text-align:center;">
    <button id="startBtn" style="padding:12px 22px;font-size:1.2em;background:#f1c40f;color:#222;border:none;border-radius:8px;margin:20px 5px;font-weight:bold;cursor:pointer;">
      B·∫ÆT ƒê·∫¶U V√íNG 3!
    </button>
    <button id="resetBtn">
      üí£ RESET D·ªÆ LI·ªÜU
    </button>
  </div>
  <div id="game-wrapper">
    <div id="timer">10:00</div>
    <button id="endEarlyBtn">K·∫æT TH√öC S·ªöM</button>
    <button id="startGameBtn">START</button>
    <div class="game-layout">
      <div id="team-rows-container"></div>
      <div id="submission-queue-area">
        <h2>H√ÄNG ƒê·ª¢I DUY·ªÜT ƒê√ÅP √ÅN (<span id="queue-count">0</span>)</h2>
      </div>
    </div>
  </div>

  <div id="endOverlay">
    <h1>üèÜ TR√í CH∆†I K·∫æT TH√öC üèÜ</h1>
    <div class="scoreboard" id="finalScores"></div>
  </div>

<script type="module">
  // B. Th√™m Imports v√† Config Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getFirestore, collection, query, where, onSnapshot, doc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // === C·∫§U H√åNH FIREBASE ===
  const firebaseConfig = {
    apiKey: "AIzaSyDfcMrblRonAS9Q7BSfD9ZZYeOmSy4UjfQ",
    authDomain: "nutnhap.firebaseapp.com",
    projectId: "nutnhap",
    storageBucket: "nutnhap.firebasestorage.app",
    messagingSenderId: "359344838873",
    appId: "1:359344838873:web:d1746d32920881091c86c8",
    measurementId: "G-0VTTNLWDD9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);


  // D1. M·∫£ng ƒë·ªôi
  const teams = [
    { name: "ƒê·ªôi ƒê·ªè", color: "team-red", id: "red", score: 0, currentQ: 1 },
    { name: "ƒê·ªôi Xanh", color: "team-blue", id: "blue", score: 0, currentQ: 1 },
    { name: "ƒê·ªôi L·ª•c", color: "team-green", id: "green", score: 0, currentQ: 1 },
    { name: "ƒê·ªôi V√†ng", color: "team-yellow", id: "yellow", score: 0, currentQ: 1 },
    { name: "ƒê·ªôi T√≠m", color: "team-purple", id: "purple", score: 0, currentQ: 1 }
  ];

  // ==========================================================
  // M·∫¢NG C√ÇU H·ªéI V√Ä ƒê√ÅP √ÅN ƒê√öNG M·∫™U
  // L∆ØU √ù: ƒê√°p √°n ph·∫£i l√† CHU·ªñI S·ªê (String of Number) v√† KH√îNG CH·ª®A b·∫•t k·ª≥ k√Ω t·ª± n√†o kh√°c.
  const QUESTIONS = [
    { text: "Cho CSC c√≥ $u_1=3$, $d=2$. T√¨m $u_{10}$", answer: "1" }, 
    { text: "T√≠nh t·ªïng 1 + 2 + ... + 10", answer: "2" }, 
    { text: "K·∫øt qu·∫£ ph√©p t√≠nh 15 x 3", answer: "3" }, 
    { text: "NƒÉm sinh c·ªßa H·ªì Ch√≠ Minh", answer: "4" }, 
    { text: "S·ªë ng√†y trong 3 th√°ng li√™n ti·∫øp kh√¥ng c√≥ th√°ng 2", answer: "5" }, 
    { text: "S·ªë nguy√™n t·ªë nh·ªè nh·∫•t", answer: "6" }, 
    { text: "K·∫øt qu·∫£ c·ªßa 5! (5 giai th·ª´a)", answer: "7" }
  ];
  // ==========================================================

  // √Ånh x·∫° c√°c class m√†u CSS sang m√£ m√†u Hex cho n·ªÅn QR
  const teamColorMap = {
      'team-red': '#f8d7da',        
      'team-blue': '#d0e0f0',       
      'team-yellow': '#fff3cd',      
      'team-green': '#d4edda',       
      'team-purple': '#e8d9ef'       
  };

  // H·∫∞NG S·ªê GAME
  const TREASURE_BONUS = 30; 
  const WINNING_QUESTION = QUESTIONS.length; 
  let timerInterval;
  let totalSeconds = 600; // 10 ph√∫t

  window.onload = function() {
    const qrList = document.getElementById("qr-list");
    qrList.innerHTML = "";
    const baseURL = location.href.replace(/[^/]*$/, "") + "hs.html";
    teams.forEach(team => {
      const div = document.createElement("div");
      div.className = "qr-item " + team.color; 
      div.innerHTML = `<div>${team.name}</div><div id="qr-${team.id}"></div>`;
      qrList.appendChild(div);
      new QRCode(document.getElementById("qr-" + team.id), {
        text: `${baseURL}?teamId=${team.id}`,
        width: 150,
        height: 150
      });
    });
  };

  function showGame(){
    const qrList = document.getElementById("qr-list");
    if (qrList) qrList.remove();

    const buttonContainer = document.querySelector('div[style="text-align:center;"]');
    if (buttonContainer) buttonContainer.style.display = "none";

    document.getElementById("game-wrapper").style.display="block";
    renderTeams();
    document.getElementById("startGameBtn").style.display="block";
    
    listenForSubmissions();
  }


  function renderTeams(){
    const container = document.getElementById("team-rows-container");
    container.innerHTML = "";
    teams.forEach(team=>{
      const row=document.createElement("div");
      row.className=`team-row ${team.color}`;
      
      const questionData = QUESTIONS[team.currentQ - 1];
      const questionText = questionData ? questionData.text : "HO√ÄN TH√ÄNH!";
      
      row.innerHTML=`
        <div class="team-score-control">
          <div class="team-score-value" id="score-${team.id}">${team.score}</div>
          <div class="q-status-item" id="status-${team.id}">${team.currentQ}</div>
        </div>
        <div class="team-question-area" id="qarea-${team.id}">
            <div class="question-title" id="q-title-${team.id}">${questionText}</div>
        </div>
      `;
      container.appendChild(row);
    });
  }

  // H√ÄM: C·∫≠p nh·∫≠t ch·ªâ hi·ªÉn th·ªã c√¢u h·ªèi
  function updateQuestionDisplay(team) {
      const qTitleElement = document.getElementById(`q-title-${team.id}`);
      
      if (qTitleElement) {
          // L·∫•y c√¢u h·ªèi c·ªßa c√¢u h·ªèi M·ªöI (currentQ)
          const questionData = QUESTIONS[team.currentQ - 1];
          const questionText = questionData ? questionData.text : "HO√ÄN TH√ÄNH!";
          qTitleElement.textContent = questionText;
      }
      MathJax.typeset();
  }


  function startCountdown(){
    document.getElementById("startGameBtn").style.display="none";
    document.getElementById("timer").style.display="block";
    document.getElementById("endEarlyBtn").style.display="block";
    document.querySelectorAll('.team-question-area').forEach(el=>el.style.display='block'); 
    MathJax.typeset();
    timerInterval = setInterval(updateTimer,1000);
  }

  function updateTimer(){
    const min = Math.floor(totalSeconds/60);
    const sec = totalSeconds%60;
    document.getElementById("timer").textContent = `${min}:${sec.toString().padStart(2,'0')}`;
    if(totalSeconds <= 0){
      clearInterval(timerInterval);
      endGame();
    }
    if(totalSeconds <= 10){
      document.getElementById("timer").style.background="#e74c3c";
    }
    totalSeconds--;
  }

  // H√ÄM: X·ª≠ l√Ω giao di·ªán th·∫Øng R∆∞∆°ng B√°u
  function winGame(winningTeam) {
    clearInterval(timerInterval); 
    document.getElementById("timer").style.display = "none";
    document.getElementById("endEarlyBtn").style.display = "none";
    
    const overlay = document.getElementById("endOverlay");
    
    overlay.style.display = "flex";
    overlay.style.backgroundColor = 'rgba(255, 215, 0, 0.95)'; 
    overlay.style.color = '#e74c3c'; 
    
    overlay.innerHTML = `
      <h1>üèÜ ${winningTeam.name} ƒê√É GI√ÄNH CHI·∫æN TH·∫ÆNG üèÜ</h1>
      <h2>üéâ ƒê∆Ø·ª¢C TH∆Ø·ªûNG TH√äM ${TREASURE_BONUS} ƒêI·ªÇM R∆Ø∆†NG B√ÅU! üéâ</h2>
      <div class="scoreboard" id="finalScores" style="color: #333;">
        ƒêi·ªÉm cu·ªëi c√πng: ${winningTeam.score}
      </div>
    `;
  }
  
  // H√ÄM: K·∫øt th√∫c s·ªõm/H·∫øt gi·ªù
  function endGame(){
    clearInterval(timerInterval);
    document.getElementById("timer").style.display="none";
    document.getElementById("endEarlyBtn").style.display="none";
    const overlay=document.getElementById("endOverlay");
    
    overlay.style.backgroundColor = 'rgba(241,196,15,0.9)'; 
    overlay.style.color = '#000';
    overlay.style.display="flex";
    
    overlay.innerHTML = `
      <h1>üèÜ TR√í CH∆†I K·∫æT TH√öC üèÜ</h1>
      <div class="scoreboard" id="finalScores"></div>
    `;

    let scoreHTML="K·∫øt qu·∫£ chung cu·ªôc:<br>";
    teams.forEach(t=>{
      const score = document.getElementById(`score-${t.id}`).textContent;
      scoreHTML += `${t.name}: ${score} ƒëi·ªÉm<br>`;
    });
    document.getElementById("finalScores").innerHTML=scoreHTML;
  }
  
  // Logic c·∫≠p nh·∫≠t ƒë·ªôi
  function updateTeam(teamId, points, advanceQ = false) {
    const team = teams.find(t => t.id === teamId);
    if (team) {
      team.score += points;
      
      // N·∫øu ƒë√°p √°n ƒë√∫ng HO·∫∂C y√™u c·∫ßu chuy·ªÉn c√¢u (advanceQ = true)
      if (advanceQ) {
        team.currentQ++;
        updateQuestionDisplay(team); 
      }
      
      // C·∫≠p nh·∫≠t giao di·ªán
      document.getElementById(`score-${teamId}`).textContent = team.score;
      document.getElementById(`status-${teamId}`).textContent = team.currentQ;
      
      // Ki·ªÉm tra th·∫Øng cu·ªôc (7 c√¢u)
      if (team.currentQ > WINNING_QUESTION) {
        team.score += TREASURE_BONUS; 
        document.getElementById(`score-${teamId}`).textContent = team.score; 
        winGame(team); 
      }
    }
  }

  // ===================================================
  // H√ÄM: DUY·ªÜT T·ª∞ ƒê·ªòNG V√Ä ƒê·ªêI CHI·∫æU ƒê√ÅP √ÅN (T·ªëi ∆∞u cho S·ªê NGUY√äN)
  // Logic: ƒê√öNG -> +10, chuy·ªÉn c√¢u. SAI -> 0 ƒëi·ªÉm, KH√îNG chuy·ªÉn c√¢u.
  // ===================================================
  window.autoApproveSubmission = async (docId, teamId, qIndex, studentAnswer) => {
      try {
          const docRef = doc(db, "submissions", docId);
          const questionData = QUESTIONS[parseInt(qIndex) - 1];
          if (!questionData) {
              console.error("L·ªói: Kh√¥ng t√¨m th·∫•y ƒë√°p √°n cho c√¢u h·ªèi n√†y.");
              await deleteDoc(docRef);
              return;
          }
          const correctText = questionData.answer;
          
          // Chu·∫©n h√≥a ƒë√°p √°n (ch·ªâ lo·∫°i b·ªè kho·∫£ng tr·∫Øng - √°p d·ª•ng cho s·ªë)
          const normalizedStudentAnswer = studentAnswer.trim().replace(/\s/g, ''); 
          const normalizedCorrectAnswer = correctText.trim().replace(/\s/g, ''); 
          
          let points = 0; // M·∫∑c ƒë·ªãnh l√† SAI, KH√îNG TR·ª™ ƒêI·ªÇM
          let advanceQ = false;
          let resultMessage = "SAI (0 ƒëi·ªÉm)";

          // So s√°nh chu·ªói ƒë√£ chu·∫©n h√≥a
          if (normalizedStudentAnswer === normalizedCorrectAnswer) {
              points = 10;
              advanceQ = true; // ƒê√°p √°n ƒë√∫ng th√¨ chuy·ªÉn c√¢u
              resultMessage = "ƒê√öNG (+10)";
          } 
          // N·∫øu sai, points v·∫´n l√† 0 v√† advanceQ v·∫´n l√† false.

          // C·∫≠p nh·∫≠t ƒëi·ªÉm cho ƒë·ªôi v√† quy·∫øt ƒë·ªãnh chuy·ªÉn c√¢u
          updateTeam(teamId, points, advanceQ);

          // X√≥a document kh·ªèi Firestore sau khi x·ª≠ l√Ω
          await deleteDoc(docRef);
          
          console.log(`Duy·ªát t·ª± ƒë·ªông: ƒê·ªôi ${teamId}, C√¢u ${qIndex}. ƒê√°p √°n HS: "${studentAnswer}". K·∫øt qu·∫£: ${resultMessage}.`);

      } catch(e) {
          console.error("L·ªói khi duy·ªát y√™u c·∫ßu t·ª± ƒë·ªông:", e);
          alert("L·ªói khi x·ª≠ l√Ω y√™u c·∫ßu duy·ªát t·ª± ƒë·ªông. Xem console.");
      }
  };
  
  // ===================================================
  // H√ÄM: DUY·ªÜT B·ªé QUA 
  // Logic: B·ªé QUA -> -10, chuy·ªÉn c√¢u.
  // ===================================================
  window.approveSkip = async (docId, teamId) => {
      try {
          const docRef = doc(db, "submissions", docId);
          
          // B·ªè qua: -10 ƒëi·ªÉm V√Ä chuy·ªÉn c√¢u (advanceQ = true)
          updateTeam(teamId, -10, true); 

          // X√≥a document kh·ªèi Firestore sau khi x·ª≠ l√Ω
          await deleteDoc(docRef);
          
          console.log(`Duy·ªát b·ªè qua: ƒê·ªôi ${teamId}. K·∫øt qu·∫£: B·ªè qua (-10) v√† chuy·ªÉn c√¢u.`);

      } catch(e) {
          console.error("L·ªói khi duy·ªát y√™u c·∫ßu b·ªè qua:", e);
          alert("L·ªói khi x·ª≠ l√Ω y√™u c·∫ßu duy·ªát b·ªè qua. Xem console.");
      }
  };


  // H√†m t·∫°o HTML cho y√™u c·∫ßu duy·ªát r√∫t g·ªçn
  function renderSubmissionItem(doc) {
    const data = doc.data();
    const docId = doc.id;
    const team = teams.find(t => t.id === data.teamId);
    const teamName = team ? team.name.split(' ')[1] : '???'; 
    
    let label = '';
    let buttonsHTML = ''; 

    if (data.action === 'skip') {
      label = `${teamName}: B·ªé QUA`;
      // N√∫t cho h√†nh ƒë·ªông B·ªé QUA
      buttonsHTML = `<button style="background:#e67e22;" onclick="approveSkip('${docId}', '${data.teamId}')">DUY·ªÜT B·ªé QUA (-10)</button>`;
    } else {
      label = `${teamName}: ${data.answer}`;
      // N√∫t cho h√†nh ƒë·ªông TR·∫¢ L·ªúI (Duy·ªát t·ª± ƒë·ªông)
      buttonsHTML = `
          <button style="background:#3498db;" onclick="autoApproveSubmission('${docId}', '${data.teamId}', '${data.questionIndex}', '${data.answer}')">DUY·ªÜT T·ª∞ ƒê·ªòNG</button>
      `;
    }

    const div = document.createElement('div');
    div.className = 'submission-item';
    div.id = `sub-${docId}`;
    div.style.borderLeftColor = team ? teamColorMap[team.color] : '#f1c40f';
    div.style.alignItems = 'center';
    div.style.padding = '10px 8px';
    div.style.color = '#fff';
    div.style.textAlign = 'center';

    div.innerHTML = `
      <div style="font-size:1.4em; font-weight:bold; margin-bottom: 5px;">${label} (C${data.questionIndex})</div>
      ${buttonsHTML}
    `;
    
    return div;
  }


  // H√†m l·∫Øng nghe submissions t·ª´ Firestore
  function listenForSubmissions() {
    const queueContainer = document.getElementById('submission-queue-area');
    const queueCountElement = document.getElementById('queue-count');
    
    const submissionQuery = query(
      collection(db, "submissions"),
      where("status", "==", "pending")
    );

    onSnapshot(submissionQuery, (snapshot) => {
      queueCountElement.textContent = snapshot.size; 

      snapshot.docChanges().forEach((change) => {
        const doc = change.doc;
        const docId = doc.id;
        const existingItem = document.getElementById(`sub-${docId}`);

        if (change.type === "added" && !existingItem) {
          const itemElement = renderSubmissionItem(doc);
          queueContainer.insertBefore(itemElement, queueContainer.children[1]); 
        } 
        else if (change.type === "removed" && existingItem) {
          existingItem.remove();
        }
      });
    });
  }

  // ============== LOGIC RESET D·ªÆ LI·ªÜU ==============
  async function resetGameData() {
      if (!confirm("‚ö†Ô∏è C·∫¢NH B√ÅO: Thao t√°c n√†y s·∫Ω X√ìA T·∫§T C·∫¢ y√™u c·∫ßu duy·ªát ƒë√°p √°n tr√™n Firebase v√† t·∫£i l·∫°i trang. B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën RESET?")) {
          return;
      }
      
      const resetBtn = document.getElementById('resetBtn');
      resetBtn.disabled = true;
      resetBtn.textContent = "ƒêANG X√ìA...";

      try {
          const querySnapshot = await getDocs(collection(db, "submissions"));
          
          const deletePromises = [];
          querySnapshot.forEach((doc) => {
              deletePromises.push(deleteDoc(doc.ref));
          });
          
          await Promise.all(deletePromises);
          
          alert("‚úÖ ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu duy·ªát ƒë√°p √°n. T·∫£i l·∫°i trang ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i.");
          window.location.reload(); 
          
      } catch (e) {
          console.error("L·ªói khi reset d·ªØ li·ªáu:", e);
          alert("‚ùå L·ªñI: Kh√¥ng th·ªÉ reset d·ªØ li·ªáu. Xem console ƒë·ªÉ bi·∫øt chi ti·∫øt.");
      } finally {
          resetBtn.disabled = false;
          resetBtn.textContent = "üí£ RESET D·ªÆ LI·ªÜU";
      }
  }


  // === G·∫ÆN S·ª∞ KI·ªÜN CHO T·∫§T C·∫¢ C√ÅC N√öT ===
  document.addEventListener('DOMContentLoaded', () => {
    // 1. N√∫t B·∫ÆT ƒê·∫¶U V√íNG 3!
    const startBtn = document.getElementById("startBtn");
    if (startBtn) {
      startBtn.addEventListener('click', showGame);
    }
    
    // 2. N√∫t START (·ªü giao di·ªán 2)
    const startGameBtn = document.getElementById("startGameBtn");
    if (startGameBtn) {
        startGameBtn.addEventListener('click', startCountdown);
    }

    // 3. N√∫t RESET D·ªÆ LI·ªÜU
    const resetBtn = document.getElementById("resetBtn");
    if (resetBtn) {
        resetBtn.addEventListener('click', resetGameData);
    }

    // 4. N√∫t K·∫æT TH√öC S·ªöM
    const endEarlyBtn = document.getElementById("endEarlyBtn");
    if (endEarlyBtn) {
        endEarlyBtn.addEventListener('click', endGame);
    }
  });

</script>
</body>
</html>



