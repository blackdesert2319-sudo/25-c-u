<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GV - M·∫≠t M√£ R∆∞∆°ng B√°u</title>
  <style>
    :root{
      --bg:#0d1b2a;
      --card:#0f2740;
      --accent:#ffd166;
      --muted:#a0b0c0;
      --panel:#122436;
      --team-gap:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:#fff;
      padding:18px;
      overflow-x:hidden;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:14px;
    }
    h1{
      margin:0;
      font-size:1.6rem;
      color:var(--accent);
      letter-spacing:0.4px;
    }
    /* Giao di·ªán QR (setup) */
    #setupScreen{ text-align:center; padding:20px 10px; display:block; }
    #startMissionBtn{
      background:var(--accent);
      color:#000;
      border:0;
      padding:12px 22px;
      border-radius:10px;
      font-weight:700;
      font-size:1.05rem;
      cursor:pointer;
      margin-top:12px;
    }
    .qr-container{
      margin-top:18px;
      display:flex;
      justify-content:center;
      flex-wrap:wrap;
      gap:18px;
    }
    .qr-item{
      background:var(--card);
      padding:12px;
      border-radius:12px;
      width:160px;
      text-align:center;
      box-shadow:0 6px 18px rgba(0,0,0,0.5);
    }
    .qr-item canvas{ display:block; margin:0 auto 8px auto; }

    /* Giao di·ªán tr√≤ ch∆°i (game) */
    #gameInterface{ display:none; margin-top:6px; }
    .top-controls{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .left-controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{
      background:var(--accent);
      color:#000;
      border:0;
      padding:8px 14px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
    }
    .countdown{
      font-size:1.35rem;
      background:#071427;
      padding:8px 12px;
      border-radius:10px;
      color:var(--accent);
      font-weight:800;
      min-width:110px;
      text-align:center;
    }
    .layout{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:16px;
      align-items:start;
    }
    .teams-area{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:var(--team-gap);
    }
    .team-card{
      background:var(--panel);
      border-radius:12px;
      padding:14px;
      min-height:180px;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      box-shadow:0 6px 18px rgba(0,0,0,0.45);
    }
    .team-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
    }
    .team-title{ font-weight:800; font-size:1.05rem; text-transform:uppercase; }
    .team-score{ font-weight:900; font-size:1.1rem; background:rgba(255,255,255,0.06); padding:6px 10px; border-radius:8px; }
    .question{ font-size:2rem; line-height:1.2; margin-bottom:10px; min-height:90px; }
    .q-buttons{ display:flex; justify-content:center; gap:8px; margin-top:auto; }
    .q-buttons button{
      width:44px; height:44px; border-radius:50%; border:0;
      background:#274b67; color:#fff; font-weight:800; cursor:pointer;
    }
    .q-buttons button.active{ background:var(--accent); color:#000; }

    .pending-column{
      background:var(--panel);
      padding:12px;
      border-radius:10px;
      max-height:76vh;
      overflow:auto;
      box-shadow:0 6px 18px rgba(0,0,0,0.35);
    }
    .pending-column h3{ margin:0 0 8px 0; color:var(--accent) }
    .pending-item{
      background:#14324a;
      padding:8px;
      border-radius:8px;
      margin-bottom:8px;
      font-size:0.95rem;
    }
    .controls-small{ display:flex; gap:8px; align-items:center; }

    @media (max-width:900px){
      .layout{ grid-template-columns: 1fr; }
      .teams-area{ grid-template-columns: 1fr; }
      .pending-column{ max-height:40vh; }
    }
  </style>
</head>
<body>
  <header>
    <h1>M·∫¨T M√É R∆Ø∆†NG B√ÅU: 5 ƒê·ªòI TRANH T√ÄI</h1>
    <div style="font-size:0.95rem;color:var(--muted)">GV Control Panel</div>
  </header>

  <section id="setupScreen">
    <button id="startMissionBtn">üöÄ B·∫ÆT ƒê·∫¶U PHI V·ª§</button>
    <div style="color:var(--muted);margin-top:6px">H·ªçc sinh qu√©t m√£ QR ƒë·ªÉ v√†o giao di·ªán ƒë·ªôi</div>
    <div class="qr-container" id="qrContainer"></div>
  </section>

  <section id="gameInterface">
    <div class="top-controls">
      <div class="left-controls">
        <button id="backToQR" class="btn">üîô Quay l·∫°i</button>
        <button id="startCountdownBtn" class="btn">‚ñ∂ B·∫ÆT ƒê·∫¶U ƒê·∫æM NG∆Ø·ª¢C</button>
        <button id="endEarlyBtn" class="btn">‚èπ T·ªîNG K·∫æT S·ªöM</button>
      </div>
      <div class="controls-small">
        <div class="countdown" id="countdown">10:00</div>
      </div>
    </div>
    <div class="layout">
      <div><div class="teams-area" id="teamsGrid"></div></div>
      <aside class="pending-column"><h3>H√ÄNG CH·ªú DUY·ªÜT</h3><div id="pendingList"></div></aside>
    </div>
  </section>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC9SRP8hEhtJ8bY2n1mTuPhtvpgMyZbktY",
      authDomain: "blackdesert2319-sudo.firebaseapp.com",
      projectId: "blackdesert2319-sudo",
      storageBucket: "blackdesert2319-sudo.appspot.com",
      messagingSenderId: "628771580196",
      appId: "1:628771580196:web:1e95f7f3c9de7e3e6cb36d"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const teams = [
      { id: "red", name: "ƒê·ªôi ƒê·ªè", color: "#e63946" },
      { id: "blue", name: "ƒê·ªôi Xanh", color: "#1d3557" },
      { id: "green", name: "ƒê·ªôi L√°", color: "#2a9d8f" },
      { id: "yellow", name: "ƒê·ªôi V√†ng", color: "#f4a261" },
      { id: "purple", name: "ƒê·ªôi T√≠m", color: "#9d4edd" }
    ];

    const questions = [
      "Cho c·∫•p s·ªë c·ªông c√≥ u‚ÇÅ = 2, c√¥ng sai d = 3. T√¨m u‚ÇÖ.",
      "Cho c·∫•p s·ªë c·ªông 5, 8, 11, ... T√≠nh s·ªë h·∫°ng th·ª© 10.",
      "Cho c·∫•p s·ªë nh√¢n c√≥ u‚ÇÅ = 3, q = 2. T√¨m u‚ÇÖ.",
      "Cho c·∫•p s·ªë nh√¢n 2, 6, 18, ... T√¨m c√¥ng b·ªôi q.",
      "Cho c·∫•p s·ªë c·ªông c√≥ 7 s·ªë h·∫°ng, t·ªïng l√† 35, u‚ÇÅ = 2. T√¨m c√¥ng sai d.",
      "Cho c·∫•p s·ªë nh√¢n c√≥ 5 s·ªë h·∫°ng, u‚ÇÅ = 2, u‚ÇÖ = 32. T√¨m q.",
      "Cho c·∫•p s·ªë c·ªông 4, 7, 10, ... T√¨m s·ªë h·∫°ng th·ª© 12."
    ];
    const correctAnswers = ["14","32","48","3","5","2","37"];
    const questionOrder = {
      red:[0,1,2,3,4,5,6],
      blue:[2,5,0,3,1,6,4],
      green:[4,2,6,0,1,5,3],
      yellow:[1,3,5,2,0,4,6],
      purple:[6,0,4,1,3,2,5]
    };

    const qrContainer = document.getElementById("qrContainer");
    const setupScreen = document.getElementById("setupScreen");
    const gameInterface = document.getElementById("gameInterface");
    const startMissionBtn = document.getElementById("startMissionBtn");
    const startCountdownBtn = document.getElementById("startCountdownBtn");
    const endEarlyBtn = document.getElementById("endEarlyBtn");
    const countdownEl = document.getElementById("countdown");
    const teamsGrid = document.getElementById("teamsGrid");
    const pendingList = document.getElementById("pendingList");
    const backToQR = document.getElementById("backToQR");

    const teamScores = {}; const currentQuestion = {};
    teams.forEach(t=>{teamScores[t.id]=0; currentQuestion[t.id]=0;});

    window.onload=()=>{
      generateQRCodes(); renderTeams(); attachEvents(); listenTeamStateRealtime(); listenSubmissionsRealtime();
    }

    function generateQRCodes(){
      qrContainer.innerHTML="";
      teams.forEach(team=>{
        const box=document.createElement('div');
        box.className='qr-item';
        const canvas=document.createElement('canvas');
        const hsPath = window.location.href.replace("gv.html","hs.html");
        const url=`${hsPath}?teamId=${team.id}`;
        QRCode.toCanvas(canvas,url,{width:140});
        const label=document.createElement('div');
        label.textContent=team.name; label.style.color=team.color; label.style.fontWeight="700";
        box.appendChild(canvas); box.appendChild(label);
        qrContainer.appendChild(box);
      });
    }

    function renderTeams(){
      teamsGrid.innerHTML="";
      teams.forEach(team=>{
        const card=document.createElement('div');
        card.className='team-card';
        card.innerHTML=`
          <div class="team-top"><div class="team-title" style="color:${team.color}">${team.name}</div><div class="team-score" id="score-${team.id}">0</div></div>
          <div class="question" id="question-${team.id}">C√¢u h·ªèi s·∫Ω hi·ªán khi b·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c...</div>
        `;
        teamsGrid.appendChild(card);
      });
    }

    function attachEvents(){
      startMissionBtn.onclick=()=>{setupScreen.style.display='none'; gameInterface.style.display='block';};
      backToQR.onclick=()=>{gameInterface.style.display='none'; setupScreen.style.display='block';};
      startCountdownBtn.onclick=startCountdown;
      endEarlyBtn.onclick=()=>{clearInterval(countTimer); alert("K·∫øt th√∫c s·ªõm.");};
    }

    let countTimer=null; let timeLeft=600;
    function startCountdown(){
      clearInterval(countTimer); timeLeft=600;
      countTimer=setInterval(()=>{timeLeft--; updateCountdown(); if(timeLeft<=0){clearInterval(countTimer); alert("H·∫øt gi·ªù!");}},1000);
      updateCountdown();
    }
    function updateCountdown(){
      const m=Math.floor(timeLeft/60),s=timeLeft%60;
      countdownEl.textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function listenTeamStateRealtime(){
      teams.forEach(t=>{
        db.collection('teamState').doc(t.id).onSnapshot(doc=>{
          const d=doc.data(); if(!d) return;
          teamScores[t.id]=d.score||0;
          currentQuestion[t.id]=d.currentQIndex||0;
          document.getElementById(`score-${t.id}`).textContent=d.score;
          const idx=questionOrder[t.id][d.currentQIndex];
          document.getElementById(`question-${t.id}`).textContent=questions[idx]||"ƒê√£ ho√†n th√†nh!";
        });
      });
    }

    function listenSubmissionsRealtime(){
      db.collection('submissions').orderBy('timestamp','asc').onSnapshot(ss=>{
        ss.docChanges().forEach(ch=>{
          if(ch.type==='added'){
            const d=ch.doc.data(); displayPending(d);
          }
        });
      });
    }

    function displayPending(d){
      const div=document.createElement('div');
      div.className='pending-item';
      const team=teams.find(x=>x.id===d.teamId)?.name||d.teamId;
      div.innerHTML=`<b>${team}</b> g·ª≠i: ${d.answer}`;
      pendingList.prepend(div);
      while(pendingList.children.length>50) pendingList.removeChild(pendingList.lastChild);
    }
  </script>
</body>
</html>
