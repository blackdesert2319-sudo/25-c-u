<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gi√°o vi√™n - M·∫≠t M√£ R∆∞∆°ng B√°u</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #0d1b2a;
      color: #fff;
      margin: 0;
      padding: 0;
    }

    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-top: 30px;
      color: #ffd166;
    }

    .hidden {
      display: none;
    }

    .center {
      text-align: center;
    }

    button {
      background: #ffd166;
      border: none;
      padding: 12px 25px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      transition: background 0.3s;
    }

    button:hover {
      background: #ffca3a;
    }

    .qr-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 30px;
    }

    .qr-item {
      background: #1b263b;
      border-radius: 15px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 0 10px rgba(255,255,255,0.2);
    }

    .qr-item canvas {
      display: block;
      margin: 0 auto 10px auto;
    }

    /* ===== GIAO DI·ªÜN 2 ===== */
    #gameInterface {
      display: none;
      padding: 15px;
    }

    .top-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .countdown {
      font-size: 1.6rem;
      color: #ffca3a;
      font-weight: bold;
    }

    .teams-container {
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: 15px;
    }

    .teams-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .team-box {
      background: #1b263b;
      border-radius: 15px;
      padding: 15px;
      position: relative;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

    .team-header {
      font-weight: bold;
      font-size: 1.3rem;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .question {
      font-size: 2rem;
      line-height: 1.5;
      min-height: 120px;
      margin-bottom: 10px;
    }

    .question-buttons {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
    }

    .question-buttons button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 1rem;
      font-weight: bold;
      background: #457b9d;
      color: white;
    }

    .question-buttons button.active {
      background: #ffca3a;
      color: #000;
    }

    /* C·ªôt ph·∫£i: h√†ng ch·ªù duy·ªát */
    .pending-column {
      background: #1b263b;
      border-radius: 10px;
      padding: 10px;
      overflow-y: auto;
      max-height: 75vh;
    }

    .pending-item {
      background: #415a77;
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
  <!-- ===== GIAO DI·ªÜN 1 ===== -->
  <div id="setupScreen" class="center">
    <h1>M·∫¨T M√É R∆Ø∆†NG B√ÅU: 5 ƒê·ªòI TRANH T√ÄI</h1>
    <button id="startMissionBtn">B·∫ÆT ƒê·∫¶U PHI V·ª§</button>
    <div class="qr-container" id="qrContainer"></div>
  </div>

  <!-- ===== GIAO DI·ªÜN 2 ===== -->
  <div id="gameInterface">
    <div class="top-controls">
      <div>
        <button id="backToQR">üîô Quay l·∫°i</button>
        <button id="startCountdownBtn">‚ñ∂ B·∫ÆT ƒê·∫¶U ƒê·∫æM NG∆Ø·ª¢C</button>
        <button id="endEarlyBtn">‚èπ T·ªîNG K·∫æT S·ªöM</button>
      </div>
      <div class="countdown" id="countdown">10:00</div>
    </div>

    <div class="teams-container">
      <div class="teams-grid" id="teamsGrid"></div>
      <div class="pending-column" id="pendingColumn">
        <h3>H√ÄNG CH·ªú DUY·ªÜT</h3>
        <div id="pendingList"></div>
      </div>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script>
    // === Firebase gi·ªØ nguy√™n c·∫•u h√¨nh nh∆∞ b·∫£n b·∫°n ƒëang d√πng ===
    const firebaseConfig = {
      apiKey: "AIzaSyC9SRP8hEhtJ8bY2n1mTuPhtvpgMyZbktY",
      authDomain: "blackdesert2319-sudo.firebaseapp.com",
      projectId: "blackdesert2319-sudo",
      storageBucket: "blackdesert2319-sudo.appspot.com",
      messagingSenderId: "628771580196",
      appId: "1:628771580196:web:1e95f7f3c9de7e3e6cb36d"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== C·∫§U H√åNH 5 ƒê·ªòI =====
    const teams = [
      { id: "red", name: "ƒê·ªôi ƒê·ªè", color: "#e63946" },
      { id: "blue", name: "ƒê·ªôi Xanh", color: "#1d3557" },
      { id: "green", name: "ƒê·ªôi L√°", color: "#2a9d8f" },
      { id: "yellow", name: "ƒê·ªôi V√†ng", color: "#f4a261" },
      { id: "purple", name: "ƒê·ªôi T√≠m", color: "#9d4edd" }
    ];

    // ===== C√ÇU H·ªéI (C·∫•p s·ªë c·ªông / nh√¢n) =====
    const questions = [
      "C√¢u 1: Cho c·∫•p s·ªë c·ªông c√≥ u‚ÇÅ = 2, c√¥ng sai d = 3. T√¨m u‚ÇÖ?",
      "C√¢u 2: Cho c·∫•p s·ªë c·ªông 5, 8, 11, ... T√≠nh s·ªë h·∫°ng th·ª© 10?",
      "C√¢u 3: Cho c·∫•p s·ªë nh√¢n c√≥ u‚ÇÅ = 3, q = 2. T√¨m u‚ÇÖ?",
      "C√¢u 4: Cho c·∫•p s·ªë nh√¢n 2, 6, 18, ... T√¨m c√¥ng b·ªôi q?",
      "C√¢u 5: Cho c·∫•p s·ªë c·ªông c√≥ 7 s·ªë h·∫°ng, t·ªïng l√† 35, u‚ÇÅ = 2. T√¨m c√¥ng sai d?",
      "C√¢u 6: Cho c·∫•p s·ªë nh√¢n c√≥ 5 s·ªë h·∫°ng, u‚ÇÅ = 2, u‚ÇÖ = 32. T√¨m q?",
      "C√¢u 7: Cho c·∫•p s·ªë c·ªông 4, 7, 10, ... T√¨m s·ªë h·∫°ng th·ª© 12?"
    ];

    // DOM elements
    const setupScreen = document.getElementById("setupScreen");
    const startMissionBtn = document.getElementById("startMissionBtn");
    const qrContainer = document.getElementById("qrContainer");
    const gameInterface = document.getElementById("gameInterface");
    const teamsGrid = document.getElementById("teamsGrid");
    const startCountdownBtn = document.getElementById("startCountdownBtn");
    const endEarlyBtn = document.getElementById("endEarlyBtn");
    const countdownEl = document.getElementById("countdown");
    const pendingList = document.getElementById("pendingList");
    const backToQR = document.getElementById("backToQR");

    // === Hi·ªÉn th·ªã QR c√°c ƒë·ªôi ===
    function generateQRCodes() {
      qrContainer.innerHTML = "";
      teams.forEach(team => {
        const div = document.createElement("div");
        div.className = "qr-item";
        const canvas = document.createElement("canvas");
        const teamUrl = `${window.location.origin}/25-c-u/hs.html?teamId=${team.id}`;
        QRCode.toCanvas(canvas, teamUrl, { width: 140 });
        div.appendChild(canvas);
        const label = document.createElement("div");
        label.textContent = team.name;
        label.style.color = team.color;
        div.appendChild(label);
        qrContainer.appendChild(div);
      });
    }

    generateQRCodes();

    // ===== N√∫t b·∫Øt ƒë·∫ßu phi v·ª• =====
    startMissionBtn.addEventListener("click", () => {
      setupScreen.style.display = "none";
      gameInterface.style.display = "block";
    });

    // ===== Quay l·∫°i giao di·ªán QR =====
    backToQR.addEventListener("click", () => {
      gameInterface.style.display = "none";
      setupScreen.style.display = "block";
    });

    // ===== T·∫†O KHUNG 5 ƒê·ªòI =====
    function renderTeams() {
      teamsGrid.innerHTML = "";
      teams.forEach(team => {
        const box = document.createElement("div");
        box.className = "team-box";
        box.style.borderTop = `5px solid ${team.color}`;
        box.innerHTML = `
          <div class="team-header">${team.name}</div>
          <div class="question" id="question-${team.id}">
            C√¢u h·ªèi s·∫Ω hi·ªán khi b·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c...
          </div>
          <div class="question-buttons" id="btns-${team.id}">
            ${[1,2,3,4,5,6,7].map(i=>`<button data-q="${i}">${i}</button>`).join("")}
          </div>
          <div id="score-${team.id}" style="margin-top:8px;font-weight:bold;">
            ƒêi·ªÉm: 0
          </div>
        `;
        teamsGrid.appendChild(box);
      });
    }

    renderTeams();
    // ===== ƒêI·ªÄU KHI·ªÇN ƒê·∫æM NG∆Ø·ª¢C =====
    let countdownTimer;
    let timeLeft = 10 * 60; // 10 ph√∫t

    function startCountdown() {
      clearInterval(countdownTimer);
      timeLeft = 10 * 60;
      updateCountdownDisplay();
      countdownTimer = setInterval(() => {
        timeLeft--;
        updateCountdownDisplay();
        if (timeLeft <= 0) {
          clearInterval(countdownTimer);
          alert("‚è∞ H·∫øt gi·ªù!");
        }
      }, 1000);
    }

    function updateCountdownDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      countdownEl.textContent = `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    }

    startCountdownBtn.addEventListener("click", async () => {
      startCountdown();
      // C·∫≠p nh·∫≠t tr·∫°ng th√°i startGame ƒë·ªÉ HS th·∫•y c√¢u h·ªèi
      const ctrlRef = db.collection("control").doc("state");
      await ctrlRef.set({ startGame: true });
      alert("ƒê·∫øm ng∆∞·ª£c b·∫Øt ƒë·∫ßu! H·ªçc sinh s·∫Ω th·∫•y c√¢u h·ªèi ƒë·∫ßu ti√™n.");
      // Hi·ªÉn th·ªã c√¢u h·ªèi ƒë·∫ßu ti√™n cho GV
      teams.forEach(t => {
        document.getElementById(`question-${t.id}`).textContent = questions[0];
      });
    });

    // ===== N√öT T·ªîNG K·∫æT S·ªöM =====
    endEarlyBtn.addEventListener("click", async () => {
      clearInterval(countdownTimer);
      alert("T·ªïng k·∫øt s·ªõm! K·∫øt th√∫c v√≤ng ch∆°i.");
      await db.collection("control").doc("state").set({ startGame: false });
    });

    // ===== L·∫ÆNG NGHE SUBMISSIONS T·ª™ H·ªåC SINH =====
    db.collection("submissions").orderBy("timestamp").onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === "added") {
          const data = change.doc.data();
          const { teamId, answer, questionIndex } = data;
          const time = new Date(data.timestamp?.toDate ? data.timestamp.toDate() : data.timestamp);
          const timeStr = time.toLocaleTimeString("vi-VN", { hour12: false });
          const item = document.createElement("div");
          item.className = "pending-item";
          item.innerHTML = `
            <strong>${teams.find(t=>t.id===teamId)?.name || teamId}</strong><br>
            C√¢u ${questionIndex + 1}: ${answer}<br>
            <small>${timeStr}</small>
          `;
          pendingList.prepend(item);
          handleSubmission(data);
        }
      });
    });

    // ===== X·ª¨ L√ù CH·∫§M ƒêI·ªÇM =====
    const teamScores = { red: 0, blue: 0, green: 0, yellow: 0, purple: 0 };
    const currentQuestion = { red: 0, blue: 0, green: 0, yellow: 0, purple: 0 };

    function handleSubmission(sub) {
      const team = sub.teamId;
      const ans = (sub.answer || "").trim().toLowerCase();
      const idx = sub.questionIndex ?? currentQuestion[team];
      const correctAnswers = [
        "14","32","48","3","5","2","37"
      ];

      if (ans === "skip" || ans === "b·ªè qua") {
        teamScores[team] -= 10;
        currentQuestion[team] = Math.min(6, currentQuestion[team] + 1);
        alert(`${teams.find(t=>t.id===team).name} b·ªè qua c√¢u ${idx+1} (-10ƒë)`);
      } else if (ans === correctAnswers[idx].toLowerCase()) {
        teamScores[team] += 10;
        currentQuestion[team] = Math.min(6, currentQuestion[team] + 1);
        alert(`${teams.find(t=>t.id===team).name} tr·∫£ l·ªùi ƒë√∫ng (+10ƒë)`);
      } else {
        alert(`${teams.find(t=>t.id===team).name} tr·∫£ l·ªùi sai.`);
      }

      updateTeamDisplay(team);
    }

    function updateTeamDisplay(teamId) {
      const scoreEl = document.getElementById(`score-${teamId}`);
      if (scoreEl) scoreEl.textContent = `ƒêi·ªÉm: ${teamScores[teamId]}`;
      const qEl = document.getElementById(`question-${teamId}`);
      const qIdx = currentQuestion[teamId];
      if (qEl && qIdx < questions.length) {
        qEl.textContent = questions[qIdx];
      } else if (qEl) {
        qEl.textContent = "üéâ ƒê√£ ho√†n th√†nh to√†n b·ªô c√¢u h·ªèi!";
      }
      const btns = document.querySelectorAll(`#btns-${teamId} button`);
      btns.forEach((b,i)=>{
        if (i===qIdx) b.classList.add("active"); else b.classList.remove("active");
      });
    }

  </script>
</body>
</html>
