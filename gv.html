<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M·∫≠t M√£ R∆∞∆°ng B√°u - GV (Ho√†n Ch·ªânh)</title>

<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
<script>
window.MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
  svg: { fontCache: 'global' }
};
</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>
body {
  font-family:'Arial',sans-serif;
  background:#1e1e1e;
  color:#fff;
  margin:0;
  padding:0;
  overflow-x:hidden;
}
h1 { color:#f1c40f; margin:12px 0; text-align:center; }
#timer {
  position:fixed;
  top:8px; left:12px;
  font-size:2.2em; font-weight:bold;
  color:#e74c3c; background:#f1c40f;
  padding:4px 12px; border-radius:8px;
  display:none;
  z-index:10;
}
#endEarlyBtn {
  position:fixed;
  top:15px; left:130px;
  font-size:1.1em;
  background:#e67e22;
  color:white;
  border:none;
  border-radius:8px;
  padding:6px 14px;
  font-weight:bold;
  cursor:pointer;
  display:none;
  z-index:10;
}

/* === QR ·ªü giao di·ªán ƒë·∫ßu === */
#qr-list {
  display:flex !important;
  flex-wrap:wrap;
  justify-content:center;
  align-items:center;
  gap:12px;
  margin-top:20px;
}
.qr-item {
  width:180px;
  margin:10px;
  padding:10px;
  border-radius:8px;
  background:white;
  color:#333;
  text-align:center;
  font-weight:bold;
  border: 2px solid transparent;
}
.qr-item img {
  width:150px; height:150px;
  border:2px solid transparent;
  margin-bottom:5px;
}
.qr-item.team-red {
    border-color: #e74c3c; /* ƒê·ªè */
}
.qr-item.team-blue {
    border-color: #3498db; /* Xanh Lam */
}
.qr-item.team-green {
    border-color: #2ecc71; /* Xanh L·ª•c */
}
.qr-item.team-yellow {
    border-color: #f1c40f; /* V√†ng */
}
.qr-item.team-purple {
    border-color: #9b59b6; /* T√≠m */
}

/* === GIAO DI·ªÜN 2 === */
#game-wrapper { display:none; position:relative; }
.game-layout {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: flex-start;
  width: 100%;
  margin: 0;
  padding: 0 10px;
  box-sizing: border-box;
}

/* C·ªôt tr√°i: c√°c ƒë·ªôi */
#team-rows-container {
  flex: 1;
  margin-right: 15px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
}

/* C·ªôt ph·∫£i: h√†ng ƒë·ª£i */
#submission-queue-area {
  width: 120px;
  background: #34495e;
  border-radius: 10px;
  padding: 8px;
  height: calc(100vh - 40px);
  overflow-y: auto;
  position: fixed;
  right: 0;
  top: 0;
}
#submission-queue-area h2 {
  font-size: 1em;
  text-align: center;
  color: #f1c40f;
  margin-bottom: 10px;
}
/* CSS cho B·ªô ƒë·∫øm */
#queue-count {
  background: #e74c3c; /* ƒê·ªè */
  padding: 2px 8px;
  border-radius: 5px;
  font-size: 1em;
  font-weight: bold;
}

/* === KHUNG M·ªñI ƒê·ªòI === */
.team-row {
  display:flex;
  align-items:center;
  justify-content:flex-start;
  width:100%;
  padding:8px 18px;
  border-radius:10px;
  box-shadow:0 2px 5px rgba(0,0,0,0.4);
  min-height:95px;
}
.team-red{background:#e74c3c;}
.team-blue{background:#3498db;}
.team-green{background:#2ecc71;}
.team-yellow{background:#f1c40f;color:#333;}
.team-purple{background:#9b59b6;}

.team-score-control {
  width:160px;
  display:flex;
  flex-direction:row;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.team-score-value {
  font-size:2.5em;
  font-weight:900;
  background:rgba(255,255,255,0.25);
  padding:2px 12px;
  border-radius:8px;
}
.q-status-item {
  width:36px;
  height:36px;
  border-radius:50%;
  font-size:1.1em;
  font-weight:bold;
  color:white;
  background:#2980b9;
  display:flex;
  justify-content:center;
  align-items:center;
}

.team-question-area {
  flex:1;
  padding-left:20px;
  display:none; /* ·∫©n tr∆∞·ªõc khi start */
}
.q-text {
  font-size:2.3em;
  font-weight:700;
  line-height:1.3;
}

/* H√†ng ƒë·ª£i duy·ªát ƒë√°p √°n (CSS cho m·ª•c r√∫t g·ªçn) */
.submission-item {
  padding:8px;
  margin-bottom:8px;
  background:#2c3e50;
  border-radius:6px;
  display:flex;
  flex-direction:column;
  align-items:center;
  border-left:4px solid #f1c40f;
  /* Thay ƒë·ªïi ƒë·ªÉ ph√π h·ª£p v·ªõi hi·ªÉn th·ªã r√∫t g·ªçn */
  text-align:center;
}
.submission-item button {
  padding:5px 10px;
  background:#e67e22;
  color:white;
  border:none;
  border-radius:5px;
  font-weight:bold;
  margin-top:5px;
  font-size:0.9em;
  cursor:pointer;
}

/* START BUTTON */
#startGameBtn {
  position:absolute;
  top:0px; /* ƒê·∫∑t c√°ch ƒë√°y 10 pixel */
  left:100px;
  transform:translate(-50%, -50%);
  font-size:2em;
  padding:14px 30px;
  border:none;
  border-radius:10px;
  background:#2ecc71;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
  display:none;
  z-index:10;
}

/* OVERLAY K·∫æT TH√öC */
#endOverlay {
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(241,196,15,0.9);
  color:#000;
  z-index:20;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  text-align:center;
}
#endOverlay h1 {
  font-size:3em;
  margin-bottom:20px;
}
#endOverlay .scoreboard {
  font-size:2em;
  line-height:1.5;
  font-weight:bold;
}

/* CSS cho N√∫t Reset */
#resetBtn {
    font-size: 1.2em;
    padding: 12px 22px;
    background: #e74c3c; /* ƒê·ªè */
    color: #fff;
    border: none;
    border-radius: 8px;
    margin: 20px 5px; /* ƒêi·ªÅu ch·ªânh margin ƒë·ªÉ n·∫±m c·∫°nh n√∫t B·∫ÆT ƒê·∫¶U */
    font-weight: bold;
    cursor: pointer;
}
</style>
</head>

<body>
  <h1>CHI·∫æN TH·∫ÆNG KHI HO√ÄN TH√ÄNH 7 C√ÇU H·ªéI NHANH NH·∫§T</h1>
  <div id="qr-list"></div>

  <div style="text-align:center;">
    <button id="startBtn" style="padding:12px 22px;font-size:1.2em;background:#f1c40f;color:#222;border:none;border-radius:8px;margin:20px 5px;font-weight:bold;cursor:pointer;">
      B·∫ÆT ƒê·∫¶U V√íNG 3!
    </button>
    <button id="resetBtn">
      üí£ RESET D·ªÆ LI·ªÜU
    </button>
  </div>
  <div id="game-wrapper">
    <div id="timer">10:00</div>
    <button id="endEarlyBtn">K·∫æT TH√öC S·ªöM</button>
    <button id="startGameBtn">START</button>
    <div class="game-layout">
      <div id="team-rows-container"></div>
      <div id="submission-queue-area">
        <h2>H√ÄNG ƒê·ª¢I DUY·ªÜT ƒê√ÅP √ÅN (<span id="queue-count">0</span>)</h2>
      </div>
    </div>
  </div>

  <div id="endOverlay">
    <h1>üèÜ TR√í CH∆†I K·∫æT TH√öC üèÜ</h1>
    <div class="scoreboard" id="finalScores"></div>
  </div>

<script type="module">
  // B. Th√™m Imports v√† Config Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // === C·∫§U H√åNH FIREBASE (gi·ªØ nguy√™n nh∆∞ file HS) ===
  const firebaseConfig = {
    apiKey: "AIzaSyDfcMrblRonAS9Q7BSfD9ZZYeOmSy4UjfQ",
    authDomain: "nutnhap.firebaseapp.com",
    projectId: "nutnhap",
    storageBucket: "nutnhap.firebasestorage.app",
    messagingSenderId: "359344838873",
    appId: "1:359344838873:web:d1746d32920881091c86c8",
    measurementId: "G-0VTTNLWDD9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);


  // D1. S·ª≠a m·∫£ng teams ƒë·ªÉ th√™m currentQ
  const teams = [
    { name: "ƒê·ªôi ƒê·ªè", color: "team-red", id: "red", score: 0, currentQ: 1 },
    { name: "ƒê·ªôi Xanh", color: "team-blue", id: "blue", score: 0, currentQ: 1 },
    { name: "ƒê·ªôi L·ª•c", color: "team-green", id: "green", score: 0, currentQ: 1 },
    { name: "ƒê·ªôi V√†ng", color: "team-yellow", id: "yellow", score: 0, currentQ: 1 },
    { name: "ƒê·ªôi T√≠m", color: "team-purple", id: "purple", score: 0, currentQ: 1 }
  ];

  // √Ånh x·∫° c√°c class m√†u CSS sang m√£ m√†u Hex cho n·ªÅn QR
  const teamColorMap = {
      'team-red': '#f8d7da',        
      'team-blue': '#d0e0f0',       
      'team-yellow': '#fff3cd',      
      'team-green': '#d4edda',       
      'team-purple': '#e8d9ef'       
  };

  // H·∫∞NG S·ªê GAME
  const TREASURE_BONUS = 30; 
  const WINNING_QUESTION = 7; 
  let timerInterval;
  let totalSeconds = 600; // 10 ph√∫t

  window.onload = function() {
    const qrList = document.getElementById("qr-list");
    qrList.innerHTML = "";
    const baseURL = location.href.replace(/[^/]*$/, "") + "hs.html";
    teams.forEach(team => {
      const div = document.createElement("div");
      div.className = "qr-item " + team.color; 
      div.innerHTML = `<div>${team.name}</div><div id="qr-${team.id}"></div>`;
      qrList.appendChild(div);
      new QRCode(document.getElementById("qr-" + team.id), {
        text: `${baseURL}?teamId=${team.id}`,
        width: 150,
        height: 150
      });
    });
  };

  // C. C·∫≠p nh·∫≠t showGame
  function showGame(){
    const qrList = document.getElementById("qr-list");
    if (qrList) qrList.remove();

    // ·∫®n kh·ªëi ch·ª©a c·∫£ 2 n√∫t (B·∫ÆT ƒê·∫¶U v√† RESET)
    const buttonContainer = document.querySelector('div[style="text-align:center;"]');
    if (buttonContainer) buttonContainer.style.display = "none";

    document.getElementById("game-wrapper").style.display="block";
    renderTeams();
    document.getElementById("startGameBtn").style.display="block";
    
    listenForSubmissions();
  }


  function renderTeams(){
    const container = document.getElementById("team-rows-container");
    container.innerHTML = "";
    teams.forEach(team=>{
      const row=document.createElement("div");
      row.className=`team-row ${team.color}`;
      row.innerHTML=`
        <div class="team-score-control">
          <div class="team-score-value" id="score-${team.id}">${team.score}</div>
          <div class="q-status-item" id="status-${team.id}">${team.currentQ}</div>
        </div>
        <div class="team-question-area" id="qarea-${team.id}">
          <div class="q-text">Cho CSC c√≥ $u_1=3$, $d=2$. T√¨m $u_{10}$.</div>
        </div>
      `;
      container.appendChild(row);
    });
  }

  function startCountdown(){
    document.getElementById("startGameBtn").style.display="none";
    document.getElementById("timer").style.display="block";
    document.getElementById("endEarlyBtn").style.display="block";
    document.querySelectorAll('.team-question-area').forEach(el=>el.style.display='block');
    MathJax.typeset();
    timerInterval = setInterval(updateTimer,1000);
  }

  function updateTimer(){
    const min = Math.floor(totalSeconds/60);
    const sec = totalSeconds%60;
    document.getElementById("timer").textContent = `${min}:${sec.toString().padStart(2,'0')}`;
    if(totalSeconds <= 0){
      clearInterval(timerInterval);
      endGame();
    }
    if(totalSeconds <= 10){
      document.getElementById("timer").style.background="#e74c3c";
    }
    totalSeconds--;
  }

  // H√ÄM M·ªöI: X·ª≠ l√Ω giao di·ªán th·∫Øng R∆∞∆°ng B√°u
  function winGame(winningTeam) {
    clearInterval(timerInterval); 
    document.getElementById("timer").style.display = "none";
    document.getElementById("endEarlyBtn").style.display = "none";
    
    const overlay = document.getElementById("endOverlay");
    overlay.style.display = "flex";
    
    overlay.style.backgroundColor = 'rgba(255, 215, 0, 0.9)'; 
    overlay.style.color = '#e74c3c'; 
    
    document.getElementById("endOverlay").innerHTML = `
      <h1>üèÜ ${winningTeam.name} ƒê√É GI√ÄNH CHI·∫æN TH·∫ÆNG üèÜ</h1>
      <h2>üéâ ƒê∆Ø·ª¢C TH∆Ø·ªûNG TH√äM ${TREASURE_BONUS} ƒêI·ªÇM R∆Ø∆†NG B√ÅU! üéâ</h2>
      <div class="scoreboard" id="finalScores" style="color: #333;">
        ƒêi·ªÉm cu·ªëi c√πng: ${winningTeam.score}
      </div>
    `;
  }
  
  // C·∫≠p nh·∫≠t l·∫°i h√†m endGame (g·ªçi khi h·∫øt gi·ªù ho·∫∑c b·∫•m n√∫t K·∫æT TH√öC S·ªöM)
  function endGame(){
    clearInterval(timerInterval);
    document.getElementById("timer").style.display="none";
    document.getElementById("endEarlyBtn").style.display="none";
    const overlay=document.getElementById("endOverlay");
    
    // ƒê·∫£m b·∫£o overlay v·ªÅ tr·∫°ng th√°i m·∫∑c ƒë·ªãnh (v√†ng nh·∫°t)
    overlay.style.backgroundColor = 'rgba(241,196,15,0.9)';
    overlay.style.color = '#000';
    
    overlay.style.display="flex";
    
    let scoreHTML="K·∫øt qu·∫£ chung cu·ªôc:<br>";
    teams.forEach(t=>{
      const score = document.getElementById(`score-${t.id}`).textContent;
      scoreHTML += `${t.name}: ${score} ƒëi·ªÉm<br>`;
    });
    document.getElementById("finalScores").innerHTML=scoreHTML;
  }
  
  // D3. Logic c·∫≠p nh·∫≠t ƒë·ªôi (ƒê√É TH√äM LOGIC TH·∫ÆNG V√Ä TH∆Ø·ªûNG 30 ƒêI·ªÇM)
  function updateTeam(teamId, points) {
    const team = teams.find(t => t.id === teamId);
    if (team) {
      team.score += points;
      
      // N·∫øu ƒë√°p √°n ƒë√∫ng (points > 0), th√¨ tƒÉng s·ªë c√¢u h·ªèi hi·ªán t·∫°i l√™n
      if (points > 0) {
        team.currentQ++;
      }
      
      // C·∫≠p nh·∫≠t giao di·ªán
      document.getElementById(`score-${teamId}`).textContent = team.score;
      document.getElementById(`status-${teamId}`).textContent = team.currentQ;
      
      // Ki·ªÉm tra th·∫Øng cu·ªôc (7 c√¢u)
      if (team.currentQ > WINNING_QUESTION) {
        team.score += TREASURE_BONUS; // TH∆Ø·ªûNG 30 ƒêI·ªÇM
        document.getElementById(`score-${teamId}`).textContent = team.score; // C·∫≠p nh·∫≠t l·∫°i ƒëi·ªÉm th∆∞·ªüng
        winGame(team); // Chuy·ªÉn sang giao di·ªán R∆Ø∆†NG B√ÅU
      }
    }
  }

  // D3. Logic duy·ªát y√™u c·∫ßu
  window.approveSubmission = async (docId, teamId, actionType) => {
      try {
          const docRef = doc(db, "submissions", docId);
          
          if (actionType === 'skip') {
              updateTeam(teamId, -10); // B·ªè qua -10 ƒëi·ªÉm
          } else {
              // Gi·∫£ ƒë·ªãnh n·∫øu duy·ªát th√¨ ƒë√≥ l√† ƒë√°p √°n ƒë√∫ng
              updateTeam(teamId, 10); // ƒê√°p √°n ƒë√∫ng +10 ƒëi·ªÉm
          }

          // X√≥a document kh·ªèi Firestore sau khi x·ª≠ l√Ω
          await deleteDoc(docRef);
          
      } catch(e) {
          console.error("L·ªói khi duy·ªát y√™u c·∫ßu:", e);
          alert("L·ªói khi x·ª≠ l√Ω y√™u c·∫ßu duy·ªát. Xem console.");
      }
  };

  // D3. H√†m t·∫°o HTML cho y√™u c·∫ßu duy·ªát r√∫t g·ªçn
  function renderSubmissionItem(doc) {
    const data = doc.data();
    const docId = doc.id;
    const team = teams.find(t => t.id === data.teamId);
    const teamName = team ? team.name.split(' ')[1] : '???'; 
    
    let label = '';
    let bgColor = '#2c3e50'; 
    
    if (data.action === 'skip') {
      label = `${teamName}: B·ªé QUA`;
      bgColor = '#e67e22'; 
    } else {
      label = `${teamName}: ${data.answer.toUpperCase()}`;
      bgColor = '#2ecc71'; 
    }

    const div = document.createElement('div');
    div.className = 'submission-item';
    div.id = `sub-${docId}`;
    div.style.backgroundColor = bgColor;
    div.style.borderLeftColor = team ? teamColorMap[team.color] : '#f1c40f';
    div.style.alignItems = 'center';
    div.style.padding = '10px 8px';
    div.style.color = '#fff';
    div.style.textAlign = 'center';

    div.innerHTML = `
      <div style="font-size:1.4em; font-weight:bold; margin-bottom: 5px;">${label}</div>
      <button onclick="approveSubmission('${docId}', '${data.teamId}', '${data.action || 'answer'}')">DUY·ªÜT</button>
    `;
    
    return div;
  }


  // D3. H√†m l·∫Øng nghe submissions t·ª´ Firestore (ƒê√É TH√äM B·ªò ƒê·∫æM)
  function listenForSubmissions() {
    const queueContainer = document.getElementById('submission-queue-area');
    const queueCountElement = document.getElementById('queue-count');
    
    const submissionQuery = query(
      collection(db, "submissions"),
      where("status", "==", "pending")
    );

    onSnapshot(submissionQuery, (snapshot) => {
      queueCountElement.textContent = snapshot.size; 

      snapshot.docChanges().forEach((change) => {
        const doc = change.doc;
        const docId = doc.id;
        const existingItem = document.getElementById(`sub-${docId}`);

        if (change.type === "added" && !existingItem) {
          const itemElement = renderSubmissionItem(doc);
          queueContainer.insertBefore(itemElement, queueContainer.children[1]); 
        } 
        else if (change.type === "removed" && existingItem) {
          existingItem.remove();
        }
      });
    });
  }

  // ============== LOGIC RESET D·ªÆ LI·ªÜU ==============
  async function resetGameData() {
      if (!confirm("‚ö†Ô∏è C·∫¢NH B√ÅO: Thao t√°c n√†y s·∫Ω X√ìA T·∫§T C·∫¢ y√™u c·∫ßu duy·ªát ƒë√°p √°n tr√™n Firebase v√† t·∫£i l·∫°i trang. B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën RESET?")) {
          return;
      }
      
      const resetBtn = document.getElementById('resetBtn');
      resetBtn.disabled = true;
      resetBtn.textContent = "ƒêANG X√ìA...";

      try {
          const querySnapshot = await getDocs(collection(db, "submissions"));
          
          const deletePromises = [];
          querySnapshot.forEach((doc) => {
              deletePromises.push(deleteDoc(doc.ref));
          });
          
          await Promise.all(deletePromises);
          
          alert("‚úÖ ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu duy·ªát ƒë√°p √°n. T·∫£i l·∫°i trang ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i.");
          window.location.reload(); // T·∫£i l·∫°i trang
          
      } catch (e) {
          console.error("L·ªói khi reset d·ªØ li·ªáu:", e);
          alert("‚ùå L·ªñI: Kh√¥ng th·ªÉ reset d·ªØ li·ªáu. Xem console ƒë·ªÉ bi·∫øt chi ti·∫øt.");
      } finally {
          resetBtn.disabled = false;
          resetBtn.textContent = "üí£ RESET D·ªÆ LI·ªÜU";
      }
  }


  // === G·∫ÆN S·ª∞ KI·ªÜN CHO T·∫§T C·∫¢ C√ÅC N√öT (S·ª≠a l·ªói onclick) ===
  document.addEventListener('DOMContentLoaded', () => {
    // 1. N√∫t B·∫ÆT ƒê·∫¶U V√íNG 3!
    const startBtn = document.getElementById("startBtn");
    if (startBtn) {
      startBtn.addEventListener('click', showGame);
    }
    
    // 2. N√∫t START (·ªü giao di·ªán 2)
    const startGameBtn = document.getElementById("startGameBtn");
    if (startGameBtn) {
        startGameBtn.addEventListener('click', startCountdown);
    }

    // 3. N√∫t RESET D·ªÆ LI·ªÜU
    const resetBtn = document.getElementById("resetBtn");
    if (resetBtn) {
        resetBtn.addEventListener('click', resetGameData);
    }

    // 4. N√∫t K·∫æT TH√öC S·ªöM
    const endEarlyBtn = document.getElementById("endEarlyBtn");
    if (endEarlyBtn) {
        endEarlyBtn.addEventListener('click', endGame);
    }
  });

</script>
</body>
</html>
