<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M·∫≠t M√£ R∆∞∆°ng B√°u - GV (·∫®n QR + X√≥a "C√¢u")</title>

<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
<script>
window.MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
  svg: { fontCache: 'global' }
};
</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>
/* ... (GI·ªÆ NGUY√äN C√ÅC STYLE C≈®) ... */
body {
  font-family:'Arial',sans-serif;
  background:#1e1e1e;
  color:#fff;
  margin:0;
  padding:0;
  overflow-x:hidden;
}
h1 { color:#f1c40f; margin:12px 0; text-align:center; }
#timer {
  position:fixed;
  top:8px; left:12px;
  font-size:2.2em; font-weight:bold;
  color:#e74c3c; background:#f1c40f;
  padding:4px 12px; border-radius:8px;
  display:none;
  z-index:10;
}
#endEarlyBtn {
  position:fixed;
  top:15px; left:130px;
  font-size:1.1em;
  background:#e67e22;
  color:white;
  border:none;
  border-radius:8px;
  padding:6px 14px;
  font-weight:bold;
  cursor:pointer;
  display:none;
  z-index:10;
}

/* === QR ·ªü giao di·ªán ƒë·∫ßu === */
#qr-list {
  display:flex !important;
  flex-wrap:wrap;
  justify-content:center;
  align-items:center;
  gap:12px;
  margin-top:20px;
}
.qr-item {
  width:180px;
  margin:10px;
  padding:10px;
  border-radius:8px;
  background:white;
  color:#333;
  text-align:center;
  font-weight:bold;
  border: 2px solid transparent;
}
.qr-item img {
  width:150px; height:150px;
  border:2px solid transparent;
  margin-bottom:5px;
}
.qr-item.team-red {
    border-color: #e74c3c; 
}
.qr-item.team-blue {
    border-color: #3498db; 
}
.qr-item.team-green {
    border-color: #2ecc71; 
}
.qr-item.team-yellow {
    border-color: #f1c40f; 
}
.qr-item.team-purple {
    border-color: #9b59b6; 
}

/* === GIAO DI·ªÜN 2 === */
#game-wrapper { display:none; position:relative; }
.game-layout {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: flex-start;
  width: 100%;
  margin: 0;
  padding: 0 10px;
  box-sizing: border-box;
}

/* C·ªôt tr√°i: c√°c ƒë·ªôi */
#team-rows-container {
  flex: 1;
  margin-right: 15px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
}

/* C·ªôt ph·∫£i: h√†ng ƒë·ª£i */
#submission-queue-area {
  width: 120px;
  background: #34495e;
  border-radius: 10px;
  padding: 8px;
  height: calc(100vh - 40px);
  overflow-y: auto;
  position: fixed;
  right: 0;
  top: 0;
}
#submission-queue-area h2 {
  font-size: 1em;
  text-align: center;
  color: #f1c40f;
  margin-bottom: 10px;
}

/* === KHUNG M·ªñI ƒê·ªòI === */
.team-row {
  display:flex;
  align-items:center;
  justify-content:flex-start;
  width:100%;
  padding:8px 18px;
  border-radius:10px;
  box-shadow:0 2px 5px rgba(0,0,0,0.4);
  min-height:95px;
}
.team-red{background:#e74c3c;}
.team-blue{background:#3498db;}
.team-green{background:#2ecc71;}
.team-yellow{background:#f1c40f;color:#333;}
.team-purple{background:#9b59b6;}

.team-score-control {
  width:160px;
  display:flex;
  flex-direction:row;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.team-score-value {
  font-size:2.5em;
  font-weight:900;
  background:rgba(255,255,255,0.25);
  padding:2px 12px;
  border-radius:8px;
}
/* THAY TH·∫æ .q-status-item C≈® B·∫∞NG C√ÅC STYLE M·ªöI CHO THANH TR·∫†NG TH√ÅI */
/* T√¨nh tr·∫°ng c√¢u h·ªèi */
.q-status-bar {
  display: flex;
  flex-direction: row;
  gap: 4px;
  margin-bottom: 5px;
}
.q-status-item {
  width: 25px; /* Gi·∫£m k√≠ch th∆∞·ªõc */
  height: 25px;
  line-height: 25px;
  border-radius: 50%;
  font-size: 0.8em;
  font-weight: bold;
  color: white;
  background: #34495e; /* M√†u n·ªÅn ch·ªù */
  display: flex;
  justify-content: center;
  align-items: center;
}
.q-status-item.status-correct {
  background: #2ecc71; /* Xanh l√°: ƒê√∫ng */
}
.q-status-item.status-ready {
  background: #f1c40f; /* V√†ng: C√¢u hi·ªán t·∫°i */
  color: #333;
  border: 2px solid #e74c3c;
}
.team-status-area {
  padding-left: 20px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  flex: 1;
}
.team-question-area {
  flex: 3;
  padding-left: 20px;
  display:none; 
}
.q-number {
    font-size: 1em;
    font-weight: bold;
    color: #e67e22;
}

/* H√†ng ƒë·ª£i duy·ªát ƒë√°p √°n */
.submission-item {
  padding:8px;
  margin-bottom:8px;
  background:#2c3e50;
  border-radius:6px;
  display:flex;
  flex-direction:column;
  align-items:center;
  border-left:4px solid #f1c40f;
}
.submission-item b { color:#f1c40f; }
.submission-item button {
  padding:5px 10px;
  background:#e67e22;
  color:white;
  border:none;
  border-radius:5px;
  font-weight:bold;
  margin-top:5px;
  font-size:0.9em;
}

/* START BUTTON */
#startGameBtn {
  position:absolute;
  top:0px; 
  left:100px;
  transform:translate(-50%, -50%);
  font-size:2em;
  padding:14px 30px;
  border:none;
  border-radius:10px;
  background:#2ecc71;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
  display:none;
  z-index:10;
}

/* OVERLAY K·∫æT TH√öC C≈® (S·∫º D√ôNG L√ÄM M√ÄN H√åNH T·ªîNG K·∫æT ƒêI·ªÇM) */
#endOverlay {
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(241,196,15,0.9);
  color:#000;
  z-index:20;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  text-align:center;
}
#endOverlay h1 {
  font-size:3em;
  margin-bottom:20px;
}
#endOverlay .scoreboard {
  font-size:2em;
  line-height:1.5;
  font-weight:bold;
}
</style>
</head>

<body>
  <h1>CHI·∫æN TH·∫ÆNG KHI HO√ÄN TH√ÄNH 7 C√ÇU H·ªéI NHANH NH·∫§T</h1>
  <div id="qr-list"></div>

  <button id="startBtn" onclick="showGame()" style="padding:12px 22px;font-size:1.2em;background:#f1c40f;color:#222;border:none;border-radius:8px;margin:20px;font-weight:bold;cursor:pointer;">
    B·∫ÆT ƒê·∫¶U V√íNG 3!
  </button>

  <div id="game-wrapper">
    <div id="timer">10:00</div>
    <button id="endEarlyBtn" onclick="endGame()">K·∫æT TH√öC S·ªöM</button>
    <button id="startGameBtn" onclick="startCountdown()">START</button>
    <div class="game-layout">
      <div id="team-rows-container"></div>
      <div id="submission-queue-area">
        <h2>H√ÄNG ƒê·ª¢I DUY·ªÜT ƒê√ÅP √ÅN</h2>
      </div>
    </div>
  </div>

  <div id="endOverlay">
    <h1>üèÜ TR√í CH∆†I K·∫æT TH√öC üèÜ</h1>
    <div class="scoreboard" id="finalScores"></div>
    <button onclick="showChestScreen()" style="font-size:1.5em; padding:10px 20px; background:#e67e22; color:white; border:none; border-radius:8px; cursor:pointer; margin-top: 20px;">
        TRAO M√É R∆Ø∆†NG B√ÅU!
    </button>
  </div>
  
  <div id="chest-screen" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(44,62,80,0.95); color:white; z-index:30; justify-content:center; align-items:center; flex-direction:column; text-align:center;">
      <h1>üéâ ƒê·ªòI CHI·∫æN TH·∫ÆNG: <span id="chest-winner" style="color:#f1c40f;">T√äN ƒê·ªòI</span> üéâ</h1>
      <p style="font-size:2em; margin: 30px 0;">M√É S·ªê R∆Ø∆†NG B√ÅU:</p>
      <div style="font-size:5em; font-weight:bold; color:#2ecc71; border:5px solid #2ecc71; padding:20px 40px; border-radius:15px; background:white;">
          <span id="secret-code">1134</span>
      </div>
      <p style="font-size:1.5em; margin-top: 20px;">*D·∫∑n h·ªçc sinh nh·∫≠p m√£ n√†y v√†o ƒëi·ªán tho·∫°i ƒë·ªÉ m·ªü r∆∞∆°ng*</p>
  </div>


<script>
// Bi·∫øn to√†n c·ª•c t·ª´ logic c≈©
let timerInterval;
let totalSeconds = 600; // 10 ph√∫t

// D·ªØ li·ªáu teams cho logic QR Code
const teamsData = [
    { name: "ƒê·ªôi ƒê·ªè", color: "team-red", id: "red", score: 0 },
    { name: "ƒê·ªôi Xanh", color: "team-blue", id: "blue", score: 0 },
    { name: "ƒê·ªôi L·ª•c", color: "team-green", id: "green", score: 0 },
    { name: "ƒê·ªôi V√†ng", color: "team-yellow", id: "yellow", score: 0 },
    { name: "ƒê·ªôi T√≠m", color: "team-purple", id: "purple", score: 0 }
];

window.onload = function() {
  const qrList = document.getElementById("qr-list");
  qrList.innerHTML = "";
  // S·ª≠a baseURL ƒë·ªÉ ƒë·∫£m b·∫£o d·∫´n ƒë·∫øn hs.html
  const baseURL = location.href.replace(/[^/]*$/, "") + "hs.html"; 
  teamsData.forEach(team => {
    const div = document.createElement("div");
    div.className = "qr-item " + team.color; 
    div.innerHTML = `<div>${team.name}</div><div id="qr-${team.id}"></div>`;
    qrList.appendChild(div);
    new QRCode(document.getElementById("qr-" + team.id), {
      text: `${baseURL}?teamId=${team.id}`,
      width: 150,
      height: 150
    });
  });
};

// H√†m c≈©: X·ª≠ l√Ω chuy·ªÉn m√†n h√¨nh
window.showGame = function() {
    const qrList = document.getElementById("qr-list");
    if (qrList) qrList.remove();

    document.getElementById("startBtn").style.display="none";
    document.getElementById("game-wrapper").style.display="block";
    
    // G·ªçi h√†m renderTeams M·ªöI (t·ª´ Firebase logic)
    window.renderTeamRows();
    
    document.getElementById("startGameBtn").style.display="block";
};

// H√†m c≈©: B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c (GV b·∫•m START)
window.startCountdown = function(){
    document.getElementById("startGameBtn").style.display="none";
    document.getElementById("timer").style.display="block";
    document.getElementById("endEarlyBtn").style.display="block";
    document.querySelectorAll('.team-question-area').forEach(el=>el.style.display='block');
    
    // KH·ªûI ƒê·ªòNG GAME FIREBASE
    window.startGame(); 
    
    // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c th·ªùi gian (logic timer c≈©)
    window.MathJax.typeset();
    timerInterval = setInterval(updateTimer,1000);
};

// H√†m c≈©: C·∫≠p nh·∫≠t ƒë·ªìng h·ªì (Logic timer c≈©)
function updateTimer(){
    if (!window.gameActive) return clearInterval(timerInterval); 
    
    const min = Math.floor(totalSeconds/60);
    const sec = totalSeconds%60;
    document.getElementById("timer").textContent = `${min}:${sec.toString().padStart(2,'0')}`;
    
    if(totalSeconds <= 0){
        clearInterval(timerInterval);
        // GV b·∫•m K·∫æT TH√öC S·ªöM (ho·∫∑c h·∫øt gi·ªù)
        window.endGameFirebase(true); 
    }
    if(totalSeconds <= 10){
        document.getElementById("timer").style.background="#e74c3c";
    }
    totalSeconds--;
}

// H√†m c≈©: K·∫øt th√∫c game (GV b·∫•m K·∫æT TH√öC S·ªöM)
window.endGame = function(){
    clearInterval(timerInterval);
    // GV b·∫•m K·∫æT TH√öC S·ªöM
    window.endGameFirebase(false); 
};
</script>

<script type="module">
    // ---------------------------------------------------
    // 1. IMPORT FIREBASE C√ÅC CH·ª®C NƒÇNG C·∫¶N THI·∫æT
    // ---------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, deleteDoc, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // ---------------------------------------------------
    // 2. C·∫§U H√åNH FIREBASE C·ª¶A B·∫†N 
    // ---------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyDfcMrblRonAS9Q7BSfD9ZZYeOmSy4UjfQ",
        authDomain: "nutnhap.firebaseapp.com",
        projectId: "nutnhap",
        storageBucket: "nutnhap.firebasestorage.app",
        messagingSenderId: "359344838873",
        appId: "1:359344838873:web:d1746d32920881091c86c8",
        measurementId: "G-0VTTNLWDD9"
    };

    // 3. KH·ªûI T·∫†O FIREBASE
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------------------------------------------------
    // 4. C·∫§U H√åNH GAME
    // ---------------------------------------------------
    const POINTS_PER_CORRECT = 10;
    const PENALTY_PER_SKIP = 10; // ƒê√£ s·ª≠a t·ª´ 20 th√†nh 10 theo y√™u c·∫ßu "b·ªã tr·ª´ 10 ƒëi·ªÉm"
    const BONUS_POINTS = 30;
    const FINAL_SECRET_CODE = '1134'; // M√£ s·ªë R∆Ø∆†NG B√ÅU
    
    let firstWinningTeam = null;
    window.gameActive = false; // D√πng window.gameActive ƒë·ªÉ li√™n k·∫øt v·ªõi logic timer c≈©
    
    // D·ªÆ LI·ªÜU C√ÇU H·ªéI (GI·ªÆ NGUY√äN T·ª™ C·ª¶A B·∫†N)
    const ALL_TEAM_QUESTIONS = {
        red: [{ q: 'Cho CSC c√≥ $u_1=3$ v√† c√¥ng sai $d=2$. T√¨m $u_{10}$.', correct: '21' }, { q: 'Cho CSN c√≥ $u_1=2$ v√† c√¥ng b·ªôi $q=2$. T√¨m $u_5$.', correct: '32' }, { q: 'Cho CSC c√≥ $u_1=2, u_5=18$. T√¨m c√¥ng sai $d$.', correct: '4' }, { q: 'Cho CSN c√≥ $u_1=3, u_3=12$. T√¨m c√¥ng b·ªôi $q$ d∆∞∆°ng.', correct: '2' }, { q: 'Cho CSC c√≥ $u_1=5, d=2$. T√¨m t·ªïng $S_5$.', correct: '45' }, { q: 'Cho CSN c√≥ $u_1=3, q=2$. T√¨m t·ªïng $S_4$.', correct: '45' }, { q: 'Cho CSC c√≥ $u_1=5, d=3$. Bi·∫øt $u_n=32$. T√¨m $n$.', correct: '10' } ],
        blue: [{ q: 'Cho CSC c√≥ $u_1=10, d=3$. T√¨m $u_8$.', correct: '31' }, { q: 'Cho CSN c√≥ $u_1=3, q=2$. T√¨m $u_4$.', correct: '24' }, { q: 'Cho CSC c√≥ $u_1=3, u_5=15$. T√¨m c√¥ng sai $d$.', correct: '3' }, { q: 'Cho CSN c√≥ $u_1=2, u_3=50$. T√¨m c√¥ng b·ªôi $q$ d∆∞∆°ng.', correct: '5' }, { q: 'Cho CSC c√≥ $u_1=5, d=2$. T√¨m t·ªïng $S_5$.', correct: '45' }, { q: 'Cho CSN c√≥ $u_1=3, q=2$. T√¨m t·ªïng $S_4$.', correct: '45' }, { q: 'Cho CSN c√≥ $u_1=2, q=2$. Bi·∫øt $u_n=64$. T√¨m $n$.', correct: '6' } ],
        green: [{ q: 'Cho CSC c√≥ $u_1=5, d=4$. T√¨m $u_6$.', correct: '25' }, { q: 'Cho CSN c√≥ $u_1=4, q=3$. T√¨m $u_3$.', correct: '36' }, { q: 'Cho CSC c√≥ $u_1=10, u_5=30$. T√¨m c√¥ng sai $d$.', correct: '5' }, { q: 'Cho CSN c√≥ $u_1=5, u_3=45$. T√¨m c√¥ng b·ªôi $q$ d∆∞∆°ng.', correct: '3' }, { q: 'Cho CSC c√≥ $u_1=2, u_6=12$. T√¨m t·ªïng $S_6$.', correct: '42' }, { q: 'Cho CSN c√≥ $u_1=4, q=2$. T√¨m t·ªïng $S_3$.', correct: '28' }, { q: 'Cho CSC c√≥ $u_1=2, d=4$. Bi·∫øt $u_n=26$. T√¨m $n$.', correct: '7' } ],
        yellow: [{ q: 'Cho CSC c√≥ $u_1=2, d=5$. T√¨m $u_7$.', correct: '32' }, { q: 'Cho CSN c√≥ $u_1=2, q=3$. T√¨m $u_4$.', correct: '54' }, { q: 'Cho CSC c√≥ $u_1=4, u_5=28$. T√¨m c√¥ng sai $d$.', correct: '6' }, { q: 'Cho CSN c√≥ $u_1=2, u_3=50$. T√¨m c√¥ng b·ªôi $q$ d∆∞∆°ng.', correct: '5' }, { q: 'Cho CSC c√≥ $u_1=1, d=3$. T√¨m t·ªïng $S_4$.', correct: '22' }, { q: 'Cho CSN c√≥ $u_1=5, q=-2$. T√¨m t·ªïng $S_3$.', correct: '15' }, { q: 'Cho CSN c√≥ $u_1=3, q=2$. Bi·∫øt $u_n=48$. T√¨m $n$.', correct: '5' } ],
        purple: [{ q: 'Cho CSC c√≥ $u_1=3, d=4$. T√¨m $u_5$.', correct: '19' }, { q: 'Cho CSN c√≥ $u_1=5, q=2$. T√¨m $u_4$.', correct: '40' }, { q: 'Cho CSC c√≥ $u_1=5, u_5=29$. T√¨m c√¥ng sai $d$.', correct: '6' }, { q: 'Cho CSN c√≥ $u_1=4, u_3=100$. T√¨m c√¥ng b·ªôi $q$ d∆∞∆°ng.', correct: '5' }, { q: 'Cho CSC c√≥ $u_1=10, d=-1$. T√¨m t·ªïng $S_5$.', correct: '40' }, { q: 'Cho CSN c√≥ $u_1=4, q=3$. T√¨m t·ªïng $S_3$.', correct: '52' }, { q: 'Cho CSC c√≥ $u_1=10, d=-2$. Bi·∫øt $u_n=0$. T√¨m $n$.', correct: '6' } ]
    };
    
    // D·ªØ li·ªáu 5 ƒê·ªòI CH∆†I
    const teamDataInitial = [
        { id: 'red', name: 'ƒê·ªôi ƒê·ªè', colorClass: 'team-red', score: 0, currentQuestionIndex: 0, manhMoiCompletedState: new Array(7).fill(false), gameStatus: 'waiting', hasWon: false },
        { id: 'blue', name: 'ƒê·ªôi Xanh', colorClass: 'team-blue', score: 0, currentQuestionIndex: 0, manhMoiCompletedState: new Array(7).fill(false), gameStatus: 'waiting', hasWon: false },
        { id: 'green', name: 'ƒê·ªôi L√°', colorClass: 'team-green', score: 0, currentQuestionIndex: 0, manhMoiCompletedState: new Array(7).fill(false), gameStatus: 'waiting', hasWon: false },
        { id: 'yellow', name: 'ƒê·ªôi V√†ng', colorClass: 'team-yellow', score: 0, currentQuestionIndex: 0, manhMoiCompletedState: new Array(7).fill(false), gameStatus: 'waiting', hasWon: false },
        { id: 'purple', name: 'ƒê·ªôi T√≠m', colorClass: 'team-purple', score: 0, currentQuestionIndex: 0, manhMoiCompletedState: new Array(7).fill(false), gameStatus: 'waiting', hasWon: false },
    ];
    let teams = JSON.parse(JSON.stringify(teamDataInitial)); // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa ƒë·ªôi

    // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u tr·ªØ h√†ng ƒë·ª£i ƒë√°p √°n
    window.submissionsQueue = [];

    // ---------------------------------------------------
    // 5. C√ÅC H√ÄM X·ª¨ L√ù CH√çNH
    // ---------------------------------------------------

    // H√ÄM M·ªöI: Reset tr·∫°ng th√°i game v√† teams trong Firestore
    async function resetGameAndTeamsInFirestore() {
        teams = JSON.parse(JSON.stringify(teamDataInitial)); // Reset bi·∫øn local
        firstWinningTeam = null;
        try {
            const teamPromises = teams.map(team => {
                const teamDocRef = doc(db, "teams", team.id);
                return setDoc(teamDocRef, {
                    ...team,
                    hasWon: false,
                    currentQuestionIndex: 0,
                    score: 0,
                    gameStatus: 'playing', // ƒê·∫∑t tr·∫°ng th√°i playing ngay t·ª´ ƒë·∫ßu
                    secretCode: FINAL_SECRET_CODE 
                }, { merge: true }); 
            });
            await Promise.all(teamPromises);
        } catch (e) {
            console.error("L·ªói khi reset Firestore:", e);
            alert("L·ªói: Kh√¥ng th·ªÉ reset tr·∫°ng th√°i tr√≤ ch∆°i tr√™n server.");
        }
    }

    // H√†m ch√≠nh kh·ªüi ch·∫°y game v√† l·∫Øng nghe Firebase
    window.startGame = async function() {
        if (window.gameActive) return;
        
        await resetGameAndTeamsInFirestore(); 
        
        window.gameActive = true;
        window.renderTeamRows();
        window.listenForSubmissions();
    };

    // H√†m l·∫Øng nghe h√†ng ƒë·ª£i submissions v√† c·∫≠p nh·∫≠t m√†n h√¨nh GV (FIREBASE)
    window.listenForSubmissions = function() {
        const q = query(collection(db, "submissions"), orderBy("timestamp", "asc"));
        
        onSnapshot(q, (snapshot) => {
            window.submissionsQueue = [];
            snapshot.forEach((doc) => {
                window.submissionsQueue.push({ id: doc.id, ...doc.data() });
            });
            
            // L·∫Øng nghe tr·∫°ng th√°i teams ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán ƒë·ªôi
            listenForTeamUpdates();
            
            window.renderSubmissionQueue();
        });
    }

    // H√ÄM M·ªöI: L·∫Øng nghe tr·∫°ng th√°i c·ªßa T·∫§T C·∫¢ c√°c ƒë·ªôi
    function listenForTeamUpdates() {
        teams.forEach(team => {
            const teamDocRef = doc(db, "teams", team.id);
            onSnapshot(teamDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const teamData = docSnap.data();
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i local
                    const localTeam = teams.find(t => t.id === teamData.id);
                    if (localTeam) {
                        localTeam.score = teamData.score;
                        localTeam.currentQuestionIndex = teamData.currentQuestionIndex;
                        localTeam.manhMoiCompletedState = teamData.manhMoiCompletedState;
                        localTeam.hasWon = teamData.hasWon;
                        
                        if (localTeam.hasWon && !firstWinningTeam) {
                            firstWinningTeam = localTeam.id; // Ghi nh·∫≠n ƒë·ªôi th·∫Øng ƒë·∫ßu ti√™n
                        }
                        // C·∫≠p nh·∫≠t giao di·ªán khi c√≥ thay ƒë·ªïi tr·∫°ng th√°i
                        window.updateScoreDisplay(); 
                    }
                }
            });
        });
    }

    // H√ÄM DUY·ªÜT ƒê√ÅP √ÅN V√Ä X·ª¨ L√ù LOGIC (FIREBASE)
    window.handleReviewSubmission = async function(submissionId) {
        if (!window.gameActive) return alert("Tr√≤ ch∆°i ch∆∞a b·∫Øt ƒë·∫ßu ho·∫∑c ƒë√£ k·∫øt th√∫c!");

        const submission = submissionsQueue.find(sub => sub.id === submissionId);
        if (!submission) return;

        const teamId = submission.teamId;
        const team = teams.find(t => t.id === teamId);
        if (!team) return;

        const teamDocRef = doc(db, "teams", teamId);
        const teamSnap = await getDoc(teamDocRef);
        if (!teamSnap.exists()) return;
        const teamData = teamSnap.data();
        
        const currentQIndex = teamData.currentQuestionIndex;
        const totalQuestions = ALL_TEAM_QUESTIONS[teamId].length;

        if (currentQIndex >= totalQuestions) {
            alert(`${team.name} ƒë√£ ho√†n th√†nh ${totalQuestions} c√¢u. Y√™u c·∫ßu n√†y b·ªã b·ªè qua.`);
            await deleteDoc(doc(db, "submissions", submissionId));
            return;
        }
        
        let newScore = teamData.score;
        let newQIndex = currentQIndex;
        let newCompletedState = teamData.manhMoiCompletedState;
        let hasWon = teamData.hasWon;
        let updateData = {};
        
        if (submission.action === 'skip') {
            // X·ª≠ l√Ω B·ªé QUA: tr·ª´ 10 ƒëi·ªÉm v√† chuy·ªÉn c√¢u
            newScore = newScore - PENALTY_PER_SKIP;
            newQIndex++;
        } else {
            // X·ª≠ l√Ω G·ª¨I ƒê√ÅP √ÅN
            const correctAns = ALL_TEAM_QUESTIONS[teamId][currentQIndex].correct;
            const isCorrect = submission.answer.trim().toLowerCase() === correctAns.toLowerCase();
            
            if (isCorrect) {
                newScore += POINTS_PER_CORRECT;
                newCompletedState[currentQIndex] = true;
                newQIndex++;
                
                // Ki·ªÉm tra ƒëi·ªÅu ki·ªán th·∫Øng (ho√†n th√†nh 7 c√¢u)
                if (newQIndex >= totalQuestions && !hasWon) {
                    newScore += BONUS_POINTS; 
                    hasWon = true; // ƒê·ªôi th·∫Øng
                    updateData.gameStatus = 'won'; // Chuy·ªÉn tr·∫°ng th√°i ƒë·ªÉ k√≠ch ho·∫°t giao di·ªán R∆∞∆°ng B√°u
                }
            } else {
                // Kh√¥ng ch√≠nh x√°c: HS ti·∫øp t·ª•c nh·∫≠p ƒë√°p √°n (Kh√¥ng l√†m g√¨ v·ªõi ƒëi·ªÉm v√† c√¢u h·ªèi)
            }
        }

        // C·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i team trong Firestore
        updateData = {
            ...updateData,
            score: newScore,
            currentQuestionIndex: newQIndex < totalQuestions ? newQIndex : totalQuestions,
            manhMoiCompletedState: newCompletedState,
            hasWon: hasWon,
        };
        await updateDoc(teamDocRef, updateData);
        
        // X√≥a submission kh·ªèi h√†ng ƒë·ª£i
        await deleteDoc(doc(db, "submissions", submissionId));
        
        window.checkWinCondition();
    }

    // H√ÄM RENDER H√ÄNG ƒê·ª¢I ƒê√ÅP √ÅN (ƒê√É CH·ªàNH S·ª¨A)
    window.renderSubmissionQueue = function() {
        const queueContainer = document.getElementById('submission-queue-area');
        if (!queueContainer) return;
        
        let html = `<h2>H√ÄNG ƒê·ª¢I DUY·ªÜT ƒê√ÅP √ÅN (${submissionsQueue.length} ƒë·ªôi)</h2>`;
        
        if (submissionsQueue.length === 0) {
            html += '<p style="color:#7f8c8d; text-align:center;">Ch∆∞a c√≥ ƒë·ªôi n√†o g·ª≠i ƒë√°p √°n.</p>';
        } else {
            html += '<div style=" padding: 10px; border-radius: 8px;">';
            
            submissionsQueue.forEach((sub, index) => {
                const team = teams.find(t => t.id === sub.teamId);
                if (!team) return;
                
                const teamName = team.name;
                const qIndex = team.currentQuestionIndex < ALL_TEAM_QUESTIONS[team.id].length ? team.currentQuestionIndex : ALL_TEAM_QUESTIONS[team.id].length - 1;
                
                const timeStr = sub.timestamp ? new Date(sub.timestamp.seconds * 1000).toLocaleTimeString() : 'ƒêang t·∫£i...';
                
                // ... (Logic m√†u n·ªÅn gi·ªØ nguy√™n) ...
                let bgColor = '#2c3e50';
                let textColor = 'white';
                const teamColorClass = team.colorClass || '';
                if (teamColorClass === 'team-yellow') {bgColor = '#f1c40f';textColor = '#333';} 
                else if (teamColorClass === 'team-red') {bgColor = '#e74c3c';} 
                else if (teamColorClass === 'team-blue') {bgColor = '#3498db';} 
                else if (teamColorClass === 'team-green') {bgColor = '#2ecc71';} 
                else if (teamColorClass === 'team-purple') {bgColor = '#9b59b6';}

                let submissionContent = '';
                if (sub.action === 'skip') {
                    submissionContent = `<span>Y√™u c·∫ßu: <strong style="font-size: 1.2em; color: ${textColor === 'white' ? '#f1c40f' : '#e67e22'};">B·ªé QUA</strong></span>`;
                } else {
                    submissionContent = `<span>ƒê√°p √°n: <strong style="font-size: 1.2em; color: ${textColor === 'white' ? '#f1c40f' : '#e67e22'};">${sub.answer}</strong></span>`;
                }
                
                html += `
                    <div class="submission-item" style="background-color: ${bgColor}; color: ${textColor}; border-left-color: #f1c40f;">
                        <span style="font-weight: bold; font-size: 1.1em;">${index + 1}. ${teamName} (C√¢u ${qIndex + 1}):</span>
                        ${submissionContent}
                        <span>L√∫c: ${timeStr}</span>
                        <button onclick="handleReviewSubmission('${sub.id}')">
                            DUY·ªÜT
                        </button>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        queueContainer.innerHTML = html;
    }

    // H√ÄM T·∫†O GIAO DI·ªÜN H√ÄNG ƒê·ªòI
    window.renderTeamRows = function() {
        const container = document.getElementById('team-rows-container');
        let html = '';
        
        teams.forEach(team => {
            const currentQ = team.currentQuestionIndex;
            const totalQ = ALL_TEAM_QUESTIONS[team.id].length;
            
            const qDisplay = currentQ < totalQ ? ALL_TEAM_QUESTIONS[team.id][currentQ].q : "ƒê√É HO√ÄN TH√ÄNH 7/7 C√ÇU! ƒêANG CH·ªú M√É R∆Ø∆†NG.";
            const qNumber = currentQ < totalQ ? `M√ÉNH M·ªêI ${currentQ + 1}` : 'HO√ÄN TH√ÄNH';

            let statusHtml = '<div class="q-status-bar">';
            for (let i = 0; i < totalQ; i++) {
                let statusClass = team.manhMoiCompletedState[i] ? 'status-correct' : (i === currentQ ? 'status-ready' : '');
                statusHtml += `<div class="q-status-item ${statusClass}">${i + 1}</div>`;
            }
            statusHtml += '</div>';

            html += `
                <div class="team-row ${team.colorClass}">
                    <div class="team-score-control">
                        <div class="team-score-value" id="score-${team.id}">${team.score}</div>
                        <span style="font-weight: bold; font-size: 0.8em;">${team.name.toUpperCase()}</span>
                    </div>
                    
                    <div class="team-status-area">
                        ${statusHtml}
                        <div id="status-message-${team.id}" style="font-weight: bold; font-size: 0.9em; margin-top: 5px;">
                            ${(team.hasWon ? 'ƒê√É TH·∫ÆNG!' : 'Ch·ªù ƒë·ªôi g·ª≠i ƒë√°p √°n qua QR...')}
                        </div>
                    </div>

                    <div class="team-question-area" style="display: ${window.gameActive ? 'block' : 'none'};">
                        <div class="q-number">${qNumber}</div>
                        <div class="q-text" id="q-text-${team.id}">
                            ${qDisplay}
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        if (window.MathJax) {
            window.MathJax.typesetPromise([container]);
        }
    }


    window.updateScoreDisplay = function() {
        const totalQuestions = ALL_TEAM_QUESTIONS[teams[0].id].length; 
        teams.forEach(team => {
            document.getElementById(`score-${team.id}`).textContent = team.score;
            
            const currentQ = team.currentQuestionIndex;
            
            const qDisplay = currentQ < totalQuestions ? ALL_TEAM_QUESTIONS[team.id][currentQ].q : "ƒê√É HO√ÄN TH√ÄNH 7/7 C√ÇU! ƒêANG CH·ªú M√É R∆Ø∆†NG.";
            const qNumber = currentQ < totalQuestions ? `M√ÉNH M·ªêI ${currentQ + 1}` : 'HO√ÄN TH√ÄNH';
            
            const teamRow = document.querySelector(`.team-row.${team.colorClass}`);
            if (!teamRow) return;

            // C·∫≠p nh·∫≠t Status Bar
            let statusHtml = '<div class="q-status-bar">';
            for (let i = 0; i < totalQuestions; i++) {
                let statusClass = team.manhMoiCompletedState[i] ? 'status-correct' : (i === currentQ ? 'status-ready' : '');
                statusHtml += `<div class="q-status-item ${statusClass}">${i + 1}</div>`;
            }
            statusHtml += '</div>';
            
            // C·∫≠p nh·∫≠t Question Area
            const qArea = teamRow.querySelector('.team-question-area');
            if (qArea) {
                qArea.querySelector('.q-number').textContent = qNumber;
                qArea.querySelector('.q-text').innerHTML = qDisplay;
            }

            // C·∫≠p nh·∫≠t Status Area
            const statusArea = teamRow.querySelector('.team-status-area');
            if (statusArea) {
                statusArea.innerHTML = statusHtml + `<div id="status-message-${team.id}" style="font-weight: bold; font-size: 0.9em; margin-top: 5px;">${(team.hasWon ? 'ƒê√É TH·∫ÆNG!' : 'Ch·ªù ƒë·ªôi g·ª≠i ƒë√°p √°n qua QR...')}</div>`;
            }
            
        });
        if (window.MathJax) {
            window.MathJax.typesetPromise([document.getElementById('team-rows-container')]);
        }
    }

    window.checkWinCondition = function() {
        const completedTeam = teams.find(t => t.currentQuestionIndex === ALL_TEAM_QUESTIONS[t.id].length && t.hasWon);
        
        if (completedTeam && !firstWinningTeam) {
            firstWinningTeam = completedTeam.id;
        }
    }

    // H√ÄM K·∫æT TH√öC FIREBASE
    window.endGameFirebase = function(isTimeUp) {
        if (!window.gameActive) return;
        window.gameActive = false;
        
        document.getElementById("timer").style.display="none";
        document.getElementById("endEarlyBtn").style.display="none";
        
        const teamPromises = teams.map(team => {
            const teamDocRef = doc(db, "teams", team.id);
            return updateDoc(teamDocRef, {
                gameStatus: 'finished'
            });
        });
        
        Promise.all(teamPromises).then(() => {
            window.showFinalMessage(isTimeUp);
        });
    }

    window.showFinalMessage = function(isTimeUp) {
        const sortedTeams = [...teams].sort((a, b) => {
            if (a.id === firstWinningTeam && b.id !== firstWinningTeam) return -1;
            if (b.id === firstWinningTeam && a.id !== firstWinningTeam) return 1;
            return b.score - a.score;
        });
        
        let rankingHtml = '<ol style="text-align: left; list-style-position: inside;">';
        sortedTeams.forEach((team, index) => {
            let status = (team.id === firstWinningTeam) ? ' (TH·∫ÆNG CU·ªòC!)' : '';
            rankingHtml += `<li style="margin: 10px 0; font-weight: bold;">#${index + 1}: ${team.name} - ${team.score} ƒëi·ªÉm ${status}</li>`;
        });
        rankingHtml += '</ol>';

        document.getElementById('finalScores').innerHTML = rankingHtml; 
        
        document.getElementById('game-wrapper').style.display = 'none';
        document.getElementById('endOverlay').style.display = 'flex'; 
    }

    window.showChestScreen = function() {
        const winner = teams.find(t => t.id === firstWinningTeam);
        if (winner) {
            document.getElementById('chest-winner').textContent = winner.name.toUpperCase();
            document.getElementById('secret-code').textContent = FINAL_SECRET_CODE;
        } else {
            const topScoreTeam = teams.sort((a, b) => b.score - a.score)[0];
            document.getElementById('chest-winner').textContent = topScoreTeam.name.toUpperCase() + ' (CAO ƒêI·ªÇM NH·∫§T)';
            document.getElementById('secret-code').textContent = 'CH∆ØA ƒê∆Ø·ª¢C TRAO';
        }
        
        document.getElementById('endOverlay').style.display = 'none'; 
        document.getElementById('chest-screen').style.display = 'flex';
    }

    document.addEventListener('DOMContentLoaded', () => {
        listenForTeamUpdates(); 
        listenForSubmissions(); 
    });
        
</script>
</body>
</html>
